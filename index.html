<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pastel Cherry Music Player</title>
  <style>
    body {
      background-color: #ffe4e1;
      color: #4a2c2a;
      font-family: 'Press Start 2P', cursive;
      min-height: 100vh;
      margin: 0;
      image-rendering: pixelated;
      position: relative;
      overflow-x: hidden;
    }

    #visualizer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }

    .container {
      background-color: #fff0f5;
      padding: 20px;
      border: 4px solid #ffb6c1;
      box-shadow: 0 0 0 4px #4a2c2a, 8px 8px 0 0 #4a2c2a;
      max-width: 500px;
      width: 100%;
      text-align: center;
      position: relative;
      z-index: 1;
      margin: 20px auto;
    }

    .settings {
      text-align: left;
      margin-bottom: 10px;
    }

    .settings-button, .auth-button, .pomodoro-button {
      background: linear-gradient(135deg, #ffb6c1, #ffdde1);
      border: 2px solid #4a2c2a;
      padding: 8px;
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      color: #4a2c2a;
      cursor: pointer;
      margin-right: 5px;
      transition: transform 0.2s, filter 0.2s;
      position: relative;
      image-rendering: pixelated;
    }

    .settings-button:hover, .auth-button:hover, .pomodoro-button:hover {
      transform: scale(1.1);
      filter: drop-shadow(0 0 8px #d98695);
    }

    .settings-button:hover::after, .auth-button:hover::after, .pomodoro-button:hover::after {
      content: 'üçí';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 12px;
      opacity: 0;
      animation: fadeInCherry 0.3s forwards;
    }

    @keyframes fadeInCherry {
      to { opacity: 1; }
    }

    .settings-panel {
      display: none;
      background-color: #fff;
      border: 2px solid #4a2c2a;
      padding: 10px;
      margin-top: 10px;
      font-size: 10px;
    }

    .settings-panel.show {
      display: block;
    }

    .settings-panel label {
      display: flex;
      align-items: center;
      margin: 8px 0;
      color: #4a2c2a;
    }

    .settings-panel input[type="checkbox"] {
      margin-right: 8px;
      accent-color: #d98695;
    }

    .settings-panel input[type="range"] {
      -webkit-appearance: none;
      width: 100px;
      height: 6px;
      background: #f5c6cb;
      border: 1px solid #4a2c2a;
      border-radius: 6px;
      outline: none;
      cursor: pointer;
      image-rendering: pixelated;
    }

    .settings-panel input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #d98695;
      border: 2px solid #4a2c2a;
      border-radius: 0;
      cursor: pointer;
      transition: transform 0.2s;
      image-rendering: pixelated;
    }

    .settings-panel input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      filter: drop-shadow(0 0 8px #c76b7a);
    }

    .settings-panel input[type="range"]::-moz-range-track {
      background: #f5c6cb;
      border: 1px solid #4a2c2a;
      border-radius: 6px;
    }

    .settings-panel input[type="range"]::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: #d98695;
      border: 2px solid #4a2c2a;
      border-radius: 0;
      cursor: pointer;
      image-rendering: pixelated;
    }

    .settings-panel input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.2);
      filter: drop-shadow(0 0 8px #c76b7a);
    }

    .equalizer, .hifi, .ad-settings, .host-settings {
      margin: 10px 0;
    }

    .song-history {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 10px;
      text-align: left;
    }

    .song-history div {
      padding: 5px;
      display: flex;
      align-items: center;
    }

    .song-history div::before {
      content: 'üçíüçí';
      margin-right: 8px;
      font-size: 12px;
    }

    .clear-history {
      background: #ff4040;
      border: 2px solid #4a2c2a;
      padding: 6px;
      font-family: 'Press Start 2P', cursive;
      font-size: 8px;
      color: #fff0f5;
      cursor: pointer;
      margin-top: 5px;
      image-rendering: pixelated;
    }

    .clear-history:hover::after {
      content: 'üçí';
      margin-left: 5px;
      font-size: 10px;
    }

    input[type="text"], input[type="password"], input[type="email"] {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      border: 2px solid #4a2c2a;
      background-color: #fff;
      font-family: 'Press Start 2P', cursive;
      font-size: 12px;
      color: #4a2c2a;
      image-rendering: pixelated;
    }

    .media-controls {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      justify-items: center;
      margin: 20px 0;
      padding: 10px;
      background: linear-gradient(180deg, #f5c6cb, #ffe4e1);
      border: 4px solid #4a2c2a;
      box-shadow: 0 0 0 2px #ffb6c1, 6px 6px 0 #4a2c2a;
      border-radius: 0;
      image-rendering: pixelated;
    }

    .media-button {
      background: linear-gradient(45deg, #d98695, #ffdde1);
      border: 3px solid #4a2c2a;
      border-radius: 0;
      width: 60px;
      height: 60px;
      font-family: 'Press Start 2P', cursive;
      font-size: 14px;
      color: #4a2c2a;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 4px 4px 0 #4a2c2a;
      transition: transform 0.1s, box-shadow 0.1s;
      position: relative;
      image-rendering: pixelated;
    }

    .media-button.seek {
      background: linear-gradient(45deg, #c76b7a, #ffdde1);
    }

    .media-button:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #4a2c2a;
      filter: brightness(1.1);
    }

    .media-button:active {
      transform: translate(4px, 4px);
      box-shadow: 0 0 0 #4a2c2a;
      animation: pixelPress 0.2s;
    }

    .media-button:hover::after {
      content: 'üçí';
      position: absolute;
      top: -6px;
      right: -6px;
      font-size: 10px;
      animation: jitterCherry 0.5s infinite;
    }

    @keyframes pixelPress {
      0% { transform: translate(2px, 2px); }
      50% { transform: translate(4px, 4px); }
      100% { transform: translate(2px, 2px); }
    }

    @keyframes jitterCherry {
      0% { transform: translate(0, 0); }
      25% { transform: translate(1px, -1px); }
      50% { transform: translate(-1px, 1px); }
      75% { transform: translate(1px, 1px); }
      100% { transform: translate(0, 0); }
    }

    .media-button.host-disabled {
      opacity: 0.5;
      box-shadow: 4px 4px 0 #4a2c2a;
    }

    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(74, 44, 42, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-content {
      background-color: #fff0f5;
      padding: 20px;
      border: 4px solid #ffb6c1;
      box-shadow: 0 0 0 4px #4a2c2a, 8px 8px 0 0 #4a2c2a;
      max-width: 400px;
      width: 90%;
      text-align: center;
      image-rendering: pixelated;
    }

    .popup-content h2 {
      font-size: 16px;
      margin-bottom: 15px;
    }

    .popup-content h2::before, .popup-content h2::after {
      content: 'üçíüçí';
      margin: 0 5px;
    }

    .close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
      color: #4a2c2a;
      image-rendering: pixelated;
    }

    #pomodoro-timer {
      font-size: 20px;
      margin: 15px 0;
      color: #d98695;
    }

    #pomodoro-text {
      font-size: 12px;
      margin-bottom: 10px;
    }

    #host-bubble {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 8px;
      background-color: #fff0f5;
      border: 2px solid #ffb6c1;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 0 0 2px #4a2c2a;
      max-width: 280px;
      font-size: 11px;
      z-index: 1000;
      animation: fadeInOut 5s ease-in-out;
      display: flex;
      align-items: center;
      image-rendering: pixelated;
    }

    #host-bubble::before {
      content: 'üçíüçí';
      font-size: 16px;
      margin-right: 8px;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(10px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(10px); }
    }

    #playlist, #queue {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 10px;
      text-align: left;
    }

    #playlist div, #queue div {
      padding: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    #queue div {
      cursor: default;
    }

    #playlist div::before, #queue div::before {
      content: 'üçíüçí';
      margin-right: 8px;
      font-size: 12px;
    }

    #playlist div:hover {
      background-color: #f5c6cb;
    }

    #current-track {
      margin: 15px 0;
      font-size: 12px;
      color: #4a2c2a;
    }

    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }

      input[type="text"], input[type="password"], input[type="email"] {
        font-size: 10px;
      }

      .media-controls {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
        padding: 8px;
      }

      .media-button {
        width: 48px;
        height: 48px;
        font-size: 12px;
        box-shadow: 3px 3px 0 #4a2c2a;
      }

      .media-button:hover {
        transform: translate(1px, 1px);
        box-shadow: 1px 1px 0 #4a2c2a;
      }

      .media-button:active {
        transform: translate(2px, 2px);
        box-shadow: 0 0 0 #4a2c2a;
      }

      .settings-button, .auth-button, .pomodoro-button {
        font-size: 8px;
        padding: 6px;
      }

      #current-track {
        font-size: 10px;
      }

      .popup-content {
        padding: 15px;
      }

      #pomodoro-timer {
        font-size: 18px;
      }

      #host-bubble {
        max-width: 220px;
        font-size: 9px;
        bottom: 10px;
        right: 10px;
        padding: 8px;
      }

      #host-bubble::before {
        font-size: 12px;
      }

      .song-history, #playlist, #queue {
        font-size: 8px;
      }

      .song-history div::before, #playlist div::before, #queue div::before {
        font-size: 10px;
      }

      .settings-panel {
        font-size: 8px;
      }

      .settings-panel input[type="checkbox"], .settings-panel input[type="range"] {
        transform: scale(0.8);
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
  <canvas id="visualizer"></canvas>
  <div class="container">
    <div class="settings">
      <button class="settings-button" onclick="toggleSettings()">Settings</button>
      <button class="auth-button" onclick="toggleAuth()">Auth üçí</button>
      <button class="pomodoro-button" onclick="showPopup('pomodoro')">Pomodoro üçí</button>
      <div id="settings-panel" class="settings-panel">
        <div class="equalizer">
          <label>Low (Bass): <input type="range" id="eq-low" min="0" max="100" value="50"></label><br>
          <label>Mid: <input type="range" id="eq-mid" min="0" max="100" value="50"></label><br>
          <label>High (Treble): <input type="range" id="eq-high-res" min="0" max="100" value="50"></label>
        </div>
        <div class="hifi">
          <label><input type="checkbox" id="hifi-mode"> Hi-Fi Mode</label>
        </div>
        <div class="ad-settings">
          <label><input type="checkbox" id="mute-settings"> Mute During Ads</label>
        </div>
        <div class="host-settings">
          <label>AI Host Volume: <input type="range" id="host-volume" min="0" max="100" value="80"></label>
        </div>
      </div>
    </div>
    <input type="text" id="youtube-url" placeholder="Enter YouTube URL">
    <div class="media-controls">
      <button class="media-button" onclick="loadMusic()" title="Load"><span>‚ñ∂</span></button>
      <button class="media-button" onclick="playPause()" id="play-pause-button" title="Play/Pause"><span>‚ñ∂</span></button>
      <button class="media-button" onclick="nextTrack()" title="Next"><span>‚è≠</span></button>
      <button class="media-button" onclick="previousTrack()" title="Previous"><span>‚èÆ</span></button>
      <button class="media-button" onclick="stopTrack()" title="Stop"><span>‚èπ</span></button>
      <button class="media-button" onclick="volumeUp()" title="Volume Up"><span>üîä+</span></button>
      <button class="media-button" onclick="volumeDown()" title="Volume Down"><span>üîä-</span></button>
      <button class="media-button" onclick="toggleMute()" id="mute-button" title="Mute/Unmute"><span>üîä</span></button>
      <button class="media-button seek" onclick="seekForward()" title="Seek Forward 10s"><span>‚è©</span></button>
      <button class="media-button seek" onclick="seekBackward()" title="Seek Backward 10s"><span>‚è™</span></button>
      <button class="media-button" onclick="toggleShuffle()" id="shuffle-button" title="Shuffle"><span>üî∂</span></button>
      <button class="media-button" onclick="toggleRepeat()" id="repeat-button" title="Repeat"><span>üîÅ</span></button>
      <button class="media-button" onclick="toggleHost()" id="host-button" title="AI Host"><span>üçí</span></button>
    </div>
    <div class="song-history">
      <strong>Song History:</strong>
      <div id="history-list"></div>
      <button class="clear-history" onclick="clearHistory()">Clear History</button>
    </div>
    <div id="player-container"></div>
    <div id="current-track">No track playing</div>
    <div id="playlist"></div>
    <div id="queue"></div>
  </div>

  <div id="auth-popup" class="popup">
    <div class="popup-content">
      <button class="close-button" onclick="closePopup()">X</button>
      <h2 id="auth-title">Login</h2>
      <input type="text" id="auth-username" placeholder="Username">
      <input type="email" id="auth-email" placeholder="Email" style="display: none;">
      <input type="password" id="auth-password" placeholder="Password">
      <input type="password" id="auth-confirm-password" maxlength="100" placeholder="Confirm Password" style="display: none;">
      <button onclick="handleAuth()">Submit</button>
      <button onclick="switchAuthMode()">Switch to <span id="switch-text">Sign Up</span></button>
    </div>
  </div>

  <div id="pomodoro-popup" class="popup">
    <div class="popup-content">
      <button class="close-button" onclick="closePopup()">X</button>
      <h2>Pomodoro Timer</h2>
      <div id="pomodoro-text">Work Session üçíüçí</div>
      <div id="pomodoro-timer">25:00</div>
      <button onclick="startPomodoro()">Start</button>
      <button onclick="resetPomodoro()">Reset</button>
    </div>
  </div>

  <div id="host-bubble"></div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let player = null;
    let playlist = [];
    let originalPlaylist = [];
    let currentTrackIndex = -1;
    let isPlaying = false;
    let duration = 0;
    let isMuted = false;
    let isHostEnabled = true;
    let isLoginMode = true;
    let isShuffle = false;
    let isRepeat = false;
    let muteDuringAds = JSON.parse(localStorage.getItem('muteDuringAds')) || false;
    let hostVolume = JSON.parse(localStorage.getItem('hostVolume')) || 80;
    let previousVolume = 50;
    let isAdMuted = false;
    let adSpoken = false;
    const users = {};
    let songHistory = JSON.parse(localStorage.getItem('songHistory')) || [];

    // Visualizer setup
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    let cherries = [];

    function initVisualizer() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      cherries = [];
      for (let i = 0; i < 30; i++) {
        cherries.push({
          x: Math.random() * canvas.width,
          y: -20,
          speed: Math.random() * 3 + 2,
          size: Math.random() * 12 + 12,
          rotation: 0
        });
      }
    }

    function drawVisualizer() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (isPlaying) {
        cherries.forEach(cherry => {
          cherry.y += cherry.speed;
          if (cherry.y > canvas.height) cherry.y = -20;
          cherry.rotation = Math.sin(Date.now() * 0.002 + cherry.x) * 10;
          ctx.save();
          ctx.translate(cherry.x + cherry.size / 2, cherry.y + cherry.size / 2);
          ctx.rotate((cherry.rotation * Math.PI) / 180);
          ctx.font = `${cherry.size}px 'Press Start 2P'`;
          ctx.fillStyle = '#ff4040';
          ctx.fillText('üçí', -cherry.size / 2, -cherry.size / 2);
          ctx.restore();
        });
      }
      requestAnimationFrame(drawVisualizer);
    }

    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      cherries.forEach(cherry => {
        cherry.x = Math.random() * canvas.width;
        cherry.y = Math.random() * canvas.height;
      });
    });

    // Song history
    function saveSongHistory(videoId) {
      const title = `Track ${currentTrackIndex + 1}`;
      const timestamp = new Date().toLocaleString();
      songHistory.push({ videoId, title, timestamp });
      localStorage.setItem('songHistory', JSON.stringify(songHistory));
      updateHistoryDisplay();
    }

    function updateHistoryDisplay() {
      const historyDiv = document.getElementById('history-list');
      if (!historyDiv) return;
      historyDiv.textContent = '';
      songHistory.forEach(({ title, timestamp }) => {
        const trackDiv = document.createElement('div');
        trackDiv.textContent = `${title} - ${timestamp}`;
        historyDiv.appendChild(trackDiv);
      });
    }

    function clearHistory() {
      songHistory = [];
      localStorage.removeItem('songHistory');
      updateHistoryDisplay();
    }

    // AI Host setup
    function hostSpeak() {
      if (!isHostEnabled) return;
      const trackNum = currentTrackIndex + 1;
      const totalTracks = playlist.length;
      let message = '';
      const isFirstTrack = trackNum === 1;
      const isLastTrack = trackNum === totalTracks;
      const isSingleTrack = totalTracks === 1;

      const basePhrases = [
        `Hey there, cherry fans! Ready for a sweet tune? üçíüçí`,
        `Let's keep the good vibes rolling! üçíüçí`,
        `Time for another juicy track! üçíüçí`,
        `Hope you're loving this cherry-picked song! üçíüçí`
      ];
      const firstTrackPhrases = [
        `Kicking off with a fresh track! Let's get started! üçíüçí`,
        `Welcome to Cherry FM! Here's our first song! üçíüçí`
      ];
      const lastTrackPhrases = [
        `Last track of the set! Make it count! üçíüçí`,
        `Wrapping up with this gem! üçíüçí`
      ];
      const singleTrackPhrases = [
        `Just one cherry-picked song for you today! üçíüçí`,
        `This track's all you need right now! üçíüçí`
      ];

      if (isSingleTrack) {
        message = singleTrackPhrases[Math.floor(Math.random() * singleTrackPhrases.length)];
      } else if (isFirstTrack) {
        message = firstTrackPhrases[Math.floor(Math.random() * firstTrackPhrases.length)];
      } else if (isLastTrack) {
        message = lastTrackPhrases[Math.floor(Math.random() * lastTrackPhrases.length)];
      } else {
        message = basePhrases[Math.floor(Math.random() * basePhrases.length)];
      }

      message = `Track ${trackNum}/${totalTracks}: ${message}`;
      showHostBubble(message);
    }

    function showHostBubble(message) {
      const bubble = document.getElementById('host-bubble');
      if (!bubble) return;
      bubble.textContent = message;
      bubble.style.display = 'flex';
      if (isHostEnabled && !isMuted && hostVolume > 0) {
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.rate = 1.0;
        utterance.pitch = 1.2;
        utterance.volume = hostVolume / 100;
        const voices = speechSynthesis.getVoices();
        const friendlyVoice = voices.find(voice => voice.name.includes('Google') || voice.name.includes('Microsoft') || voice.default) || voices[0];
        utterance.voice = friendlyVoice;
        speechSynthesis.speak(utterance);
      }
      setTimeout(() => {
        bubble.style.display = 'none';
      }, 5000);
    }

    // Ad detection and mute
    const adPhrases = [
      `üçíüçí Hang tight, folks! This quick ad break is powering our cherry vibes!`,
      `üçíüçí Just a short ad, then we‚Äôre back to the sweetest tunes!`,
      `üçíüçí Keep those cherry vibes strong, this ad‚Äôs almost done!`,
      `üçíüçí Quick ad break, but we‚Äôre keeping the party going!`,
      `üçíüçí Stay sweet, this ad‚Äôs just a quick pit stop!`,
      `üçíüçí Ad time, but your next track is ready to roll!`,
      `üçíüçí Grab a cherry snack, we‚Äôll be back after this ad!`,
      `üçíüçí This ad‚Äôs fueling Cherry FM, back soon!`,
      `üçíüçí Short ad break, let‚Äôs keep the music flowing!`,
      `üçíüçí Ad‚Äôs on, but we‚Äôre prepping your next jam!`,
      `üçíüçí Quick pause for an ad, then it‚Äôs cherry time again!`
    ];

    function monitorAds() {
      if (!player) return;
      const iframe = document.querySelector('#player-container iframe');
      if (!iframe || !iframe.contentDocument) return;

      try {
        const adElement = iframe.contentDocument.querySelector('.ad-showing');
        if (adElement) {
          if (muteDuringAds && !isAdMuted) {
            previousVolume = player.getVolume();
            player.mute();
            isAdMuted = true;
          }
          if (isHostEnabled && !adSpoken) {
            const message = adPhrases[Math.floor(Math.random() * adPhrases.length)];
            showHostBubble(message);
            adSpoken = true;
          }
        } else if (isAdMuted) {
          player.setVolume(previousVolume);
          isAdMuted = false;
          if (isHostEnabled) {
            showHostBubble('üçíüçí Back to your cherry-picked tunes!');
          }
          adSpoken = false;
        } else {
          adSpoken = false;
        }
      } catch (e) {
        console.warn('Ad detection failed:', e);
      }
    }

    setInterval(monitorAds, 500);

    // Authentication setup
    function toggleAuth() {
      showPopup('auth');
    }

    function switchAuthMode() {
      isLoginMode = !isLoginMode;
      updateAuthPopup();
    }

    function updateAuthPopup() {
      const title = document.getElementById('auth-title');
      const emailInput = document.getElementById('auth-email');
      const confirmPasswordInput = document.getElementById('auth-confirm-password');
      const switchText = document.getElementById('switch-text');
      if (!title || !emailInput || !confirmPasswordInput || !switchText) return;

      title.textContent = isLoginMode ? 'Login' : 'Sign Up';
      emailInput.style.display = isLoginMode ? 'none' : 'block';
      confirmPasswordInput.style.display = isLoginMode ? 'none' : 'block';
      switchText.textContent = isLoginMode ? 'Sign Up' : 'Login';

      document.getElementById('auth-username').value = '';
      document.getElementById('auth-email').value = '';
      document.getElementById('auth-password').value = '';
      document.getElementById('auth-confirm-password').value = '';
    }

    function handleAuth() {
      const username = document.getElementById('auth-username').value.trim();
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value;
      const confirmPassword = document.getElementById('auth-confirm-password').value;

      if (isLoginMode) {
        if (!username || !password) {
          alert('Please fill in all fields! üçíüçí');
          return;
        }
        if (users[username] && users[username].password === password) {
          alert('Login successful! üçíüçí');
          console.log(`Login: Username=${encodeURIComponent(username)}, Password=${encodeURIComponent(password)}`);
          closePopup();
        } else {
          alert('Invalid username or password! üçíüçí');
          console.log(`Failed login: Username=${encodeURIComponent(username)}`);
        }
      } else {
        if (!username || !email || !password || !confirmPassword) {
          alert('Please fill in all fields! üçíüçí');
          return;
        }
        if (users[username]) {
          alert('Username already exists! üçíüçí');
          return;
        }
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          alert('Invalid email format! üçíüçí');
          return;
        }
        if (password.length < 6) {
          alert('Password must be at least 6 characters! üçíüçí');
          return;
        }
        if (password !== confirmPassword) {
          alert('Passwords do not match! üçíüçí');
          return;
        }
        users[username] = { email, password };
        alert('Signed up successfully! üçíüçí');
        console.log(`Sign Up: Username=${encodeURIComponent(username)}, Email=${encodeURIComponent(email)}, Password=${encodeURIComponent(password)}`);
        isLoginMode = true;
        updateAuthPopup();
        closePopup();
      }
    }

    // Queue setup
    function updateQueueDisplay() {
      const queueDiv = document.getElementById('queue');
      if (!queueDiv) return;
      queueDiv.textContent = 'Queue:';
      if (playlist.length === 0) return;

      for (let i = 0; i < Math.min(5, playlist.length - currentTrackIndex - 1); i++) {
        const index = currentTrackIndex + i + 1;
        if (index < playlist.length) {
          const trackDiv = document.createElement('div');
          trackDiv.textContent = `Track ${index + 1}/${playlist.length}`;
          queueDiv.appendChild(trackDiv);
        }
      }
    }

    // Pomodoro setup
    let pomodoroInterval = null;
    let isWorkSession = true;
    let timeLeft = 25 * 60;

    function updatePomodoroDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      const timerDiv = document.getElementById('pomodoro-timer');
      const textDiv = document.getElementById('pomodoro-text');
      if (!timerDiv || !textDiv) return;
      timerDiv.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
      textDiv.textContent = isWorkSession ? 'Work Session üçíüçí' : 'Break Time üçíüçí';
    }

    function startPomodoro() {
      if (pomodoroInterval) return;
      pomodoroInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          isWorkSession = !isWorkSession;
          timeLeft = isWorkSession ? 25 * 60 : 5 * 60;
          alert(isWorkSession ? 'Work session started! üçíüçí' : 'Break time! üçíüçí');
        }
        updatePomodoroDisplay();
      }, 1000);
    }

    function resetPomodoro() {
      clearInterval(pomodoroInterval);
      pomodoroInterval = null;
      isWorkSession = true;
      timeLeft = 25 * 60;
      updatePomodoroDisplay();
    }

    function showPopup(type) {
      const authPopup = document.getElementById('auth-popup');
      const pomodoroPopup = document.getElementById('pomodoro-popup');
      if (!authPopup || !pomodoroPopup) return;
      authPopup.style.display = type === 'auth' ? 'flex' : 'none';
      pomodoroPopup.style.display = type === 'pomodoro' ? 'flex' : 'none';
      if (type === 'auth') updateAuthPopup();
      if (type === 'pomodoro') updatePomodoroDisplay();
    }

    function closePopup() {
      const authPopup = document.getElementById('auth-popup');
      const pomodoroPopup = document.getElementById('pomodoro-popup');
      if (!authPopup || !pomodoroPopup) return;
      authPopup.style.display = 'none';
      pomodoroPopup.style.display = 'none';
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player-container', {
        height: '0',
        width: '0',
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerReady(event) {
      applyEqualizer();
      applyHiFi();
      player.setVolume(50);
      initVisualizer();
      drawVisualizer();
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        if (isRepeat) {
          loadTrack(playlist[currentTrackIndex]);
        } else {
          nextTrack();
        }
      } else if (event.data === YT.PlayerState.PLAYING) {
        duration = player.getDuration();
        isPlaying = true;
        document.getElementById('current-track').textContent = `Playing: Track ${currentTrackIndex + 1}/${playlist.length} üçíüçí`;
        document.getElementById('play-pause-button').querySelector('span').textContent = '‚è∏';
        hostSpeak();
        updateQueueDisplay();
      } else if (event.data === YT.PlayerState.PAUSED) {
        isPlaying = false;
        document.getElementById('play-pause-button').querySelector('span').textContent = '‚ñ∂';
      }
    }

    function formatTime(timeInSeconds) {
      const minutes = Math.floor(timeInSeconds / 60);
      const seconds = Math.floor(timeInSeconds % 60);
      return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    function extractVideoId(url) {
      const regex = /(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    function extractPlaylistId(url) {
      const regex = /list=([a-zA-Z0-9_-]+)/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    async function fetchPlaylistVideos(playlistId) {
      // Stub: Returns single video ID
      const videoIds = [extractVideoId(document.getElementById('youtube-url').value) || 'dQw4w9WgXcQ'];
      return videoIds;
    }

    async function loadMusic() {
      const url = document.getElementById('youtube-url').value;
      const videoId = extractVideoId(url);
      const playlistId = extractPlaylistId(url);

      if (videoId) {
        playlist.push(videoId);
        originalPlaylist.push(videoId);
        if (!isPlaying || playlist.length === 1) {
          currentTrackIndex = playlist.length - 1;
          loadTrack(videoId);
        }
        updatePlaylistDisplay();
        updateQueueDisplay();
        document.getElementById('youtube-url').value = '';
      } else if (playlistId) {
        const videoIds = await fetchPlaylistVideos(playlistId);
        playlist.push(...videoIds);
        originalPlaylist.push(...videoIds);
        if (!isPlaying) {
          currentTrackIndex = playlist.length - videoIds.length;
          loadTrack(playlist[currentTrackIndex]);
        }
        updatePlaylistDisplay();
        updateQueueDisplay();
        document.getElementById('youtube-url').value = '';
      } else {
        alert('Invalid YouTube URL! üçíüçí');
      }
    }

    function loadTrack(videoId) {
      if (!player) return;
      player.loadVideoById({
        videoId: videoId,
        suggestedQuality: document.getElementById('hifi-mode').checked ? 'highres' : 'default'
      });
      document.getElementById('current-track').textContent = `Playing: Track ${currentTrackIndex + 1}/${playlist.length} üçíüçí`;
      isPlaying = true;
      saveSongHistory(videoId);
      updateQueueDisplay();
    }

    function playPause() {
      if (!player) return;
      if (isPlaying) {
        player.pauseVideo();
        isPlaying = false;
        document.getElementById('play-pause-button').querySelector('span').textContent = '‚ñ∂';
      } else {
        player.playVideo();
        isPlaying = true;
        document.getElementById('play-pause-button').querySelector('span').textContent = '‚è∏';
      }
    }

    function nextTrack() {
      if (playlist.length === 0) return;
      currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
      loadTrack(playlist[currentTrackIndex]);
    }

    function previousTrack() {
      if (playlist.length === 0) return;
      currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
      loadTrack(playlist[currentTrackIndex]);
    }

    function stopTrack() {
      if (!player) return;
      player.stopVideo();
      isPlaying = false;
      document.getElementById('play-pause-button').querySelector('span').textContent = '‚ñ∂';
      document.getElementById('current-track').textContent = `Stopped: Track ${currentTrackIndex + 1}/${playlist.length} üçíüçí`;
    }

    function volumeUp() {
      if (!player) return;
      let volume = player.getVolume();
      volume = Math.min(100, volume + 5);
      player.setVolume(volume);
      previousVolume = volume;
      if (isMuted && volume > 0) {
        isMuted = false;
        document.getElementById('mute-button').querySelector('span').textContent = 'üîä';
      }
    }

    function volumeDown() {
      if (!player) return;
      let volume = player.getVolume();
      volume = Math.max(0, volume - 5);
      player.setVolume(volume);
      previousVolume = volume;
      if (volume === 0) {
        isMuted = true;
        document.getElementById('mute-button').querySelector('span').textContent = 'üîá';
      } else {
        isMuted = false;
        document.getElementById('mute-button').querySelector('span').textContent = 'üîä';
      }
    }

    function toggleMute() {
      if (!player) return;
      if (isMuted) {
        player.setVolume(previousVolume);
        isMuted = false;
        document.getElementById('mute-button').querySelector('span').textContent = 'üîä';
      } else {
        previousVolume = player.getVolume();
        player.setVolume(0);
        isMuted = true;
        document.getElementById('mute-button').querySelector('span').textContent = 'üîá';
      }
    }

    function seekForward() {
      if (!player || !duration) return;
      const currentTime = player.getCurrentTime();
      const newTime = Math.min(currentTime + 10, duration);
      player.seekTo(newTime, true);
    }

    function seekBackward() {
      if (!player || !duration) return;
      const currentTime = player.getCurrentTime();
      const newTime = Math.max(currentTime - 10, 0);
      player.seekTo(newTime, true);
    }

    function toggleShuffle() {
      isShuffle = !isShuffle;
      document.getElementById('shuffle-button').style.opacity = isShuffle ? '1' : '0.5';
      if (isShuffle) {
        originalPlaylist = [...playlist];
        const currentVideoId = playlist[currentTrackIndex];
        for (let i = playlist.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
        }
        currentTrackIndex = playlist.indexOf(currentVideoId);
      } else {
        playlist = [...originalPlaylist];
        const currentVideoId = playlist[currentTrackIndex];
        currentTrackIndex = originalPlaylist.indexOf(currentVideoId);
      }
      updatePlaylistDisplay();
      updateQueueDisplay();
    }

    function toggleRepeat() {
      isRepeat = !isRepeat;
      document.getElementById('repeat-button').style.opacity = isRepeat ? '1' : '0.5';
    }

    function toggleHost() {
      isHostEnabled = !isHostEnabled;
      document.getElementById('host-button').classList.toggle('host-disabled', !isHostEnabled);
      if (!isHostEnabled) {
        document.getElementById('host-bubble').style.display = 'none';
      }
    }

    function toggleSettings() {
      const panel = document.getElementById('settings-panel');
      if (!panel) return;
      panel.classList.toggle('show');
    }

    function applyEqualizer() {
      const low = parseInt(document.getElementById('eq-low').value);
      const mid = parseInt(document.getElementById('eq-mid').value);
      const high = parseInt(document.getElementById('eq-high-res').value);
      console.log(`Equalizer: Low=${low}, Mid=${mid}, High=${high}`);
      // Note: Actual equalizer requires Web Audio API, logging for now
    }

    function applyHiFi() {
      if (!player || !isPlaying) return;
      const hifi = document.getElementById('hifi-mode').checked;
      player.setPlaybackQuality(hifi ? 'highres' : 'default');
    }

    function updatePlaylistDisplay() {
      const playlistDiv = document.getElementById('playlist');
      if (!playlistDiv) return;
      playlistDiv.textContent = '';
      if (playlist.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.textContent = 'No tracks in playlist';
        playlistDiv.appendChild(emptyDiv);
        return;
      }
      playlist.forEach((videoId, index) => {
        const trackDiv = document.createElement('div');
        trackDiv.textContent = `Track ${index + 1}/${playlist.length}`;
        trackDiv.onclick = () => {
          currentTrackIndex = index;
          loadTrack(videoId);
        };
        playlistDiv.appendChild(trackDiv);
      });
    }

    // DOM-dependent initialization
    document.addEventListener('DOMContentLoaded', () => {
      updateHistoryDisplay();
      updatePlaylistDisplay();
      updateQueueDisplay();
      const muteSettings = document.getElementById('mute-settings');
      const hostVolumeSlider = document.getElementById('host-volume');
      const eqLow = document.getElementById('eq-low');
      const eqMid = document.getElementById('eq-mid');
      const eqHigh = document.getElementById('eq-high-res');
      const hifiMode = document.getElementById('hifi-mode');

      if (muteSettings) {
        muteSettings.checked = muteDuringAds;
        muteSettings.addEventListener('change', () => {
          muteDuringAds = muteSettings.checked;
          localStorage.setItem('muteDuringAds', JSON.stringify(muteDuringAds));
          if (!muteDuringAds && isAdMuted) {
            player.setVolume(previousVolume);
            isAdMuted = false;
            if (isHostEnabled) {
              showHostBubble('üçíüçí Back to your cherry-picked tunes!');
            }
          }
        });
      }

      if (hostVolumeSlider) {
        hostVolumeSlider.value = hostVolume;
        hostVolumeSlider.addEventListener('input', () => {
          hostVolume = parseInt(hostVolumeSlider.value);
          localStorage.setItem('hostVolume', JSON.stringify(hostVolume));
        });
      }

      if (eqLow) eqLow.addEventListener('input', applyEqualizer);
      if (eqMid) eqMid.addEventListener('input', applyEqualizer);
      if (eqHigh) eqHigh.addEventListener('input', applyEqualizer);
      if (hifiMode) hifiMode.addEventListener('change', applyHiFi);
    });
  </script>
</body>
</html>