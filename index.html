<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retro YouTube Music Player</title>
  <link href="./src/output.css" rel="stylesheet">
  <script src="https://www.youtube.com/iframe_api"></script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #f8c3c3;
      font-family: 'Press Start 2P', monospace;
      image-rendering: pixelated;
      margin: 0;
      padding: 15px;
    }
    .container {
      background-color: #d89393;
      border: 4px solid #c94b4b;
      border-radius: 16px;
      padding: 15px;
      max-width: 500px;
      margin: 0 auto;
      box-shadow: 4px 4px 0 #2d1a1a;
      position: relative;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .retro-button {
      background-color: #d89393;
      border: 2px solid #c94b4b;
      color: #2d1a1a;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }
    .retro-button::before {
      content: '🍒';
      position: absolute;
      left: -10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.4;
    }
    .retro-button::after {
      content: '🌸';
      position: absolute;
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.4;
    }
    .retro-button:hover {
      background-color: #e6b8b8;
    }
    .input-section {
      text-align: center;
      margin-bottom: 15px;
    }
    input[type="text"], input[type="email"], input[type="password"] {
      background-color: #f8c3c3;
      border: 2px solid #c94b4b;
      border-radius: 8px;
      padding: 8px;
      font-size: 11px;
      width: 70%;
      margin-right: 8px;
    }
    .media-controls {
      text-align: center;
      margin-bottom: 15px;
    }
    .media-controls .buttons {
      margin-bottom: 8px;
    }
    .media-controls .seek-bar {
      width: 100%;
      margin-bottom: 8px;
    }
    input[type="range"] {
      -webkit-appearance: none;
      background: #c94b4b;
      border-radius: 4px;
      height: 10px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #d89393;
      border: 2px solid #c94b4b;
      border-radius: 50%;
      cursor: pointer;
    }
    .queue-history {
      margin-bottom: 8px;
    }
    .queue-history h2 {
      font-size: 12px;
      margin-bottom: 8px;
      position: relative;
    }
    .queue-history h2::after {
      content: ' 🍒🌸';
      position: absolute;
      right: 0;
    }
    .queue-history ul {
      list-style: none;
      padding: 0;
      max-height: 100px;
      overflow-y: auto;
      font-size: 9px;
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #d89393;
      padding: 20px;
      border: 4px solid #c94b4b;
      border-radius: 16px;
      box-shadow: 4px 4px 0 #2d1a1a;
      z-index: 1000;
    }
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .playing {
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% { opacity: 0.6; }
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #c94b4b;
      transition: 0.4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: #d89393;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #e6b8b8;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    .radio-host-bubble {
      position: fixed;
      bottom: 100px;
      right: 10px;
      background-color: #e6b8b8;
      border: 2px solid #c94b4b;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 8px;
      max-width: 250px;
      text-align: left;
      box-shadow: 2px 2px 0 #2d1a1a;
      z-index: 1001;
      animation: fadeIn 1s;
    }
    .psychiatrist-bubble {
      position: fixed;
      bottom: 30px;
      right: 10px;
      background-color: #e6b8b8;
      border: 2px solid #c94b4b;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 8px;
      max-width: 250px;
      text-align: left;
      box-shadow: 2px 2px 0 #2d1a1a;
      z-index: 1001;
      animation: fadeIn 1s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top Bar -->
    <div class="top-bar">
      <button id="profileBtn" class="retro-button">Profile 🍒🌸</button>
      <button id="settingsBtn" class="retro-button">Settings 🍒🌸</button>
      <button id="pomodoroBtn" class="retro-button">Pomodoro 🍒🌸</button>
      <button id="loginSignupBtn" class="retro-button">Login 🍒🌸</button>
    </div>

    <!-- URL Input -->
    <div class="input-section">
      <input id="urlInput" type="text" placeholder="YouTube Playlist/Video 🍒🌸" class="retro-border">
      <button id="loadUrl" class="retro-button">Load 🍒🌸</button>
    </div>

    <!-- Player Controls -->
    <div id="player" class="hidden"></div>
    <div class="media-controls">
      <div id="currentSong" class="text-center mb-2 font-bold text-lg">No Track Loaded 🍒🌸</div>
      <div class="buttons">
        <button id="prevBtn" class="retro-button">Previous 🍒</button>
        <button id="playPauseBtn" class="retro-button">Play/Pause 🌸</button>
        <button id="nextBtn" class="retro-button">Next 🍒</button>
      </div>
      <div class="seek-bar">
        <input type="range" id="seekSlider" min="0" max="100" value="0">
      </div>
    </div>

    <!-- Queue and History -->
    <div class="queue-history">
      <h2>Queue 🍒</h2>
      <ul id="queueList"></ul>
    </div>
    <div class="queue-history">
      <h2>History 🌸</h2>
      <ul id="historyList"></ul>
    </div>
  </div>

  <!-- DJ Sunny Radio Host Bubble (Bottom Right, Above Dr. Melody) -->
  <div id="radioHostBubble" class="radio-host-bubble hidden">☀️ Hey there, sunshine squad! This is DJ Sunny, dropping the hottest tunes your way! Let’s light up the airwaves! It’s 11:39 AM WITA on a Tuesday—perfect time for some music! What’s your vibe today? 🍒🌸</div>

  <!-- Dr. Melody Psychiatrist Bubble (Bottom Right) -->
  <div id="psychiatristBubble" class="psychiatrist-bubble hidden">🧠 Hello, dear listener! I’m Dr. Melody, your musical therapist. Let’s explore how these tunes resonate with your soul! A Tuesday morning can be full of possibilities—how are you feeling right now? 🍒🌸</div>

  <!-- Popups -->
  <div id="authPopup" class="popup">
    <h2 id="authTitle" class="text-center font-bold mb-3 text-sm">Login 🍒🌸</h2>
    <button id="toggleAuth" class="retro-button w-full mb-3">Switch to Sign Up 🍒🌸</button>
    <input id="authEmail" type="email" placeholder="Email 🍒🌸" class="w-full mb-3">
    <input id="authPassword" type="password" placeholder="Password 🌸🍒" class="w-full mb-3">
    <button id="submitAuth" class="retro-button w-full mb-3">Login 🍒🌸</button>
    <button id="closeAuth" class="retro-button w-full">Close 🌸🍒</button>
  </div>
  <div id="profilePopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Profile 🍒🌸</h2>
    <p id="profileEmail" class="mb-3">User: Guest 🍒🌸</p>
    <button id="signOutBtn" class="retro-button w-full mb-3">Sign Out 🍒🌸</button>
    <button id="closeProfile" class="retro-button w-full">Close 🌸🍒</button>
  </div>
  <div id="settingsPopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Settings 🍒🌸</h2>
    <h3 class="font-bold mb-3">Audio Settings 🍒🌸</h3>
    <div class="flex items-center mb-3">
      <label class="text-xs mr-3">Mute YouTube Ads 🍒🌸</label>
      <label class="toggle-switch">
        <input type="checkbox" id="muteAdToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="flex items-center mb-3">
      <label class="text-xs mr-3">HiFi Mode 🌸🍒</label>
      <label class="toggle-switch">
        <input type="checkbox" id="hifiModeToggle">
        <span class="slider"></span>
      </label>
    </div>
    <h3 class="font-bold mb-3">Equalizer 🍒🌸</h3>
    <div class="flex space-x-3 mb-3">
      <div>
        <label class="text-xs">Bass 🍒🌸</label>
        <input type="range" id="bass" min="-12" max="12" value="0" class="w-full">
      </div>
      <div>
        <label class="text-xs">Mid 🌸🍒</label>
        <input type="range" id="mid" min="-12" max="12" value="0" class="w-full">
      </div>
      <div>
        <label class="text-xs">Treble 🍒🌸</label>
        <input type="range" id="treble" min="-12" max="12" value="0" class="w-full">
      </div>
    </div>
    <button id="closeSettings" class="retro-button w-full">Close 🌸🍒</button>
  </div>
  <div id="pomodoroPopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Pomodoro Timer 🍒🌸</h2>
    <div id="pomodoroTime" class="text-center mb-3 text-sm">25:00 🍒🌸</div>
    <div class="flex justify-center space-x-3 mb-3">
      <button id="pomodoroStart" class="retro-button">Start 🍒🌸</button>
      <button id="pomodoroReset" class="retro-button">Reset 🌸🍒</button>
    </div>
    <div class="flex flex-wrap gap-3">
      <label class="text-xs">Work (min): 🍒🌸</label>
      <input id="pomodoroWork" type="number" value="25" class="w-20 p-2">
      <label class="text-xs">Break (min): 🌸🍒</label>
      <input id="pomodoroBreak" type="number" value="5" class="w-20 p-2">
    </div>
    <button id="closePomodoro" class="retro-button mt-3 w-full">Close 🌸🍒</button>
  </div>
  <div id="popupOverlay" class="popup-overlay"></div>

  <script>
    let player;
    let playlist = [];
    let history = [];
    let currentIndex = -1;
    let isLooping = false;
    let isShuffling = false;
    let isLoginMode = true;
    let isAdMuted = true; // Enabled by default
    let isHifiMode = false;
    let isAdPlaying = false;
    let lastStateChangeTime = 0;
    let lastVideoId = null;
    let lastDuration = 0;
    let lastPlaybackQuality = '';
    let stateHistory = []; // Rolling window of last 3 states
    let userInitiatedPlayback = false; // Track user interaction
    let lastInterruptTime = 0;
    let interruptInterval = null;
    const AD_DURATION_THRESHOLD = 60; // Ads can be up to 60 seconds (e.g., skippable)
    const STATE_WINDOW_SIZE = 3; // Track last 3 states
    const TRANSITION_THRESHOLD = 5; // Seconds for frequent transitions
    const API_KEY = 'AIzaSyBitewTBcoYxggjLlqbMm1qWhFatR6kvP8';
    const adPatterns = {
      title: /(sponsored|ad|promo|advertisement)/i,
      channel: /(google ads|doubleclick|admob)/i
    };
    let videoMetadataCache = {}; // Cache metadata to avoid repeated API calls
    const radioHostBubble = document.getElementById('radioHostBubble');
    const psychiatristBubble = document.getElementById('psychiatristBubble');
    const loginSignupBtn = document.getElementById('loginSignupBtn');
    const profileEmailDisplay = document.getElementById('profileEmail');
    let messageToggleCounter = 0; // Counter to alternate between DJ Sunny and Dr. Melody

    // Text-to-Speech Setup
    const synth = window.speechSynthesis;
    let voices = [];

    function loadVoices() {
      voices = synth.getVoices();
    }

    // Load voices when available
    loadVoices();
    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = loadVoices;
    }

    function speakText(text, pitch, bubbleElement) {
      // Clean the text by removing emojis and special characters for better speech
      const cleanText = text.replace(/☀️|🧠|🍒|🌸/g, '').trim();
      if (cleanText === '') {
        // If no text to speak, hide the bubble after a fallback timeout
        setTimeout(() => bubbleElement.classList.add('hidden'), 6000);
        return;
      }

      const utterance = new SpeechSynthesisUtterance(cleanText);
      utterance.pitch = pitch; // Set pitch for different voices
      utterance.rate = 1.0; // Normal speed
      utterance.volume = 1.0; // Full volume

      // Try to select a voice (prefer English voice if available)
      const voice = voices.find(v => v.lang.includes('en')) || voices[0];
      if (voice) {
        utterance.voice = voice;
      } else {
        // If no voice available, hide the bubble after a fallback timeout
        setTimeout(() => bubbleElement.classList.add('hidden'), 6000);
        return;
      }

      // Hide the bubble when speech ends
      utterance.onend = () => {
        bubbleElement.classList.add('hidden');
      };

      // In case of an error (e.g., speech canceled), hide the bubble after a fallback timeout
      utterance.onerror = () => {
        setTimeout(() => bubbleElement.classList.add('hidden'), 6000);
      };

      synth.speak(utterance);
    }

    // Enhanced DJ Sunny Phrases (Smarter, Talkative, Interactive)
    const adDetectedPhrases = [
      `☀️ Whoa, sunshine squad! DJ Sunny’s spotting an ad—muting that cloud to keep our sunny beats shining! 🍒🌸`,
      `☀️ Ad alert, music rays! DJ Sunny’s on it—silencing that interruption for pure sunshine vibes! 🍒🌸`,
      `☀️ No ads in my sunny set! DJ Sunny mutes that commercial break—only bright tunes for you! 🍒🌸`,
      `☀️ Ad incoming, but don’t worry, fans! DJ Sunny’s muting it—keeping our airwaves sunny and smooth! 🍒🌸`
    ];

    const adEndedPhrases = [
      `☀️ The ad’s gone, sunshine crew! DJ Sunny unmutes—back to those radiant beats! 🍒🌸`,
      `☀️ Ad break over, rhythm rays! DJ Sunny cranks up the sunshine—let’s glow with the music! 🍒🌸`,
      `☀️ We’re ad-free again, tune travelers! DJ Sunny restores the sunny sound—full blast ahead! 🍒🌸`,
      `☀️ Ad’s out, vibes are in! DJ Sunny unmutes—let’s bask in these brilliant tracks! 🍒🌸`
    ];

    const midSongInterruptPhrases = [
      `☀️ Hold up, sunshine squad! DJ Sunny here with a quick interrupt—this track’s got such a funky beat, doesn’t it? Let’s keep grooving—any requests for the next song? 🍒🌸`,
      `☀️ Breaking in with some sunny vibes, folks! DJ Sunny’s loving this song’s chill lo-fi energy—perfect for a relaxed morning at 11:39 AM WITA! 🍒🌸`,
      `☀️ Hey there, music rays! DJ Sunny popping in—this artist dropped this banger in 2023, and it’s got over 5M views! 🍒🌸`,
      `☀️ Quick sunny interruption, crew! DJ Sunny’s digging this track’s upbeat tempo—feels like a solid 130 BPM! 🍒🌸`,
      `☀️ Sunshine alert, listeners! DJ Sunny here—this song’s got a classic pop vibe, and I’m obsessed! 🍒🌸`
    ];

    const loadPlaylistPhrases = [
      `☀️ Rise and shine, tune travelers! DJ Sunny’s loading your playlist with sunny flair—let’s heat up the airwaves! 🍒🌸`,
      `☀️ Playlist loaded, sunshine crew! DJ Sunny’s ready to rock this set—looks like we’ve got some indie vibes in here! 🍒🌸`,
      `☀️ Here we go, music rays! DJ Sunny’s got your playlist locked and loaded—perfect for a Tuesday morning at 11:39 AM WITA! 🍒🌸`,
      `☀️ Your playlist is live, sunny fans! DJ Sunny’s spinning these tracks with love—looks like a 10-song list! 🍒🌸`
    ];

    const loadVideoPhrases = [
      `☀️ Bright choice, sunshine fans! DJ Sunny’s spinning your video—get ready for a sunny soundwave! 🍒🌸`,
      `☀️ Single track loaded, music rays! DJ Sunny’s here to make it shine—this song’s a 4-minute banger! 🍒🌸`,
      `☀️ Video’s up, sunshine squad! DJ Sunny’s playing this gem—looks like a pop hit from 2022! 🍒🌸`,
      `☀️ Spinning your pick, sunny listeners! DJ Sunny’s got this track rolling—it’s got a solid 100 BPM! 🍒🌸`
    ];

    const playPhrases = [
      `☀️ Let’s light it up, sunshine lovers! DJ Sunny hits play—feel the sunny rhythm! 🍒🌸`,
      `☀️ Play button smashed, music rays! DJ Sunny’s bringing the heat—this song’s a classic rock anthem! 🍒🌸`,
      `☀️ We’re rolling, sunny crew! DJ Sunny hits play—this track’s got a dreamy synth vibe! 🍒🌸`,
      `☀️ Sunshine beats incoming, fans! DJ Sunny’s playing this gem—it’s a 3-minute pop bop! 🍒🌸`
    ];

    const pausePhrases = [
      `☀️ Taking a sunshine break, folks! DJ Sunny pauses the beats—enjoy the calm glow! 🍒🌸`,
      `☀️ Pause mode on, music rays! DJ Sunny’s giving you a breather—this track’s got a chill lo-fi vibe. 🍒🌸`,
      `☀️ Holding the sunny vibes, crew! DJ Sunny pauses the music—perfect time to reflect! 🍒🌸`,
      `☀️ Quick sunny break, listeners! DJ Sunny hits pause—let’s soak in the silence for a sec! 🍒🌸`
    ];

    const nextPhrases = [
      `☀️ Next stop, sunshine station! DJ Sunny’s cueing up the next track—keep the rays rolling! 🍒🌸`,
      `☀️ Moving along, music rays! DJ Sunny spins the next song—this track’s got a reggae vibe! 🍒🌸`,
      `☀️ Next track up, sunny fans! DJ Sunny’s keeping the party going—this song’s a 2024 release! 🍒🌸`,
      `☀️ Onward we go, sunshine crew! DJ Sunny plays the next tune—this one’s a 5-minute epic! 🍒🌸`
    ];

    const prevPhrases = [
      `☀️ Rewind those rays, listeners! DJ Sunny spins back to the previous sunny gem—relive the glow! 🍒🌸`,
      `☀️ Backtracking, music rays! DJ Sunny plays the last song again—this one’s a country classic! 🍒🌸`,
      `☀️ Let’s revisit, sunny crew! DJ Sunny spins the previous track—this song’s got a 90s pop feel! 🍒🌸`,
      `☀️ Rewinding the sunshine, fans! DJ Sunny’s bringing back the last song—this one’s a 3-minute bop! 🍒🌸`
    ];

    const queueSelectPhrases = [
      `☀️ Stellar pick, sunshine crew! DJ Sunny’s playing your queue choice—feel the heat! 🍒🌸`,
      `☀️ Queue selection on point, music rays! DJ Sunny spins your pick—this song’s a 2021 release! 🍒🌸`,
      `☀️ Loving your taste, sunny fans! DJ Sunny plays your queue choice—this track’s got a chill acoustic sound! 🍒🌸`,
      `☀️ Queue pick activated, sunshine squad! DJ Sunny’s spinning this gem—it’s a 4-minute indie track! 🍒🌸`
    ];

    const historySelectPhrases = [
      `☀️ Nostalgia alert, sunshine fans! DJ Sunny’s replaying a golden oldie from your history—pure radiance! 🍒🌸`,
      `☀️ History lesson time, music rays! DJ Sunny spins a past favorite—this song’s a 5-minute epic! 🍒🌸`,
      `☀️ Rewind to the classics, sunny crew! DJ Sunny plays this history pick—it’s got a rock edge! 🍒🌸`,
      `☀️ Back in time, sunshine squad! DJ Sunny’s replaying this history gem—it’s a 3-minute pop hit! 🍒🌸`
    ];

    // Enhanced Dr. Melody Phrases (Smarter, Talkative, Interactive)
    const adDetectedPhrasesPsych = [
      `🧠 Oh dear, an ad has surfaced! Dr. Melody here, silencing it to protect your musical sanctuary—let’s keep your emotions flowing with the melody! 🍒🌸`,
      `🧠 I sense an ad interrupting your vibe! Dr. Melody is muting it, ensuring your inner harmony remains undisturbed—let the music heal! 🍒🌸`,
      `🧠 An ad, how intrusive! Dr. Melody mutes it for you—let’s maintain the therapeutic flow of these tunes for your soul! 🍒🌸`,
      `🧠 Not to worry, an ad has appeared, but Dr. Melody is here to mute it—your emotional journey through music remains uninterrupted! 🍒🌸`
    ];

    const adEndedPhrasesPsych = [
      `🧠 The ad has passed, dear listener! Dr. Melody unmutes the music—let’s return to the sounds that soothe your soul! 🍒🌸`,
      `🧠 That ad is behind us now! Dr. Melody restores the melody—how does it feel to reconnect with your musical essence? 🍒🌸`,
      `🧠 Ad-free once more! Dr. Melody brings back the music—let these notes continue to nurture your inner peace! 🍒🌸`,
      `🧠 The interruption is over! Dr. Melody unmutes—immerse yourself in the healing power of your playlist! 🍒🌸`
    ];

    const loadPlaylistPhrasesPsych = [
      `🧠 A playlist, how wonderful! Dr. Melody senses this selection might reflect your mood—let’s see how it resonates with your inner self! 🍒🌸`,
      `🧠 Playlist loaded, dear listener! Dr. Melody notices a mix of genres here—perhaps a sign of your diverse emotions today! 🍒🌸`,
      `🧠 Your playlist is ready, I see! Dr. Melody feels the energy of these tracks—perfect for a Tuesday morning! 🍒🌸`,
      `🧠 A thoughtful playlist choice! Dr. Melody senses this could be a journey of joy and reflection—let’s explore it together! 🍒🌸`
    ];

    const loadVideoPhrasesPsych = [
      `🧠 A single track, I see! Dr. Melody wonders what emotions this song stirs in you—let’s listen and reflect together! 🍒🌸`,
      `🧠 Video loaded, dear listener! Dr. Melody senses this song’s chill vibe—perhaps a moment of calm for you today! 🍒🌸`,
      `🧠 A song to start our journey! Dr. Melody feels this track’s pop energy—perfect for lifting your spirits! 🍒🌸`,
      `🧠 Your video is playing, I see! Dr. Melody notices this song’s steady tempo—around 100 BPM. 🍒🌸`
    ];

    const playPhrasesPsych = [
      `🧠 The music resumes! Dr. Melody senses your energy shifting—how does this song lift your spirits? 🍒🌸`,
      `🧠 We’re playing again, dear listener! Dr. Melody feels the rock energy in this track—electric guitars often evoke passion! 🍒🌸`,
      `🧠 Music flowing once more! Dr. Melody notices this song’s synthwave vibe—dreamy and reflective! 🍒🌸`,
      `🧠 The melody continues! Dr. Melody senses this pop track’s uplifting tone—perfect for a mood boost! 🍒🌸`
    ];

    const pausePhrasesPsych = [
      `🧠 A pause in the music, how intriguing! Dr. Melody wonders—does this silence bring you calm or anticipation? 🍒🌸`,
      `🧠 Pausing the melody, I see! Dr. Melody feels this moment of quiet—perhaps a chance to reflect! 🍒🌸`,
      `🧠 A brief pause, dear listener! Dr. Melody senses this break as a moment to breathe—this song’s artist often explores deep themes! 🍒🌸`,
      `🧠 Music on hold, how thoughtful! Dr. Melody appreciates this pause—silence can be healing too! 🍒🌸`
    ];

    const nextPhrasesPsych = [
      `🧠 Moving to the next song, I see! Dr. Melody hopes this track brings a new layer of joy—how does it make you feel? 🍒🌸`,
      `🧠 On to the next melody! Dr. Melody senses this reggae track’s relaxed vibe—offbeat rhythms often soothe the soul! 🍒🌸`,
      `🧠 A fresh track begins! Dr. Melody feels this 2024 release’s modern energy—perfect for a new experience! 🍒🌸`,
      `🧠 The next song plays, dear listener! Dr. Melody notices its 5-minute length—a chance for deeper reflection! 🍒🌸`
    ];

    const prevPhrasesPsych = [
      `🧠 A step back in your musical journey! Dr. Melody senses nostalgia—does this song hold special memories for you? 🍒🌸`,
      `🧠 Revisiting the previous track, I see! Dr. Melody feels this country song’s storytelling—such songs often evoke emotion! 🍒🌸`,
      `🧠 Back to an earlier melody! Dr. Melody senses a 90s pop vibe—nostalgia can be so comforting! 🍒🌸`,
      `🧠 Rewinding to the last song! Dr. Melody appreciates this revisit—its 3-minute length is perfect for a quick reflection! 🍒🌸`
    ];

    const queueSelectPhrasesPsych = [
      `🧠 A thoughtful choice from the queue! Dr. Melody is curious—what drew you to this song today? 🍒🌸`,
      `🧠 Queue selection playing now! Dr. Melody notices this 2021 track’s popularity—10M views! 🍒🌸`,
      `🧠 A lovely queue pick, dear listener! Dr. Melody senses this acoustic song’s calm energy—perfect for introspection! 🍒🌸`,
      `🧠 Playing your queue choice! Dr. Melody feels this indie track’s raw emotion—indie music often carries authenticity! 🍒🌸`
    ];

    const historySelectPhrasesPsych = [
      `🧠 Revisiting a past favorite, I see! Dr. Melody wonders—what emotions does this song bring back for you? 🍒🌸`,
      `🧠 A history pick, how meaningful! Dr. Melody senses this 5-minute epic’s depth—it even won an award! 🍒🌸`,
      `🧠 Back to a rock classic from your history! Dr. Melody feels its energy—rock can be so invigorating! 🍒🌸`,
      `🧠 Replaying a pop hit from your history! Dr. Melody appreciates this choice—pop often uplifts the spirit! 🍒🌸`
    ];

    function showRadioHostMessage(message, forceShow = false) {
      if (forceShow || messageToggleCounter % 2 === 0) {
        radioHostBubble.textContent = message;
        radioHostBubble.classList.remove('hidden');
        speakText(message, 1.2, radioHostBubble); // Higher pitch for DJ Sunny
      }
      if (!forceShow) messageToggleCounter++;
    }

    function showPsychiatristMessage(message, forceShow = false) {
      if (forceShow || messageToggleCounter % 2 === 1) {
        psychiatristBubble.textContent = message;
        psychiatristBubble.classList.remove('hidden');
        speakText(message, 0.8, psychiatristBubble); // Lower pitch for Dr. Melody
      }
      if (!forceShow) messageToggleCounter++;
    }

    function getRandomPhrase(phrases) {
      return phrases[Math.floor(Math.random() * phrases.length)];
    }

    // Mid-Song Interruption Logic for DJ Sunny
    function startMidSongInterruptions() {
      if (interruptInterval) clearInterval(interruptInterval);
      interruptInterval = setInterval(() => {
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING && !isAdPlaying) {
          const currentTime = player.getCurrentTime();
          const timeSinceLastInterrupt = Date.now() - lastInterruptTime;
          if (currentTime > 30 && timeSinceLastInterrupt >= 30000) {
            if (Math.random() < 0.1) {
              player.pauseVideo();
              const interruptMessage = getRandomPhrase(midSongInterruptPhrases);
              showRadioHostMessage(interruptMessage, true);
              lastInterruptTime = Date.now();
              setTimeout(() => {
                if (player.getPlayerState() === YT.PlayerState.PAUSED) {
                  player.playVideo();
                  showPsychiatristMessage(`🧠 DJ Sunny’s interruption brought a fun moment, didn’t it? Dr. Melody feels the energy—how did that break in the music affect your mood? 🍒🌸`, true);
                }
              }, 5000);
            }
          }
        }
      }, 45000); // 45 seconds, 10% chance
    }

    // Authentication Functions
    async function login(email, password) {
      try {
        const response = await fetch('http://localhost:3000/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        if (response.ok) {
          localStorage.setItem('token', data.token);
          updateAuthState(data.token);
          togglePopup('authPopup', false);
          showRadioHostMessage(`☀️ Welcome back, sunshine VIP! DJ Sunny’s thrilled to see you—let’s make the airwaves glow! 🍒🌸`, true);
          showPsychiatristMessage(`🧠 You’ve logged in, how wonderful! Dr. Melody is here—how does returning to this musical space feel? 🍒🌸`, true);
        } else {
          alert(data.message);
        }
      } catch (err) {
        alert('Error logging in. Please try again.');
      }
    }

    async function signup(email, password) {
      try {
        const response = await fetch('http://localhost:3000/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await response.json();
        if (response.ok) {
          localStorage.setItem('token', data.token);
          updateAuthState(data.token);
          togglePopup('authPopup', false);
          showRadioHostMessage(`☀️ Welcome to the sunny crew, new VIP! DJ Sunny’s pumped to have you—let’s shine together! 🍒🌸`, true);
          showPsychiatristMessage(`🧠 A warm welcome to you, new listener! Dr. Melody is delighted—how does joining this musical community feel? 🍒🌸`, true);
        } else {
          alert(data.message);
        }
      } catch (err) {
        alert('Error signing up. Please try again.');
      }
    }

    async function verifyToken(token) {
      try {
        const response = await fetch('http://localhost:3000/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await response.json();
        if (response.ok) {
          return data.email;
        } else {
          localStorage.removeItem('token');
          return null;
        }
      } catch (err) {
        localStorage.removeItem('token');
        return null;
      }
    }

    async function updateAuthState(token) {
      const email = await verifyToken(token);
      if (email) {
        loginSignupBtn.textContent = 'Logout 🍒🌸';
        profileEmailDisplay.textContent = `User: ${email} 🍒🌸`;
      } else {
        loginSignupBtn.textContent = 'Login 🍒🌸';
        profileEmailDisplay.textContent = 'User: Guest 🍒🌸';
      }
    }

    async function checkAuthOnLoad() {
      const token = localStorage.getItem('token');
      if (token) {
        await updateAuthState(token);
      }
    }

    // Run on page load
    checkAuthOnLoad();

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '0',
        width: '0',
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onPlaybackQualityChange': onPlaybackQualityChange
        }
      });
      showRadioHostMessage('☀️ Hey there, sunshine squad! This is DJ Sunny, dropping the hottest tunes your way! Let’s light up the airwaves! It’s 11:39 AM WITA on a Tuesday—perfect time for some music! What’s your vibe today? 🍒🌸', true);
      showPsychiatristMessage('🧠 Hello, dear listener! I’m Dr. Melody, your musical therapist. Let’s explore how these tunes resonate with your soul! A Tuesday morning can be full of possibilities—how are you feeling right now? 🍒🌸', true);
    }

    function onPlayerReady(event) {
      document.getElementById('seekSlider').addEventListener('input', () => {
        const seekTo = (document.getElementById('seekSlider').value / 100) * player.getDuration();
        player.seekTo(seekTo);
      });
      updateSeekSlider();
      if (isAdMuted && isAdPlaying) {
        player.mute();
      }
      startMidSongInterruptions();
    }

    function onPlaybackQualityChange(event) {
      const currentQuality = event.data;
      if (lastPlaybackQuality && currentQuality !== lastPlaybackQuality) {
        console.log(`Playback quality changed: ${lastPlaybackQuality} -> ${currentQuality}`);
        showRadioHostMessage(`☀️ Quality switch detected, music rays! DJ Sunny’s keeping it smooth—now playing in ${currentQuality}! 🍒🌸`);
        lastPlaybackQuality = currentQuality;
      }
    }

    async function fetchVideoMetadata(videoId) {
      if (videoMetadataCache[videoId]) {
        return videoMetadataCache[videoId];
      }
      try {
        const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${API_KEY}`);
        const data = await response.json();
        if (data.items && data.items.length > 0) {
          const metadata = {
            title: data.items[0].snippet.title,
            channel: data.items[0].snippet.channelTitle,
            publishedAt: data.items[0].snippet.publishedAt
          };
          videoMetadataCache[videoId] = metadata;
          return metadata;
        }
        return null;
      } catch (err) {
        console.error('Error fetching video metadata:', err);
        return null;
      }
    }

    async function isLikelyAd(videoId, duration) {
      const metadata = await fetchVideoMetadata(videoId);
      if (!metadata) return false;

      const { title, channel } = metadata;
      const isShortVideo = duration > 0 && duration <= AD_DURATION_THRESHOLD;
      const hasAdKeywords = adPatterns.title.test(title) || adPatterns.channel.test(channel);

      console.log(`Metadata check - Title: ${title}, Channel: ${channel}, Duration: ${duration}s, IsShortVideo: ${isShortVideo}, HasAdKeywords: ${hasAdKeywords}`);

      return hasAdKeywords || isShortVideo;
    }

    function onPlayerStateChange(event) {
      const currentTime = Date.now();
      const state = event.data;
      const currentVideoId = player.getVideoData()['video_id'];
      const duration = player.getDuration();

      // Update state history (rolling window of last 3 states)
      stateHistory.push({ state, time: currentTime });
      if (stateHistory.length > STATE_WINDOW_SIZE) {
        stateHistory.shift();
      }

      // Analyze state transitions
      const isFrequentTransition = stateHistory.length >= 2 && 
        (currentTime - stateHistory[stateHistory.length - 2].time) / 1000 < TRANSITION_THRESHOLD;
      const isAdLikeTransition = stateHistory.some(s => s.state === YT.PlayerState.PAUSED) && 
        stateHistory.some(s => s.state === YT.PlayerState.PLAYING) && 
        state === YT.PlayerState.PLAYING;

      // Check playback quality change
      const isQualityChange = lastPlaybackQuality && player.getPlaybackQuality() !== lastPlaybackQuality;

      // Check if playback was user-initiated
      const isAutoPlay = !userInitiatedPlayback;

      // Determine if this is likely an ad
      const detectAd = async () => {
        const isShortVideo = duration > 0 && duration <= AD_DURATION_THRESHOLD;
        const isMetadataAd = await isLikelyAd(currentVideoId, duration);
        const isLikelyAdPlayback = (isShortVideo || isFrequentTransition || isAdLikeTransition || isQualityChange) && isAutoPlay;

        console.log(`Ad Detection - VideoID: ${currentVideoId}, Duration: ${duration}s, IsShortVideo: ${isShortVideo}, FrequentTransition: ${isFrequentTransition}, AdLikeTransition: ${isAdLikeTransition}, QualityChange: ${isQualityChange}, AutoPlay: ${isAutoPlay}, MetadataAd: ${isMetadataAd}`);

        return isMetadataAd || isLikelyAdPlayback;
      };

      // Update ad playing state
      detectAd().then(isAd => {
        if (currentVideoId !== lastVideoId) {
          if (isAd) {
            isAdPlaying = true;
            if (isAdMuted) {
              player.mute();
              const randomAdPhrase = getRandomPhrase(adDetectedPhrases);
              const randomAdPhrasePsych = getRandomPhrase(adDetectedPhrasesPsych);
              showRadioHostMessage(randomAdPhrase);
              showPsychiatristMessage(randomAdPhrasePsych);
            }
          } else {
            if (isAdPlaying) {
              isAdPlaying = false;
              if (isAdMuted) {
                player.unMute();
                const randomAdEndPhrase = getRandomPhrase(adEndedPhrases);
                const randomAdEndPhrasePsych = getRandomPhrase(adEndedPhrasesPsych);
                showRadioHostMessage(randomAdEndPhrase);
                showPsychiatristMessage(randomAdEndPhrasePsych);
              }
            }
          }
        }

        // Reset user-initiated flag after detection
        userInitiatedPlayback = false;
      });

      // Update tracking variables
      lastStateChangeTime = currentTime;
      lastVideoId = currentVideoId;
      lastDuration = duration;

      // Handle video end for playlist navigation
      if (state === YT.PlayerState.ENDED) {
        if (isLooping && currentIndex >= 0) {
          player.loadVideoById(playlist[currentIndex].id);
        } else {
          playNext();
        }
      }
    }

    function updateSeekSlider() {
      if (player && player.getCurrentTime) {
        const current = player.getCurrentTime();
        const duration = player.getDuration();
        document.getElementById('seekSlider').value = (current / duration) * 100 || 0;
        setTimeout(updateSeekSlider, 1000);
      }
    }

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60);
      return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    }

    function loadUrl() {
      const url = document.getElementById('urlInput').value;
      const playlistId = url.match(/list=([a-zA-Z0-9_-]+)/)?.[1];
      if (playlistId) {
        fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${API_KEY}`)
          .then(response => response.json())
          .then(data => {
            playlist = data.items.map(item => ({
              id: item.snippet.resourceId.videoId,
              title: item.snippet.title
            }));
            updateQueue();
            if (playlist.length > 0) {
              currentIndex = 0;
              userInitiatedPlayback = true; // User initiated
              playSong();
              const loadPlaylistMessage = getRandomPhrase(loadPlaylistPhrases);
              const loadPlaylistMessagePsych = getRandomPhrase(loadPlaylistPhrasesPsych);
              showRadioHostMessage(loadPlaylistMessage, true);
              showPsychiatristMessage(loadPlaylistMessagePsych, true);
            }
          })
          .catch(err => alert('Error loading playlist. Please check the URL or API key.'));
      } else {
        const videoId = url.match(/(?:v=)([a-zA-Z0-9_-]+)/)?.[1];
        if (videoId) {
          fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${API_KEY}`)
            .then(response => response.json())
            .then(data => {
              if (data.items.length > 0) {
                playlist.push({
                  id: videoId,
                  title: data.items[0].snippet.title
                });
                updateQueue();
                if (currentIndex === -1) {
                  currentIndex = 0;
                  userInitiatedPlayback = true; // User initiated
                  playSong();
                  const loadVideoMessage = getRandomPhrase(loadVideoPhrases);
                  const loadVideoMessagePsych = getRandomPhrase(loadVideoPhrasesPsych);
                  showRadioHostMessage(loadVideoMessage, true);
                  showPsychiatristMessage(loadVideoMessagePsych, true);
                }
              } else {
                alert('Invalid video URL');
              }
            });
        } else {
          alert('Invalid URL');
        }
      }
    }

    function playSong() {
      if (currentIndex >= 0 && currentIndex < playlist.length) {
        player.loadVideoById(playlist[currentIndex].id);
        document.getElementById('currentSong').textContent = playlist[currentIndex].title || 'No Track Loaded 🍒🌸';
        document.getElementById('currentSong').classList.add('playing');
        if (!history.includes(playlist[currentIndex])) {
          history.push(playlist[currentIndex]);
          updateHistory();
        }
        lastInterruptTime = 0; // Reset interruption timer for the new song
      }
    }

    function playNext() {
      if (isShuffling) {
        currentIndex = Math.floor(Math.random() * playlist.length);
      } else {
        currentIndex = (currentIndex + 1) % playlist.length;
      }
      userInitiatedPlayback = true; // User initiated
      playSong();
      const nextMessage = getRandomPhrase(nextPhrases);
      const nextMessagePsych = getRandomPhrase(nextPhrasesPsych);
      showRadioHostMessage(nextMessage);
      showPsychiatristMessage(nextMessagePsych);
    }

    function playPrevious() {
      currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
      userInitiatedPlayback = true; // User initiated
      playSong();
      const prevMessage = getRandomPhrase(prevPhrases);
      const prevMessagePsych = getRandomPhrase(prevPhrasesPsych);
      showRadioHostMessage(prevMessage);
      showPsychiatristMessage(prevMessagePsych);
    }

    function updateQueue() {
      const queueList = document.getElementById('queueList');
      queueList.innerHTML = '';
      playlist.forEach((song, index) => {
        const li = document.createElement('li');
        li.textContent = `🍒 ${song.title} 🌸`;
        li.className = 'cursor-pointer hover:bg-pink-200';
        li.onclick = () => {
          currentIndex = index;
          userInitiatedPlayback = true; // User initiated
          playSong();
          const queueMessage = getRandomPhrase(queueSelectPhrases);
          const queueMessagePsych = getRandomPhrase(queueSelectPhrasesPsych);
          showRadioHostMessage(queueMessage);
          showPsychiatristMessage(queueMessagePsych);
        };
        queueList.appendChild(li);
      });
    }

    function updateHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      history.forEach((song, index) => {
        const li = document.createElement('li');
        li.textContent = `🌸 ${song.title} 🍒`;
        li.className = 'cursor-pointer hover:bg-pink-200';
        li.onclick = () => {
          currentIndex = playlist.findIndex(s => s.id === song.id);
          if (currentIndex !== -1) {
            userInitiatedPlayback = true; // User initiated
            playSong();
            const historyMessage = getRandomPhrase(historySelectPhrases);
            const historyMessagePsych = getRandomPhrase(historySelectPhrasesPsych);
            showRadioHostMessage(historyMessage);
            showPsychiatristMessage(historyMessagePsych);
          }
        };
        historyList.appendChild(li);
      });
    }

    function togglePopup(popupId, show) {
      document.getElementById(popupId).style.display = show ? 'block' : 'none';
      document.getElementById('popupOverlay').style.display = show ? 'block' : 'none';
    }

    // Event Listeners
    document.getElementById('loadUrl').addEventListener('click', loadUrl);
    document.getElementById('playPauseBtn').addEventListener('click', () => {
      if (player.getPlayerState() === YT.PlayerState.PLAYING) {
        player.pauseVideo();
        document.getElementById('playPauseBtn').textContent = 'Play 🍒🌸';
        const pauseMessage = getRandomPhrase(pausePhrases);
        const pauseMessagePsych = getRandomPhrase(pausePhrasesPsych);
        showRadioHostMessage(pauseMessage);
        showPsychiatristMessage(pauseMessagePsych);
      } else {
        player.playVideo();
        document.getElementById('playPauseBtn').textContent = 'Pause 🍒🌸';
        const playMessage = getRandomPhrase(playPhrases);
        const playMessagePsych = getRandomPhrase(playPhrasesPsych);
        showRadioHostMessage(playMessage);
        showPsychiatristMessage(playMessagePsych);
        userInitiatedPlayback = true; // User initiated
      }
    });
    document.getElementById('prevBtn').addEventListener('click', playPrevious);
    document.getElementById('nextBtn').addEventListener('click', playNext);

    // Popup Controls
    document.getElementById('profileBtn').addEventListener('click', () => {
      togglePopup('profilePopup', true);
      // AI messages removed for Profile button
    });
    document.getElementById('settingsBtn').addEventListener('click', () => {
      togglePopup('settingsPopup', true);
      // AI messages removed for Settings button
    });
    document.getElementById('pomodoroBtn').addEventListener('click', () => {
      togglePopup('pomodoroPopup', true);
      showRadioHostMessage(`☀️ Productivity time, sunshine workers! DJ Sunny starts the Pomodoro—work hard, shine harder! 🍒🌸`, true);
      showPsychiatristMessage(`🧠 A Pomodoro timer, how proactive! Dr. Melody supports your focus—let’s balance productivity with the soothing power of music! 🍒🌸`, true);
    });
    document.getElementById('loginSignupBtn').addEventListener('click', () => {
      const token = localStorage.getItem('token');
      if (token) {
        localStorage.removeItem('token');
        updateAuthState(null);
        // AI messages removed for logout action
      } else {
        togglePopup('authPopup', true);
        // AI messages removed for login/signup action
      }
    });
    document.getElementById('closeAuth').addEventListener('click', () => togglePopup('authPopup', false));
    document.getElementById('closeProfile').addEventListener('click', () => togglePopup('profilePopup', false));
    document.getElementById('closeSettings').addEventListener('click', () => togglePopup('settingsPopup', false));
    document.getElementById('closePomodoro').addEventListener('click', () => togglePopup('pomodoroPopup', false));

    // Auth Popup
    document.getElementById('toggleAuth').addEventListener('click', () => {
      isLoginMode = !isLoginMode;
      document.getElementById('authTitle').textContent = isLoginMode ? 'Login 🍒🌸' : 'Sign Up 🌸🍒';
      document.getElementById('toggleAuth').textContent = isLoginMode ? 'Switch to Sign Up 🍒🌸' : 'Switch to Login 🌸🍒';
      document.getElementById('submitAuth').textContent = isLoginMode ? 'Login 🍒🌸' : 'Sign Up 🌸🍒';
    });
    document.getElementById('submitAuth').addEventListener('click', () => {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      if (isLoginMode) {
        login(email, password);
      } else {
        signup(email, password);
      }
    });

    // Profile Popup
    document.getElementById('signOutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      updateAuthState(null);
      togglePopup('profilePopup', false);
      showRadioHostMessage(`☀️ Farewell for now, sunshine VIP! DJ Sunny logs you out—come back to the rays! 🍒🌸`, true);
      showPsychiatristMessage(`🧠 Signing out, I see! Dr. Melody hopes this musical journey brought you joy—until we meet again! 🍒🌸`, true);
    });

    // Pomodoro Timer
    let pomodoroInterval;
    let isWork = true;
    let timeLeft = 25 * 60;

    function updatePomodoroDisplay() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      document.getElementById('pomodoroTime').textContent = `${min}:${sec < 10 ? '0' : ''}${sec} 🍒🌸`;
    }

    document.getElementById('pomodoroStart').addEventListener('click', () => {
      if (!pomodoroInterval) {
        pomodoroInterval = setInterval(() => {
          timeLeft--;
          if (timeLeft <= 0) {
            isWork = !isWork;
            timeLeft = (isWork ? document.getElementById('pomodoroWork').value : document.getElementById('pomodoroBreak').value) * 60;
            showRadioHostMessage(`☀️ Time’s up, productivity rays! DJ Sunny switches to ${isWork ? 'work' : 'break'}—keep shining! 🍒🌸`, true);
            showPsychiatristMessage(`🧠 A shift in focus, how refreshing! Dr. Melody supports your transition to ${isWork ? 'work' : 'break'}—let the music guide your energy! 🍒🌸`, true);
          }
          updatePomodoroDisplay();
        }, 1000);
        document.getElementById('pomodoroStart').textContent = 'Pause 🍒🌸';
        showRadioHostMessage(`☀️ Let’s shine with focus, sunshine fans! DJ Sunny starts the Pomodoro—25 minutes of brilliance! 🍒🌸`, true);
        showPsychiatristMessage(`🧠 Starting the Pomodoro, how motivated! Dr. Melody is here—let’s channel this focus into a harmonious balance with your tunes! 🍒🌸`, true);
      } else {
        clearInterval(pomodoroInterval);
        pomodoroInterval = null;
        document.getElementById('pomodoroStart').textContent = 'Start 🍒🌸';
        showRadioHostMessage(`☀️ Taking a sunny break, folks! DJ Sunny pauses the Pomodoro—rest those radiant minds! 🍒🌸`, true);
        showPsychiatristMessage(`🧠 Pausing the timer, I see! Dr. Melody encourages this moment of rest—how does this break feel for you? 🍒🌸`, true);
      }
    });

    document.getElementById('pomodoroReset').addEventListener('click', () => {
      clearInterval(pomodoroInterval);
      pomodoroInterval = null;
      timeLeft = document.getElementById('pomodoroWork').value * 60;
      isWork = true;
      updatePomodoroDisplay();
      document.getElementById('pomodoroStart').textContent = 'Start 🍒🌸';
      showRadioHostMessage(`☀️ Resetting the sunny clock, time travelers! DJ Sunny restarts the Pomodoro—fresh rays, fresh beats! 🍒🌸`, true);
      showPsychiatristMessage(`🧠 A reset, how grounding! Dr. Melody appreciates your fresh start—let’s align this new cycle with your musical flow! 🍒🌸`, true);
    });

    // Settings Toggles
    document.getElementById('muteAdToggle').addEventListener('change', () => {
      isAdMuted = document.getElementById('muteAdToggle').checked;
      if (isAdPlaying) {
        if (isAdMuted) {
          player.mute();
          showRadioHostMessage(`☀️ Clearing the clouds, sunshine fans! DJ Sunny mutes those ads—pure rays ahead! 🍒🌸`);
        } else {
          player.unMute();
          showRadioHostMessage(`☀️ Ads back on, music rays! DJ Sunny unmutes—embrace the full sunny spectrum! 🍒🌸`);
        }
      } else {
        showRadioHostMessage(`☀️ Toggled the ad mute, savvy sunbeams! DJ Sunny sets it to ${isAdMuted ? 'on' : 'off'}—stay in charge! 🍒🌸`);
      }
    });

    document.getElementById('hifiModeToggle').addEventListener('change', () => {
      isHifiMode = document.getElementById('hifiModeToggle').checked;
      showRadioHostMessage(`☀️ Boosting the sunshine sound, audiophiles! DJ Sunny switches HiFi Mode to ${isHifiMode ? 'on' : 'off'}—crisp rays incoming! 🍒🌸`);
    });

    // Equalizer (mock)
    document.getElementById('bass').addEventListener('click', () => {
      const value = document.getElementById('bass').value;
      showRadioHostMessage(`☀️ Thumping the sunny bass, beat rays! DJ Sunny adjusts it to ${value}—feel the low-end glow! 🍒🌸`);
    });
    document.getElementById('mid').addEventListener('click', () => {
      const value = document.getElementById('mid').value;
      showRadioHostMessage(`☀️ Tuning the sunny mids, harmony beams! DJ Sunny sets it to ${value}—perfect balance achieved! 🍒🌸`);
    });
    document.getElementById('treble').addEventListener('click', () => {
      const value = document.getElementById('treble').value;
      showRadioHostMessage(`☀️ Sizzling the sunny treble, high-note rays! DJ Sunny dials it to ${value}—crystal-clear sunshine! 🍒🌸`);
    });
  </script>
</body>
</html>