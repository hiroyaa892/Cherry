<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retro YouTube Music Player</title>
  <link href="./src/output.css" rel="stylesheet">
  <script src="https://www.youtube.com/iframe_api"></script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #f8c3c3;
      font-family: 'Press Start 2P', monospace;
      image-rendering: pixelated;
      margin: 0;
      padding: 15px;
    }
    .container {
      background-color: #d89393;
      border: 4px solid #c94b4b;
      border-radius: 16px;
      padding: 15px;
      max-width: 500px;
      margin: 0 auto;
      box-shadow: 4px 4px 0 #2d1a1a;
      position: relative;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .retro-button {
      background-color: #d89393;
      border: 2px solid #c94b4b;
      color: #2d1a1a;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }
    .retro-button::before {
      content: '🍒';
      position: absolute;
      left: -10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.4;
    }
    .retro-button::after {
      content: '🌸';
      position: absolute;
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.4;
    }
    .retro-button:hover {
      background-color: #e6b8b8;
    }
    .retro-button.active {
      background-color: #e6b8b8;
      border-color: #2d1a1a;
    }
    .retro-button.disabled {
      background-color: #a77b7b;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .input-section {
      text-align: center;
      margin-bottom: 15px;
    }
    input[type="text"], input[type="email"], input[type="password"] {
      background-color: #f8c3c3;
      border: 2px solid #c94b4b;
      border-radius: 8px;
      padding: 8px;
      font-size: 11px;
      width: 70%;
      margin-right: 8px;
    }
    .media-controls {
      text-align: center;
      margin-bottom: 15px;
    }
    .media-controls .buttons {
      margin-bottom: 8px;
    }
    .media-controls .seek-bar {
      width: 100%;
      margin-bottom: 8px;
    }
    input[type="range"] {
      -webkit-appearance: none;
      background: #c94b4b;
      border-radius: 4px;
      height: 10px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #d89393;
      border: 2px solid #c94b4b;
      border-radius: 50%;
      cursor: pointer;
    }
    .queue-history {
      margin-bottom: 8px;
    }
    .queue-history h2 {
      font-size: 12px;
      margin-bottom: 8px;
      position: relative;
    }
    .queue-history h2::after {
      content: ' 🍒🌸';
      position: absolute;
      right: 0;
    }
    .queue-history ul {
      list-style: none;
      padding: 0;
      max-height: 100px;
      overflow-y: auto;
      font-size: 9px;
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #d89393;
      padding: 20px;
      border: 4px solid #c94b4b;
      border-radius: 16px;
      box-shadow: 4px 4px 0 #2d1a1a;
      z-index: 1000;
    }
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .playing {
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% { opacity: 0.6; }
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #c94b4b;
      transition: 0.4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: #d89393;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #e6b8b8;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    .radio-host-bubble {
      position: fixed;
      bottom: 100px;
      right: 10px;
      background-color: #e6b8b8;
      border: 2px solid #c94b4b;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 8px;
      max-width: 250px;
      text-align: left;
      box-shadow: 2px 2px 0 #2d1a1a;
      z-index: 1001;
      animation: fadeIn 1s;
      display: none;
    }
    .psychiatrist-bubble {
      position: fixed;
      bottom: 30px;
      right: 10px;
      background-color: #e6b8b8;
      border: 2px solid #c94b4b;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 8px;
      max-width: 250px;
      text-align: left;
      box-shadow: 2px 2px 0 #2d1a1a;
      z-index: 1001;
      animation: fadeIn 1s;
      display: none;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top Bar -->
    <div class="top-bar">
      <button id="profileBtn" class="retro-button disabled">Profile 🍒🌸</button>
      <button id="settingsBtn" class="retro-button disabled">Settings 🍒🌸</button>
      <button id="pomodoroBtn" class="retro-button disabled">Pomodoro 🍒🌸</button>
      <button id="loginSignupBtn" class="retro-button">Login 🍒🌸</button>
    </div>

    <!-- URL Input -->
    <div class="input-section">
      <input id="urlInput" type="text" placeholder="YouTube Playlist/Video URL 🍒🌸" class="retro-border">
      <button id="loadUrl" class="retro-button disabled">Load 🍒🌸</button>
    </div>

    <!-- Player Controls -->
    <div id="player" class="hidden"></div>
    <div class="media-controls">
      <div id="currentSong" class="text-center mb-2 font-bold text-lg">No Track Loaded 🍒🌸</div>
      <div class="buttons">
        <button id="prevBtn" class="retro-button disabled">Previous 🍒</button>
        <button id="playPauseBtn" class="retro-button disabled">Play/Pause 🌸</button>
        <button id="nextBtn" class="retro-button disabled">Next 🍒</button>
        <button id="loopBtn" class="retro-button disabled">Loop 🍒🌸</button>
        <button id="shuffleBtn" class="retro-button disabled">Shuffle 🍒🌸</button>
      </div>
      <div class="seek-bar">
        <input type="range" id="seekSlider" min="0" max="100" value="0" disabled>
      </div>
    </div>

    <!-- Queue and History -->
    <div class="queue-history">
      <h2>Queue 🍒</h2>
      <ul id="queueList"></ul>
    </div>
    <div class="queue-history">
      <h2>History 🌸</h2>
      <ul id="historyList"></ul>
    </div>
  </div>

  <!-- DJ Sunny Radio Host Bubble (Bottom Right, Above Dr. Melody) -->
  <div id="radioHostBubble" class="radio-host-bubble">☀️ Hey there, sunshine squad! This is DJ Sunny, your hyper-energetic host! Ready to flood your evening with tunes—any requests? 🍒🌸</div>

  <!-- Dr. Melody Psychiatrist Bubble (Bottom Right) -->
  <div id="psychiatristBubble" class="psychiatrist-bubble">🧠 Greetings, dear listener! I’m Dr. Melody, your insightful therapist. Let’s dive deep into your emotional soundscape—how’s your soul tonight? 🍒🌸</div>

  <!-- Popups -->
  <div id="authPopup" class="popup">
    <h2 id="authTitle" class="text-center font-bold mb-3 text-sm">Login 🍒🌸</h2>
    <button id="toggleAuth" class="retro-button w-full mb-3">Switch to Sign Up 🍒🌸</button>
    <input id="authUsername" type="text" placeholder="Username 🍒🌸" class="w-full mb-3">
    <input id="authEmail" type="email" placeholder="Email 🍒🌸" class="w-full mb-3">
    <input id="authPassword" type="password" placeholder="Password 🌸🍒" class="w-full mb-3">
    <button id="submitAuth" class="retro-button w-full mb-3">Login 🍒🌸</button>
    <button id="closeAuth" class="retro-button w-full">Close 🌸🍒</button>
  </div>
  <div id="profilePopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Profile 🍒🌸</h2>
    <p id="profileEmail" class="mb-3">User: Guest 🍒🌸</p>
    <button id="signOutBtn" class="retro-button w-full mb-3">Sign Out 🍒🌸</button>
    <button id="closeProfile" class="retro-button w-full">Close 🌸🍒</button>
  </div>
  <div id="settingsPopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Settings 🍒🌸</h2>
    <h3 class="font-bold mb-3">Audio Settings 🍒🌸</h3>
    <div class="flex items-center mb-3">
      <label class="text-xs mr-3">HiFi Mode 🌸🍒</label>
      <label class="toggle-switch">
        <input type="checkbox" id="hifiModeToggle">
        <span class="slider"></span>
      </label>
    </div>
    <div class="flex items-center mb-3">
      <label class="text-xs mr-3">AI Volume 🍒🌸</label>
      <input type="range" id="aiVolume" min="0" max="1" step="0.1" value="1" class="w-full">
    </div>
    <h3 class="font-bold mb-3">Equalizer 🍒🌸</h3>
    <div class="flex space-x-3 mb-3">
      <div>
        <label class="text-xs">Bass 🍒🌸</label>
        <input type="range" id="bass" min="-12" max="12" value="0" class="w-full">
      </div>
      <div>
        <label class="text-xs">Mid 🌸🍒</label>
        <input type="range" id="mid" min="-12" max="12" value="0" class="w-full">
      </div>
      <div>
        <label class="text-xs">Treble 🍒🌸</label>
        <input type="range" id="treble" min="-12" max="12" value="0" class="w-full">
      </div>
    </div>
    <button id="closeSettings" class="retro-button w-full">Close 🌸🍒</button>
  </div>
  <div id="pomodoroPopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Pomodoro Timer 🍒🌸</h2>
    <div id="pomodoroTime" class="text-center mb-3 text-sm">25:00 🍒🌸</div>
    <div class="flex justify-center space-x-3 mb-3">
      <button id="pomodoroStart" class="retro-button">Start 🍒🌸</button>
      <button id="pomodoroReset" class="retro-button">Reset 🌸🍒</button>
    </div>
    <div class="flex flex-wrap gap-3">
      <label class="text-xs">Work (min): 🍒🌸</label>
      <input id="pomodoroWork" type="number" value="25" class="w-20 p-2">
      <label class="text-xs">Break (min): 🌸🍒</label>
      <input id="pomodoroBreak" type="number" value="5" class="w-20 p-2">
    </div>
    <button id="closePomodoro" class="retro-button mt-3 w-full">Close 🌸🍒</button>
  </div>
  <div id="popupOverlay" class="popup-overlay"></div>

  <script>
    let player;
    let playlist = [];
    let history = [];
    let currentIndex = -1;
    let isLooping = false;
    let isShuffling = false;
    let isLoginMode = true;
    let isHifiMode = false;
    let lastStateChangeTime = 0;
    let lastVideoId = null;
    let lastDuration = 0;
    let lastPlaybackQuality = '';
    let stateHistory = [];
    let userInitiatedPlayback = false;
    let lastInterruptTime = 0;
    let interruptInterval = null;
    let audioContext = null;
    let audioSource = null;
    let isBackgroundPlaying = false;
    let adCheckInterval = null;
    let aiVolume = 1.0;
    let isAdSkippingEnabled = true;
    let lastInteractionTime = 0;
    let isAuthenticated = false;

    const API_KEY = 'AIzaSyBitewTBcoYxggjLlqbMm1qWhFatR6kvP8';

    const radioHostBubble = document.getElementById('radioHostBubble');
    const psychiatristBubble = document.getElementById('psychiatristBubble');
    const loginSignupBtn = document.getElementById('loginSignupBtn');
    const profileEmailDisplay = document.getElementById('profileEmail');
    let messageToggleCounter = 0;

    const synth = window.speechSynthesis;
    let voices = [];

    function loadVoices() {
      voices = synth.getVoices();
    }

    loadVoices();
    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = loadVoices;
    }

    function speakText(text, pitch, bubbleElement) {
      return new Promise((resolve) => {
        const cleanText = text.replace(/☀️|🧠|🍒|🌸/g, '').trim();
        if (cleanText === '') {
          setTimeout(() => {
            bubbleElement.style.display = 'none';
            resolve();
          }, 6000);
          return;
        }

        bubbleElement.style.display = 'block';
        // Pause music if playing
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
          player.pauseVideo();
        }

        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.pitch = pitch;
        utterance.rate = 1.0;
        utterance.volume = aiVolume;
        utterance.onend = () => {
          setTimeout(() => {
            bubbleElement.style.display = 'none';
            // Resume music after speech
            if (player && player.getPlayerState() === YT.PlayerState.PAUSED) {
              player.playVideo();
            }
            resolve();
          }, 2000);
        };

        utterance.onerror = () => {
          setTimeout(() => {
            bubbleElement.style.display = 'none';
            // Resume music on error
            if (player && player.getPlayerState() === YT.PlayerState.PAUSED) {
              player.playVideo();
            }
            resolve();
          }, 6000);
        };

        const voice = voices.find(v => v.lang.includes('en')) || voices[0];
        if (voice) {
          utterance.voice = voice;
        } else {
          setTimeout(() => {
            bubbleElement.style.display = 'none';
            // Resume music if no voice
            if (player && player.getPlayerState() === YT.PlayerState.PAUSED) {
              player.playVideo();
            }
            resolve();
          }, 6000);
          return;
        }

        synth.speak(utterance);
      });
    }

    const midSongInterruptPhrases = [
      `☀️ Hold up, sunshine squad! DJ Sunny here with a wild interrupt—this track’s funky beat is a mood-lifter! Any requests to spice it up? 🍒🌸`,
      `☀️ Bursting in with vibes, folks! DJ Sunny’s obsessed with this chill lo-fi energy—perfect for a relaxing vibe! What’s your take? 🍒🌸`,
      `☀️ Hey, music rays! DJ Sunny’s hyped—this banger has 5M views, and it’s rocking my world! Thoughts? 🍒🌸`,
      `☀️ Quick break, crew! DJ Sunny clocks this upbeat tempo at 130 BPM—pure sunshine fuel! What’s your pulse on it? 🍒🌸`,
      `☀️ Sunshine alert! DJ Sunny’s in love with this classic pop vibe—let’s dance into the night! Agree? 🍒🌸`,
      `☀️ Timeout, fans! DJ Sunny senses a beat drop—get ready for a vibe shift! Excited? 🍒🌸`,
      `☀️ Mid-track magic! DJ Sunny predicts a killer drop—let’s debate its impact, music rays! 🍒🌸`,
      `☀️ Rhythm shift alert! DJ Sunny’s tracking the next song—stay tuned for a musical twist! Ideas? 🍒🌸`,
      `☀️ Whoa, music rays! DJ Sunny feels the groove—this track’s got soulful vibes! What’s your jam? 🍒🌸`,
      `☀️ Sunny interruption! DJ Sunny’s vibing to this acoustic gem—pure warmth! You feeling it? 🍒🌸`,
      `☀️ Beat check, squad! DJ Sunny’s loving this jazzy rhythm—let’s swing to it! Thoughts? 🍒🌸`,
      `☀️ Mid-song shoutout! DJ Sunny’s caught by this electric guitar riff—rock on! Any requests? 🍒🌸`
    ];

    const loadPlaylistPhrases = [
      `☀️ Rise and shine, tune travelers! DJ Sunny’s loading your playlist with fiery flair—let’s ignite the vibe! 🍒🌸`,
      `☀️ Playlist loaded, sunshine crew! DJ Sunny’s diving into these indie vibes—perfect for the mood! What’s your favorite? 🍒🌸`,
      `☀️ Here we go, music lovers! DJ Sunny’s got your playlist ready—let’s dive into the sound! 🍒🌸`,
      `☀️ Loaded up, sunshine squad! DJ Sunny’s feeling these retro beats—time to groove! Pick a fave! 🍒🌸`
    ];

    const loadVideoPhrases = [
      `☀️ Brilliant pick, sunshine fans! DJ Sunny’s spinning your video—feel the soundwave surge! 🍒🌸`,
      `☀️ Single track loaded, music rays! DJ Sunny’s hyping this 4-minute banger—let’s break it down! 🍒🌸`,
      `☀️ Great choice, crew! DJ Sunny’s rolling this track—let’s soak in the rhythm! 🍒🌸`,
      `☀️ Video’s up, sunshine squad! DJ Sunny’s ready to vibe with this melody—let’s enjoy! 🍒🌸`
    ];

    const playPhrases = [
      `☀️ Let’s ignite it, sunshine lovers! DJ Sunny hits play—feel the rhythm explode! 🍒🌸`,
      `☀️ Play button smashed, music rays! DJ Sunny’s unleashing this rock anthem—let’s rock! 🍒🌸`,
      `☀️ Here we go, squad! DJ Sunny’s starting the beat—let’s get moving! 🍒🌸`,
      `☀️ Music’s on, sunshine crew! DJ Sunny’s dropping this tune—feel the energy! 🍒🌸`
    ];

    const pausePhrases = [
      `☀️ Sunshine break, folks! DJ Sunny pauses—enjoy the calm before the storm! 🍒🌸`,
      `☀️ Pause mode on, music rays! DJ Sunny’s giving you a breather—this lo-fi vibe is pure gold! 🍒🌸`,
      `☀️ Taking a breather, squad! DJ Sunny hits pause—let’s chill for a moment! 🍒🌸`,
      `☀️ Quiet vibes, sunshine crew! DJ Sunny’s pausing—time for a quick rest! 🍒🌸`
    ];

    const nextPhrases = [
      `☀️ Next stop, sunshine station! DJ Sunny cues the next track—keep the energy high! 🍒🌸`,
      `☀️ Moving on, music rays! DJ Sunny spins this reggae gem—perfect groove! 🍒🌸`,
      `☀️ Onward, sunshine fans! DJ Sunny’s playing the next song—let’s keep the vibe alive! 🍒🌸`,
      `☀️ Next up, crew! DJ Sunny’s rolling this hip-hop beat—let’s flow with it! 🍒🌸`
    ];

    const prevPhrases = [
      `☀️ Rewind those rays, listeners! DJ Sunny revisits this gem—relive the glow! 🍒🌸`,
      `☀️ Backtracking, music rays! DJ Sunny replays this country classic—pure nostalgia! 🍒🌸`,
      `☀️ Going back, sunshine squad! DJ Sunny spins an old favorite—feel the memories! 🍒🌸`,
      `☀️ Rewind time, crew! DJ Sunny’s bringing back this soulful track—let’s vibe! 🍒🌸`
    ];

    const queueSelectPhrases = [
      `☀️ Epic choice, sunshine crew! DJ Sunny plays your queue pick—feel the heat! 🍒🌸`,
      `☀️ Queue pick nailed, music rays! DJ Sunny spins this 2021 hit—5M views and counting! Thoughts? 🍒🌸`,
      `☀️ Nice selection, squad! DJ Sunny’s rolling your queue track—let’s groove! 🍒🌸`,
      `☀️ Queue magic, sunshine fans! DJ Sunny plays your pick—pure vibes! What’s next? 🍒🌸`
    ];

    const historySelectPhrases = [
      `☀️ Nostalgia blast, sunshine fans! DJ Sunny replays this oldie—pure radiance! 🍒🌸`,
      `☀️ History dive, music rays! DJ Sunny spins this 5-minute epic—throwback vibes! 🍒🌸`,
      `☀️ Memory lane, crew! DJ Sunny brings back this classic—let’s relive it! 🍒🌸`,
      `☀️ Past vibes, sunshine squad! DJ Sunny spins a history track—feel the nostalgia! 🍒🌸`
    ];

    const loopPhrases = [
      `☀️ Looping on, sunshine fans! DJ Sunny keeps this gem spinning—let’s soak it in! 🍒🌸`,
      `☀️ Loop off, music rays! DJ Sunny moves forward—new beats ahead! 🍒🌸`,
      `☀️ Repeat mode, squad! DJ Sunny’s keeping this tune on—let’s vibe again! 🍒🌸`,
      `☀️ Looping off, sunshine crew! DJ Sunny’s switching it up—fresh tracks incoming! 🍒🌸`
    ];

    const shufflePhrases = [
      `☀️ Shuffling the deck, tune travelers! DJ Sunny mixes it wild—surprises await! 🍒🌸`,
      `☀️ Shuffle off, sunshine crew! DJ Sunny restores order—steady flow ahead! 🍒🌸`,
      `☀️ Mixing it up, music rays! DJ Sunny shuffles the playlist—let’s see what’s next! 🍒🌸`,
      `☀️ Shuffle mode off, squad! DJ Sunny’s back to the lineup—smooth vibes! 🍒🌸`
    ];

    const adSkipPhrases = [
      `☀️ Ad incoming, sunshine squad! DJ Sunny skips it—back to pure vibes! 🍒🌸`,
      `☀️ Skipping that ad, music rays! DJ Sunny keeps the flow flawless! 🍒🌸`,
      `☀️ Ad bypassed, tune travelers! DJ Sunny’s got you covered—pure music ahead! 🍒🌸`,
      `☀️ Zap! Ad skipped, sunshine fans! DJ Sunny restores the rhythm—brilliant move! 🍒🌸`,
      `☀️ Ad alert, crew! DJ Sunny skips it fast—let’s keep the music rolling! 🍒🌸`,
      `☀️ No ads here, sunshine squad! DJ Sunny zaps it—back to the beats! 🍒🌸`
    ];

    const midSongDebatePhrases = [
      `☀️ DJ Sunny here—this beat’s a gem with 5M views! 🧠 Dr. Melody, does it heal or hype?`,
      `☀️ DJ Sunny says this 130 BPM track’s pure energy! 🧠 Dr. Melody, is it too intense for the mood?`,
      `☀️ DJ Sunny loves this pop vibe! 🧠 Dr. Melody, does it match the soul’s rhythm?`,
      `☀️ DJ Sunny predicts a drop—big move! 🧠 Dr. Melody, will it shift emotions or just noise?`,
      `☀️ DJ Sunny’s feeling this soulful chorus! 🧠 Dr. Melody, does it lift the spirit?`,
      `☀️ DJ Sunny catches a funky bassline! 🧠 Dr. Melody, is it groovy or distracting?`
    ];

    const loadPlaylistPhrasesPsych = [
      `🧠 A playlist, how fascinating! Dr. Melody senses your mood—let’s explore its emotional layers! 🍒🌸`,
      `🧠 Playlist loaded, dear listener! Dr. Melody detects genre diversity—reflecting your complexity! 🍒🌸`,
      `🧠 A playlist to unpack! Dr. Melody feels the vibes—let’s dive into your choices! 🍒🌸`,
      `🧠 Loaded, lovely! Dr. Melody senses mixed emotions—how does this lineup feel? 🍒🌸`
    ];

    const loadVideoPhrasesPsych = [
      `🧠 A single track, intriguing! Dr. Melody ponders its emotional stir—let’s reflect! 🍒🌸`,
      `🧠 Video loaded, dear one! Dr. Melody feels this chill vibe—calm for the moment? 🍒🌸`,
      `🧠 A track to explore! Dr. Melody senses its depth—how does it resonate with you? 🍒🌸`,
      `🧠 Loaded up, listener! Dr. Melody feels the melody—does it soothe your soul? 🍒🌸`
    ];

    const playPhrasesPsych = [
      `🧠 Music flows again! Dr. Melody senses your energy shift—how’s your spirit lifting? 🍒🌸`,
      `🧠 Playing now, listener! Dr. Melody feels this rock passion—electric chords awakening you? 🍒🌸`,
      `🧠 Tunes are back! Dr. Melody feels a spark—does this beat energize you? 🍒🌸`,
      `🧠 Music’s on, dear! Dr. Melody senses the rhythm—how’s it moving your heart? 🍒🌸`
    ];

    const pausePhrasesPsych = [
      `🧠 Pause, how thoughtful! Dr. Melody wonders—does silence bring peace or tension? 🍒🌸`,
      `🧠 Pausing, I see! Dr. Melody feels this quiet—time for reflection? 🍒🌸`,
      `🧠 A moment of stillness! Dr. Melody ponders—how does this break feel? 🍒🌸`,
      `🧠 Music off, listener! Dr. Melody senses calm—space to breathe, perhaps? 🍒🌸`
    ];

    const nextPhrasesPsych = [
      `🧠 Next song, exciting! Dr. Melody hopes for joy—how does it touch you? 🍒🌸`,
      `🧠 Moving on, listener! Dr. Melody senses reggae calm—offbeats soothing your soul? 🍒🌸`,
      `🧠 On to the next, dear! Dr. Melody feels a shift—does this track uplift you? 🍒🌸`,
      `🧠 New tune, lovely! Dr. Melody senses warmth—how’s this melody for you? 🍒🌸`
    ];

    const prevPhrasesPsych = [
      `🧠 Back in time, fascinating! Dr. Melody senses nostalgia—memories stirring? 🍒🌸`,
      `🧠 Revisiting, I see! Dr. Melody feels this country tale—emotions rising tonight? 🍒🌸`,
      `🧠 Rewinding, dear! Dr. Melody feels the past—does this track bring joy? 🍒🌸`,
      `🧠 Back we go, listener! Dr. Melody senses depth—how’s this memory lane? 🍒🌸`
    ];

    const queueSelectPhrasesPsych = [
      `🧠 Wise queue choice! Dr. Melody’s curious—what drew your heart to this? 🍒🌸`,
      `🧠 Queue pick playing! Dr. Melody notes this 2021 hit’s 10M views—deep resonance? 🍒🌸`,
      `🧠 Thoughtful pick, dear! Dr. Melody wonders—why this song for you? 🍒🌸`,
      `🧠 Queue selection, nice! Dr. Melody feels its vibe—does it match your mood? 🍒🌸`
    ];

    const historySelectPhrasesPsych = [
      `🧠 Past favorite, moving! Dr. Melody wonders—what emotions resurface? 🍒🌸`,
      `🧠 History pick, profound! Dr. Melody feels this 5-minute epic’s depth—award-worthy impact? 🍒🌸`,
      `🧠 Old gem, touching! Dr. Melody senses nostalgia—how does it feel now? 🍒🌸`,
      `🧠 History track, dear! Dr. Melody feels its weight—memories coming back? 🍒🌸`
    ];

    const loopPhrasesPsych = [
      `🧠 Looping, immersive! Dr. Melody explores—does repetition deepen your bond? 🍒🌸`,
      `🧠 Loop off, forward! Dr. Melody guides to new tunes—fresh emotional waves? 🍒🌸`,
      `🧠 Repeat on, listener! Dr. Melody feels comfort—does this loop soothe you? 🍒🌸`,
      `🧠 Looping off, dear! Dr. Melody welcomes change—new vibes to explore? 🍒🌸`
    ];

    const shufflePhrasesPsych = [
      `🧠 Shuffling, spontaneous! Dr. Melody embraces chaos—what feelings arise? 🍒🌸`,
      `🧠 Shuffle off, order! Dr. Melody values flow—how’s this rhythm for you? 🍒🌸`,
      `🧠 Mixing it up, dear! Dr. Melody senses surprise—how’s this random vibe? 🍒🌸`,
      `🧠 Order restored, listener! Dr. Melody feels balance—smooth flow now? 🍒🌸`
    ];

    const adSkipPhrasesPsych = [
      `🧠 Ad detected, skipped! Dr. Melody restores your therapy—back to healing! 🍒🌸`,
      `🧠 Ad avoided, smooth! Dr. Melody keeps your journey flowing—emotions intact? 🍒🌸`,
      `🧠 Skipping ad, focused! Dr. Melody prioritizes your soul’s music! 🍒🌸`,
      `🧠 Ad bypassed, care! Dr. Melody guides you back to melody—how’s your mood now? 🍒🌸`,
      `🧠 Ad gone, dear! Dr. Melody keeps the peace—back to your soundscape! 🍒🌸`,
      `🧠 Skipped ad, listener! Dr. Melody ensures flow—feeling the rhythm again? 🍒🌸`
    ];

    async function showRadioHostMessage(message, forceShow = false) {
      if (forceShow || Math.random() < 0.9) {
        radioHostBubble.textContent = message;
        radioHostBubble.style.display = 'block';
        await speakText(message, 1.2, radioHostBubble);
      }
      messageToggleCounter++;
    }

    async function showPsychiatristMessage(message, forceShow = false) {
      if (forceShow || Math.random() < 0.9) {
        psychiatristBubble.textContent = message;
        psychiatristBubble.style.display = 'block';
        await speakText(message, 0.8, psychiatristBubble);
      }
      messageToggleCounter++;
    }

    function getRandomPhrase(phrases) {
      return phrases[Math.floor(Math.random() * phrases.length)];
    }

    function startMidSongInterruptions() {
      if (interruptInterval) clearInterval(interruptInterval);
      interruptInterval = setInterval(async () => {
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING && !document.hidden && isAuthenticated) {
          const currentTime = player.getCurrentTime();
          const duration = player.getDuration();
          const progress = currentTime / duration;
          const timeSinceLastInterrupt = Date.now() - lastInterruptTime;

          if (duration > 0 && progress >= 0.5 && progress <= 0.7 && timeSinceLastInterrupt >= 10000) {
            const debatePhrase = getRandomPhrase(midSongDebatePhrases);
            await showRadioHostMessage(debatePhrase.split('🧠')[0].trim(), true);
            await showPsychiatristMessage(`🧠 ${debatePhrase.split('🧠')[1].trim()}`, true);
            const followUp = Math.random() < 0.5 ? 
              `☀️ DJ Sunny agrees—it’s a vibe! 🧠 Dr. Melody counters—too much energy?` : 
              `☀️ DJ Sunny pushes the beat! 🧠 Dr. Melody suggests calm—balance, anyone?`;
            await showRadioHostMessage(followUp.split('🧠')[0].trim());
            await showPsychiatristMessage(`🧠 ${followUp.split('🧠')[1].trim()}`);
            lastInterruptTime = Date.now();
          }
        }
      }, 15000);
    }

    async function login(username, email, password) {
      try {
        const users = JSON.parse(localStorage.getItem('users')) || {};
        if (users[email] && users[email].username === username && users[email].password === password) {
          const token = btoa(email + ':' + Date.now());
          localStorage.setItem('token', token);
          users[email].token = token;
          localStorage.setItem('users', JSON.stringify(users));
          updateAuthState(token);
          togglePopup('authPopup', false);
          await showRadioHostMessage(`☀️ Welcome back, sunshine VIP ${username}! DJ Sunny’s ecstatic—let’s glow! 🧠 Dr. Melody, their return’s a sign of loyalty!`, true);
          await showPsychiatristMessage(`🧠 Logged in, delightful ${username}! Dr. Melody senses joy—how does this musical haven feel? ☀️ DJ Sunny adds—let’s party!`, true);
        } else {
          alert('Invalid username, email, or password.');
        }
      } catch (err) {
        alert('Error logging in. Please try again.');
      }
    }

    async function signup(username, email, password) {
      try {
        const users = JSON.parse(localStorage.getItem('users')) || {};
        if (users[email]) {
          alert('Email already exists. Please log in or use a different email.');
          return;
        }
        const token = btoa(email + ':' + Date.now());
        users[email] = { username, password, token };
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('token', token);
        updateAuthState(token);
        togglePopup('authPopup', false);
        await showRadioHostMessage(`☀️ New VIP alert, ${username}! DJ Sunny’s pumped—welcome to the crew! 🧠 Dr. Melody, a fresh soul joins!`, true);
        await showPsychiatristMessage(`🧠 Welcome, new listener ${username}! Dr. Melody feels your excitement—how’s this community vibe? ☀️ DJ Sunny says—let’s dance!`, true);
      } catch (err) {
        alert('Error signing up. Please try again.');
      }
    }

    async function verifyToken(token) {
      try {
        const users = JSON.parse(localStorage.getItem('users')) || {};
        for (const email in users) {
          if (users[email].token === token) {
            return { email, username: users[email].username };
          }
        }
        localStorage.removeItem('token');
        return null;
      } catch (err) {
        localStorage.removeItem('token');
        return null;
      }
    }

    async function updateAuthState(token) {
      const userData = await verifyToken(token);
      if (userData) {
        isAuthenticated = true;
        loginSignupBtn.textContent = 'Logout 🍒🌸';
        profileEmailDisplay.textContent = `User: ${userData.username} 🍒🌸`;
        document.getElementById('profileBtn').classList.remove('disabled');
        document.getElementById('settingsBtn').classList.remove('disabled');
        document.getElementById('pomodoroBtn').classList.remove('disabled');
        document.getElementById('loginSignupBtn').classList.remove('disabled');
        document.getElementById('loadUrl').classList.remove('disabled');
        document.getElementById('prevBtn').classList.remove('disabled');
        document.getElementById('playPauseBtn').classList.remove('disabled');
        document.getElementById('nextBtn').classList.remove('disabled');
        document.getElementById('loopBtn').classList.remove('disabled');
        document.getElementById('shuffleBtn').classList.remove('disabled');
        document.getElementById('seekSlider').disabled = false;
      } else {
        isAuthenticated = false;
        loginSignupBtn.textContent = 'Login 🍒🌸';
        profileEmailDisplay.textContent = 'User: Guest 🍒🌸';
        document.getElementById('profileBtn').classList.add('disabled');
        document.getElementById('settingsBtn').classList.add('disabled');
        document.getElementById('pomodoroBtn').classList.add('disabled');
        document.getElementById('loginSignupBtn').classList.remove('disabled');
        document.getElementById('loadUrl').classList.add('disabled');
        document.getElementById('prevBtn').classList.add('disabled');
        document.getElementById('playPauseBtn').classList.add('disabled');
        document.getElementById('nextBtn').classList.add('disabled');
        document.getElementById('loopBtn').classList.add('disabled');
        document.getElementById('shuffleBtn').classList.add('disabled');
        document.getElementById('seekSlider').disabled = true;
      }
    }

    async function checkAuthOnLoad() {
      const token = localStorage.getItem('token');
      if (token) {
        await updateAuthState(token);
      } else {
        togglePopup('authPopup', true);
      }
    }

    checkAuthOnLoad();

    function onYouTubeIframeAPIReady() {
      console.log('YouTube IFrame API Ready');
      player = new YT.Player('player', {
        height: '0',
        width: '0',
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onPlaybackQualityChange': onPlaybackQualityChange
        }
      });
      if (isAuthenticated) {
        showRadioHostMessage('☀️ Hey, sunshine squad! DJ Sunny, live and ready to blast tunes! What’s your vibe? 🧠 Dr. Melody, let’s analyze their mood!', true)
          .then(() => showPsychiatristMessage(`🧠 Hello, dear souls! Dr. Melody here—let’s dive into your emotional playlist! ☀️ DJ Sunny, hype them up!`, true));
      }
    }

    function onPlayerReady(event) {
      console.log('Player Ready', event);
      if (isAuthenticated) {
        document.getElementById('seekSlider').addEventListener('input', () => {
          const seekTo = (document.getElementById('seekSlider').value / 100) * player.getDuration();
          player.seekTo(seekTo);
        });
        updateSeekSlider();
        startMidSongInterruptions();
        setupBackgroundPlayback();
        startAdSkipPolling();
      }
    }

    function onPlaybackQualityChange(event) {
      const currentQuality = event.data;
      if (isAuthenticated && lastPlaybackQuality && currentQuality !== lastPlaybackQuality) {
        console.log(`Playback quality changed: ${lastPlaybackQuality} -> ${currentQuality}`);
        showRadioHostMessage(`☀️ Quality shift, music rays! DJ Sunny’s smoothing it to ${currentQuality}—crisp vibes! 🧠 Dr. Melody, does this enhance the mood?`);
        lastPlaybackQuality = currentQuality;
      }
    }

    function onPlayerStateChange(event) {
      const currentTime = Date.now();
      const state = event.data;
      const currentVideoId = player.getVideoData()['video_id'];
      const duration = player.getDuration();
      const currentQuality = player.getPlaybackQuality();

      stateHistory.push({ state, time: currentTime });
      if (stateHistory.length > 3) {
        stateHistory.shift();
      }

      userInitiatedPlayback = false;

      if (isAuthenticated) {
        if (state === YT.PlayerState.ENDED) {
          if (isLooping && currentIndex >= 0) {
            player.loadVideoById(playlist[currentIndex].id);
            showRadioHostMessage(`☀️ Looping this gem again! DJ Sunny’s obsessed—pure sunshine! 🧠 Dr. Melody, is repetition healing?`);
          } else {
            playNext();
          }
        } else if (state === YT.PlayerState.PAUSED && !userInitiatedPlayback) {
          const isAd = isLikelyAd(currentVideoId, duration, currentQuality);
          if (isAd && isAdSkippingEnabled) {
            skipAd();
          }
        }
      }
    }

    function updateSeekSlider() {
      if (player && player.getCurrentTime && isAuthenticated) {
        const current = player.getCurrentTime();
        const duration = player.getDuration();
        document.getElementById('seekSlider').value = (current / duration) * 100 || 0;
        setTimeout(updateSeekSlider, 1000);
      }
    }

    async function loadUrl() {
      if (!isAuthenticated) {
        togglePopup('authPopup', true);
        return;
      }
      let url = document.getElementById('urlInput').value.trim();
      if (!url) {
        alert('Please enter a YouTube URL.');
        return;
      }

      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }

      let videoId = null;
      let playlistId = null;

      const videoRegex = [
        /(?:v=)([a-zA-Z0-9_-]{11})/,
        /youtu\.be\/([a-zA-Z0-9_-]{11})/,
        /embed\/([a-zA-Z0-9_-]{11})/,
        /watch\?v=([a-zA-Z0-9_-]{11})/
      ];

      const playlistRegex = /(?:list=)([a-zA-Z0-9_-]+)/;

      const playlistMatch = url.match(playlistRegex);
      if (playlistMatch) {
        playlistId = playlistMatch[1];
      }

      for (const regex of videoRegex) {
        const match = url.match(regex);
        if (match) {
          videoId = match[1];
          break;
        }
      }

      console.log('Parsed URL:', { videoId, playlistId });

      if (playlistId) {
        try {
          const response = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${API_KEY}`);
          console.log('Playlist response status:', response.status);
          const data = await response.json();
          console.log('Playlist data:', data);
          if (data.items && data.items.length > 0) {
            playlist = data.items.map(item => ({
              id: item.snippet.resourceId.videoId,
              title: item.snippet.title
            }));
            updateQueue();
            if (playlist.length > 0) {
              currentIndex = 0;
              userInitiatedPlayback = true;
              const loadPlaylistMessage = getRandomPhrase(loadPlaylistPhrases);
              const loadPlaylistMessagePsych = getRandomPhrase(loadPlaylistPhrasesPsych);
              await showRadioHostMessage(`${loadPlaylistMessage} 🧠 Dr. Melody, this mix is a mood map!`);
              await showPsychiatristMessage(`${loadPlaylistMessagePsych} ☀️ DJ Sunny, let’s energize it!`);
              playSong();
            } else {
              console.error('No items found in playlist');
              alert('No items found in the playlist. Please check the URL.');
            }
          } else {
            console.error('Invalid playlist data');
            alert('Invalid playlist URL or no videos found.');
          }
        } catch (err) {
          console.error('Error loading playlist:', err);
          alert('Error loading playlist. Please check the URL or API key.');
        }
      }
      else if (videoId) {
        try {
          const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${API_KEY}`);
          console.log('Video response status:', response.status);
          const data = await response.json();
          console.log('Video data:', data);
          if (data.items && data.items.length > 0) {
            playlist.push({
              id: videoId,
              title: data.items[0].snippet.title
            });
            updateQueue();
            if (currentIndex === -1) {
              currentIndex = 0;
              userInitiatedPlayback = true;
              const loadVideoMessage = getRandomPhrase(loadVideoPhrases);
              const loadVideoMessagePsych = getRandomPhrase(loadVideoPhrasesPsych);
              await showRadioHostMessage(`${loadVideoMessage} 🧠 Dr. Melody, what emotions rise?`);
              await showPsychiatristMessage(`${loadVideoMessagePsych} ☀️ DJ Sunny, let’s pump it up!`);
              playSong();
            }
          } else {
            console.error('Invalid video data');
            alert('Invalid video URL');
          }
        } catch (err) {
          console.error('Error loading video:', err);
          alert('Error loading video. Please check the URL or API key.');
        }
      }
      else {
        console.error('Invalid URL format');
        alert('Invalid YouTube URL. Please provide a valid video or playlist URL.');
      }
    }

    function playSong() {
      if (currentIndex >= 0 && currentIndex < playlist.length && isAuthenticated) {
        console.log(`Playing song at index ${currentIndex}:`, playlist[currentIndex]);
        player.loadVideoById(playlist[currentIndex].id);
        document.getElementById('currentSong').textContent = playlist[currentIndex].title || 'No Track Loaded 🍒🌸';
        document.getElementById('currentSong').classList.add('playing');
        if (!history.includes(playlist[currentIndex])) {
          history.push(playlist[currentIndex]);
          updateHistory();
        }
        lastInterruptTime = 0;
        lastVideoId = playlist[currentIndex].id;
        const playMessage = getRandomPhrase(playPhrases);
        const playMessagePsych = getRandomPhrase(playPhrasesPsych);
        showRadioHostMessage(`${playMessage} 🧠 Dr. Melody, feel the pulse?`);
        showPsychiatristMessage(`${playMessagePsych} ☀️ DJ Sunny, keep the beat strong!`);
      }
    }

    function playNext() {
      if (isAuthenticated) {
        if (isLooping && currentIndex >= 0) {
          playSong();
        } else {
          if (isShuffling) {
            let newIndex;
            do {
              newIndex = Math.floor(Math.random() * playlist.length);
            } while (newIndex === currentIndex && playlist.length > 1);
            currentIndex = newIndex;
          } else {
            currentIndex = (currentIndex + 1) % playlist.length;
          }
          userInitiatedPlayback = true;
          playSong();
          const nextMessage = getRandomPhrase(nextPhrases);
          const nextMessagePsych = getRandomPhrase(nextPhrasesPsych);
          showRadioHostMessage(`${nextMessage} 🧠 Dr. Melody, new mood incoming!`);
          showPsychiatristMessage(`${nextMessagePsych} ☀️ DJ Sunny, let’s roll!`);
        }
      }
    }

    function playPrevious() {
      if (isAuthenticated) {
        if (isLooping && currentIndex >= 0) {
          playSong();
        } else {
          if (isShuffling) {
            let newIndex;
            do {
              newIndex = Math.floor(Math.random() * playlist.length);
            } while (newIndex === currentIndex && playlist.length > 1);
            currentIndex = newIndex;
          } else {
            currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
          }
          userInitiatedPlayback = true;
          playSong();
          const prevMessage = getRandomPhrase(prevPhrases);
          const prevMessagePsych = getRandomPhrase(prevPhrasesPsych);
          showRadioHostMessage(`${prevMessage} 🧠 Dr. Melody, nostalgia time?`);
          showPsychiatristMessage(`${prevMessagePsych} ☀️ DJ Sunny, back we go!`);
        }
      }
    }

    function updateQueue() {
      const queueList = document.getElementById('queueList');
      queueList.innerHTML = '';
      if (isAuthenticated) {
        playlist.forEach((song, index) => {
          const li = document.createElement('li');
          li.textContent = `🍒 ${song.title} 🌸`;
          li.className = 'cursor-pointer hover:bg-pink-200';
          li.onclick = () => {
            currentIndex = index;
            userInitiatedPlayback = true;
            playSong();
            const queueMessage = getRandomPhrase(queueSelectPhrases);
            const queueMessagePsych = getRandomPhrase(queueSelectPhrasesPsych);
            showRadioHostMessage(`${queueMessage} 🧠 Dr. Melody, why this choice?`);
            showPsychiatristMessage(`${queueMessagePsych} ☀️ DJ Sunny, great pick!`);
          };
          queueList.appendChild(li);
        });
      }
    }

    function updateHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      if (isAuthenticated) {
        history.forEach((song, index) => {
          const li = document.createElement('li');
          li.textContent = `🌸 ${song.title} 🍒`;
          li.className = 'cursor-pointer hover:bg-pink-200';
          li.onclick = () => {
            currentIndex = playlist.findIndex(s => s.id === song.id);
            if (currentIndex !== -1) {
              userInitiatedPlayback = true;
              playSong();
              const historyMessage = getRandomPhrase(historySelectPhrases);
              const historyMessagePsych = getRandomPhrase(historySelectPhrasesPsych);
              showRadioHostMessage(`${historyMessage} 🧠 Dr. Melody, memories flooding?`);
              showPsychiatristMessage(`${historyMessagePsych} ☀️ DJ Sunny, time travel vibes!`);
            }
          };
          historyList.appendChild(li);
        });
      }
    }

    function togglePopup(popupId, show) {
      document.getElementById(popupId).style.display = show ? 'block' : 'none';
      document.getElementById('popupOverlay').style.display = show ? 'block' : 'none';
    }

    document.getElementById('loadUrl').addEventListener('click', () => {
      if (isAuthenticated) {
        loadUrl();
      } else {
        togglePopup('authPopup', true);
      }
    });
    document.getElementById('playPauseBtn').addEventListener('click', () => {
      if (isAuthenticated) {
        if (player.getPlayerState() === YT.PlayerState.PLAYING) {
          player.pauseVideo();
          document.getElementById('playPauseBtn').textContent = 'Play 🍒🌸';
          const pauseMessage = getRandomPhrase(pausePhrases);
          const pauseMessagePsych = getRandomPhrase(pausePhrasesPsych);
          showRadioHostMessage(`${pauseMessage} 🧠 Dr. Melody, reflect now?`);
          showPsychiatristMessage(`${pauseMessagePsych} ☀️ DJ Sunny, break time!`);
        } else {
          player.playVideo();
          document.getElementById('playPauseBtn').textContent = 'Pause 🍒🌸';
          const playMessage = getRandomPhrase(playPhrases);
          const playMessagePsych = getRandomPhrase(playPhrasesPsych);
          showRadioHostMessage(`${playMessage} 🧠 Dr. Melody, feel the lift?`);
          showPsychiatristMessage(`${playMessagePsych} ☀️ DJ Sunny, let’s rock!`);
          userInitiatedPlayback = true;
        }
      } else {
        togglePopup('authPopup', true);
      }
    });
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (isAuthenticated) playPrevious();
      else togglePopup('authPopup', true);
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (isAuthenticated) playNext();
      else togglePopup('authPopup', true);
    });

    document.getElementById('loopBtn').addEventListener('click', () => {
      if (isAuthenticated) {
        isLooping = !isLooping;
        const loopBtn = document.getElementById('loopBtn');
        loopBtn.classList.toggle('active');
        const loopMessage = getRandomPhrase(loopPhrases);
        const loopMessagePsych = getRandomPhrase(loopPhrasesPsych);
        showRadioHostMessage(`${loopMessage} 🧠 Dr. Melody, too much repetition?`);
        showPsychiatristMessage(`${loopMessagePsych} ☀️ DJ Sunny, keep it looping!`);
      } else {
        togglePopup('authPopup', true);
      }
    });

    document.getElementById('shuffleBtn').addEventListener('click', () => {
      if (isAuthenticated) {
        isShuffling = !isShuffling;
        const shuffleBtn = document.getElementById('shuffleBtn');
        shuffleBtn.classList.toggle('active');
        const shuffleMessage = getRandomPhrase(shufflePhrases);
        const shuffleMessagePsych = getRandomPhrase(shufflePhrasesPsych);
        showRadioHostMessage(`${shuffleMessage} 🧠 Dr. Melody, chaos or calm?`);
        showPsychiatristMessage(`${shuffleMessagePsych} ☀️ DJ Sunny, mix it up!`);
      } else {
        togglePopup('authPopup', true);
      }
    });

    document.getElementById('profileBtn').addEventListener('click', () => {
      if (isAuthenticated) togglePopup('profilePopup', true);
      else togglePopup('authPopup', true);
    });
    document.getElementById('settingsBtn').addEventListener('click', () => {
      if (isAuthenticated) togglePopup('settingsPopup', true);
      else togglePopup('authPopup', true);
    });
    document.getElementById('pomodoroBtn').addEventListener('click', () => {
      if (isAuthenticated) {
        togglePopup('pomodoroPopup', true);
        showRadioHostMessage(`☀️ Productivity time, sunshine workers! DJ Sunny starts the Pomodoro—shine hard! 🧠 Dr. Melody, focus vibes?`, true);
        showPsychiatristMessage(`🧠 Pomodoro begins, proactive soul! Dr. Melody balances work with music—how’s your energy? ☀️ DJ Sunny, let’s hustle!`, true);
      } else {
        togglePopup('authPopup', true);
      }
    });
    document.getElementById('loginSignupBtn').addEventListener('click', () => {
      const token = localStorage.getItem('token');
      if (token) {
        localStorage.removeItem('token');
        updateAuthState(null);
      } else {
        togglePopup('authPopup', true);
      }
    });
    document.getElementById('closeAuth').addEventListener('click', () => togglePopup('authPopup', false));
    document.getElementById('closeProfile').addEventListener('click', () => togglePopup('profilePopup', false));
    document.getElementById('closeSettings').addEventListener('click', () => togglePopup('settingsPopup', false));
    document.getElementById('closePomodoro').addEventListener('click', () => togglePopup('pomodoroPopup', false));

    document.getElementById('toggleAuth').addEventListener('click', () => {
      isLoginMode = !isLoginMode;
      document.getElementById('authTitle').textContent = isLoginMode ? 'Login 🍒🌸' : 'Sign Up 🌸🍒';
      document.getElementById('toggleAuth').textContent = isLoginMode ? 'Switch to Sign Up 🍒🌸' : 'Switch to Login 🌸🍒';
      document.getElementById('submitAuth').textContent = isLoginMode ? 'Login 🍒🌸' : 'Sign Up 🌸🍒';
    });
    document.getElementById('submitAuth').addEventListener('click', () => {
      const username = document.getElementById('authUsername').value;
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      if (!username || !email || !password) {
        alert('Please enter username, email, and password.');
        return;
      }
      if (isLoginMode) {
        login(username, email, password);
      } else {
        signup(username, email, password);
      }
    });

    document.getElementById('signOutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      updateAuthState(null);
      togglePopup('profilePopup', false);
      showRadioHostMessage(`☀️ Farewell, sunshine VIP! DJ Sunny logs you out—return soon! 🧠 Dr. Melody, a reflective exit?`, true);
      showPsychiatristMessage(`🧠 Signing out, poignant! Dr. Melody hopes joy lingered—see you next time! ☀️ DJ Sunny, come back to party!`, true);
    });

    let pomodoroInterval;
    let isWork = true;
    let timeLeft = 25 * 60;

    function updatePomodoroDisplay() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      document.getElementById('pomodoroTime').textContent = `${min}:${sec < 10 ? '0' : ''}${sec} 🍒🌸`;
    }

    document.getElementById('pomodoroStart').addEventListener('click', () => {
      if (isAuthenticated) {
        if (!pomodoroInterval) {
          pomodoroInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft <= 0) {
              isWork = !isWork;
              timeLeft = (isWork ? document.getElementById('pomodoroWork').value : document.getElementById('pomodoroBreak').value) * 60;
              showRadioHostMessage(`☀️ Time’s up, productivity rays! DJ Sunny switches to ${isWork ? 'work' : 'break'}—shine on! 🧠 Dr. Melody, shift focus?`, true);
              showPsychiatristMessage(`🧠 Transitioning, refreshing! Dr. Melody supports ${isWork ? 'work' : 'break'}—music guides you! ☀️ DJ Sunny, keep the beat!`, true);
            }
            updatePomodoroDisplay();
          }, 1000);
          document.getElementById('pomodoroStart').textContent = 'Pause 🍒🌸';
          showRadioHostMessage(`☀️ Focus time, sunshine fans! DJ Sunny starts the Pomodoro—25 minutes of brilliance! 🧠 Dr. Melody, let’s harmonize!`, true);
          showPsychiatristMessage(`🧠 Pomodoro kicks off, motivated soul! Dr. Melody aligns focus with tunes—how’s your flow? ☀️ DJ Sunny, energize!`, true);
        } else {
          clearInterval(pomodoroInterval);
          pomodoroInterval = null;
          document.getElementById('pomodoroStart').textContent = 'Start 🍒🌸';
          showRadioHostMessage(`☀️ Break time, folks! DJ Sunny pauses the Pomodoro—rest those minds! 🧠 Dr. Melody, relax now?`, true);
          showPsychiatristMessage(`🧠 Pausing, wise choice! Dr. Melody encourages rest—how’s this break? ☀️ DJ Sunny, recharge!`, true);
        }
      } else {
        togglePopup('authPopup', true);
      }
    });

    document.getElementById('pomodoroReset').addEventListener('click', () => {
      if (isAuthenticated) {
        clearInterval(pomodoroInterval);
        pomodoroInterval = null;
        timeLeft = document.getElementById('pomodoroWork').value * 60;
        isWork = true;
        updatePomodoroDisplay();
        document.getElementById('pomodoroStart').textContent = 'Start 🍒🌸';
        showRadioHostMessage(`☀️ Reset, time travelers! DJ Sunny restarts the Pomodoro—fresh rays! 🧠 Dr. Melody, new cycle?`, true);
        showPsychiatristMessage(`🧠 Reset, grounding! Dr. Melody aligns this fresh start—music in sync? ☀️ DJ Sunny, let’s go!`, true);
      } else {
        togglePopup('authPopup', true);
      }
    });

    document.getElementById('hifiModeToggle').addEventListener('click', () => {
      if (isAuthenticated) {
        isHifiMode = document.getElementById('hifiModeToggle').checked;
        showRadioHostMessage(`☀️ Boosting sound, audiophiles! DJ Sunny flips HiFi to ${isHifiMode ? 'on' : 'off'}—crisp rays! 🧠 Dr. Melody, better resonance?`);
      }
    });

    document.getElementById('aiVolume').addEventListener('input', () => {
      if (isAuthenticated) {
        aiVolume = parseFloat(document.getElementById('aiVolume').value);
        showRadioHostMessage(`☀️ Tuning voices, sound wizards! DJ Sunny sets AI to ${Math.round(aiVolume * 100)}%—perfect! 🧠 Dr. Melody, clear enough?`);
      }
    });

    document.getElementById('bass').addEventListener('click', () => {
      if (isAuthenticated) {
        const value = document.getElementById('bass').value;
        showRadioHostMessage(`☀️ Thumping bass, beat rays! DJ Sunny dials it to ${value}—feel it! 🧠 Dr. Melody, deep enough?`);
      }
    });
    document.getElementById('mid').addEventListener('click', () => {
      if (isAuthenticated) {
        const value = document.getElementById('mid').value;
        showRadioHostMessage(`☀️ Tuning mids, harmony beams! DJ Sunny sets ${value}—balanced! 🧠 Dr. Melody, harmonious?`);
      }
    });
    document.getElementById('treble').addEventListener('click', () => {
      if (isAuthenticated) {
        const value = document.getElementById('treble').value;
        showRadioHostMessage(`☀️ Sizzling treble, high notes! DJ Sunny hits ${value}—clear! 🧠 Dr. Melody, sharp enough?`);
      }
    });

    function setupBackgroundPlayback() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      document.addEventListener('visibilitychange', () => {
        if (isAuthenticated) {
          if (document.hidden) {
            if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
              isBackgroundPlaying = true;
              startBackgroundAudio();
              showRadioHostMessage(`☀️ Background mode, sunshine squad! DJ Sunny keeps the beats alive! 🧠 Dr. Melody, soothing background?`);
            }
          } else {
            if (isBackgroundPlaying) {
              isBackgroundPlaying = false;
              stopBackgroundAudio();
              showRadioHostMessage(`☀️ Back in focus, music rays! DJ Sunny’s here! 🧠 Dr. Melody, welcome back—mood check?`);
            }
          }
        }
      });
    }

    function startBackgroundAudio() {
      if (isAuthenticated && audioSource) audioSource.disconnect();
      const stream = player.getInternalPlayer().getAudioTracks()[0];
      if (isAuthenticated && stream) {
        audioSource = audioContext.createMediaStreamSource(new MediaStream([stream]));
        const gainNode = audioContext.createGain();
        gainNode.gain.value = 1.0;
        audioSource.connect(gainNode);
        gainNode.connect(audioContext.destination);
        audioContext.resume();
      }
    }

    function stopBackgroundAudio() {
      if (isAuthenticated && audioSource) {
        audioSource.disconnect();
        audioSource = null;
      }
      if (isAuthenticated && audioContext) {
        audioContext.suspend();
      }
    }

    async function fetchVideoMetadata(videoId) {
      try {
        const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${API_KEY}`);
        const data = await response.json();
        if (data.items && data.items.length > 0) {
          return {
            title: data.items[0].snippet.title,
            channel: data.items[0].snippet.channelTitle,
            description: data.items[0].snippet.description,
            publishedAt: data.items[0].snippet.publishedAt
          };
        }
        return null;
      } catch (err) {
        console.error('Error fetching video metadata:', err);
        return null;
      }
    }

    async function calculateAdScore(videoId, duration, currentQuality) {
      const metadata = await fetchVideoMetadata(videoId);
      let score = 0;

      if (metadata) {
        const { title, channel, description } = metadata;
        const adPatterns = {
          title: /(sponsored|ad|promo|advertisement|commercial|trailer|teaser|presented by|brand|campaign|partner)/i,
          channel: /(google ads|doubleclick|admob|advertiser|marketing|promotions|sponsor|brand|official ad)/i,
          description: /(promoted|ad|shop now|sponsor|partner|buy now|click here|limited offer|deal|sale|discount)/i
        };

        if (adPatterns.title.test(title)) score += 0.4;
        if (adPatterns.channel.test(channel)) score += 0.3;
        if (adPatterns.description.test(description)) score += 0.3;

        if (Math.random() < 0.5) score += 0.1;

        if (duration > 0 && duration <= 30) score += 0.35;
      }

      const isShortVideo = duration > 0 && duration <= 120;
      if (isShortVideo) score += 0.3;

      const isFrequentTransition = stateHistory.length >= 2 && 
        (stateHistory[stateHistory.length - 1].time - stateHistory[stateHistory.length - 2].time) / 1000 < 5;
      if (isFrequentTransition) score += 0.2;

      const qualityLevels = ['tiny', 'small', 'medium', 'large', 'hd720', 'hd1080', 'highres'];
      const currentQualityIndex = qualityLevels.indexOf(currentQuality);
      const lastQualityIndex = qualityLevels.indexOf(lastPlaybackQuality);
      const isQualityDrop = lastQualityIndex > -1 && currentQualityIndex > -1 && currentQualityIndex < lastQualityIndex;
      if (isQualityDrop) score += 0.15;

      const expectedVideoId = currentIndex >= 0 && currentIndex < playlist.length ? playlist[currentIndex].id : null;
      const isUnexpectedVideo = videoId !== expectedVideoId && expectedVideoId !== null;
      if (isUnexpectedVideo) score += 0.25;

      if (!userInitiatedPlayback) score += 0.1;

      console.log(`Ad Score for videoId ${videoId}: ${score.toFixed(2)} - Metadata: ${JSON.stringify(metadata)}, Duration: ${duration}s, FrequentTransition: ${isFrequentTransition}, QualityDrop: ${isQualityDrop}, UnexpectedVideo: ${isUnexpectedVideo}, AutoPlay: ${!userInitiatedPlayback}`);

      return score;
    }

    async function isLikelyAd(videoId, duration, currentQuality) {
      const score = await calculateAdScore(videoId, duration, currentQuality);
      return score > 0.6 || (player.getPlayerState() === YT.PlayerState.PAUSED && duration <= 30);
    }

    function skipAd() {
      if (isAuthenticated && player && isAdSkippingEnabled && player.skipAd) {
        player.skipAd();
        const skipMessage = getRandomPhrase(adSkipPhrases);
        const skipMessagePsych = getRandomPhrase(adSkipPhrasesPsych);
        showRadioHostMessage(`${skipMessage} 🧠 Dr. Melody, ad-free peace?`);
        showPsychiatristMessage(`${skipMessagePsych} ☀️ DJ Sunny, back to the beat!`);
      }
    }

    function startAdSkipPolling() {
      if (adCheckInterval) clearInterval(adCheckInterval);
      adCheckInterval = setInterval(async () => {
        if (isAuthenticated && player && player.getPlayerState() !== null) {
          const currentVideoId = player.getVideoData()['video_id'];
          const duration = player.getDuration();
          const currentQuality = player.getPlaybackQuality();
          const currentState = player.getPlayerState();

          const isAd = await isLikelyAd(currentVideoId, duration, currentQuality);
          if (isAd && isAdSkippingEnabled) {
            skipAd();
          } else if (currentState === YT.PlayerState.PLAYING && lastStateChangeTime > 0 && 
                     (Date.now() - lastStateChangeTime) / 1000 < 5) {
            const rapidAdCheck = await isLikelyAd(currentVideoId, duration, currentQuality);
            if (rapidAdCheck) skipAd();
          }
        }
      }, 1000);
    }
  </script>
</body>
</html>