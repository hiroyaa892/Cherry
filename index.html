<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retro YouTube Music Player</title>
  <link href="./src/output.css" rel="stylesheet">
  <script src="https://www.youtube.com/iframe_api"></script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #f8c3c3;
      font-family: 'Press Start 2P', monospace;
      image-rendering: pixelated;
      margin: 0;
      padding: 15px;
    }
    .container {
      background-color: #d89393;
      border: 4px solid #c94b4b;
      border-radius: 16px;
      padding: 15px;
      max-width: 500px;
      margin: 0 auto;
      box-shadow: 4px 4px 0 #2d1a1a;
      position: relative;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .retro-button {
      background-color: #d89393;
      border: 2px solid #c94b4b;
      color: #2d1a1a;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }
    .retro-button::before {
      content: 'ğŸ’';
      position: absolute;
      left: -10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.4;
    }
    .retro-button::after {
      content: 'ğŸŒ¸';
      position: absolute;
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.4;
    }
    .retro-button:hover {
      background-color: #e6b8b8;
    }
    .input-section {
      text-align: center;
      margin-bottom: 15px;
    }
    input[type="text"] {
      background-color: #f8c3c3;
      border: 2px solid #c94b4b;
      border-radius: 8px;
      padding: 8px;
      font-size: 11px;
      width: 70%;
      margin-right: 8px;
    }
    .media-controls {
      text-align: center;
      margin-bottom: 15px;
    }
    .media-controls .buttons {
      margin-bottom: 8px;
    }
    .media-controls .seek-bar {
      width: 100%;
      margin-bottom: 8px;
    }
    input[type="range"] {
      -webkit-appearance: none;
      background: #c94b4b;
      border-radius: 4px;
      height: 10px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #d89393;
      border: 2px solid #c94b4b;
      border-radius: 50%;
      cursor: pointer;
    }
    .queue-history {
      margin-bottom: 8px;
    }
    .queue-history h2 {
      font-size: 12px;
      margin-bottom: 8px;
      position: relative;
    }
    .queue-history h2::after {
      content: ' ğŸ’ğŸŒ¸';
      position: absolute;
      right: 0;
    }
    .queue-history ul {
      list-style: none;
      padding: 0;
      max-height: 100px;
      overflow-y: auto;
      font-size: 9px;
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #d89393;
      padding: 20px;
      border: 4px solid #c94b4b;
      border-radius: 16px;
      box-shadow: 4px 4px 0 #2d1a1a;
      z-index: 1000;
    }
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .playing {
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% { opacity: 0.6; }
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #c94b4b;
      transition: 0.4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: #d89393;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #e6b8b8;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    .radio-host-bubble {
      position: fixed;
      bottom: 60px;
      right: 10px;
      background-color: #e6b8b8;
      border: 2px solid #c94b4b;
      border-radius: 12px;
      padding: 8px;
      font-size: 9px;
      max-width: 180px;
      text-align: left;
      box-shadow: 2px 2px 0 #2d1a1a;
      z-index: 1001;
      opacity: 0;
      display: none;
      transition: opacity 1s ease-in-out;
    }
    .radio-host-bubble.visible {
      opacity: 1;
      display: block;
    }
    .radio-host-bubble::before {
      content: '';
      position: absolute;
      top: 50%;
      left: -10px;
      transform: translateY(-50%);
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-right: 10px solid #c94b4b;
    }
    .psychiatrist-bubble {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background-color: #e6b8b8;
      border: 2px solid #c94b4b;
      border-radius: 12px;
      padding: 8px;
      font-size: 9px;
      max-width: 180px;
      text-align: left;
      box-shadow: 2px 2px 0 #2d1a1a;
      z-index: 1001;
      opacity: 0;
      display: none;
      transition: opacity 1s ease-in-out;
    }
    .psychiatrist-bubble.visible {
      opacity: 1;
      display: block;
    }
    .psychiatrist-bubble::before {
      content: '';
      position: absolute;
      top: 50%;
      left: -10px;
      transform: translateY(-50%);
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-right: 10px solid #c94b4b;
    }
    /* Responsive design for smaller screens */
    @media (max-width: 768px) {
      .radio-host-bubble {
        bottom: 80px;
        right: 5px;
        max-width: 250px;
      }
      .psychiatrist-bubble {
        bottom: 10px;
        right: 5px;
        max-width: 250px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top Bar -->
    <div class="top-bar">
      <button id="profileBtn" class="retro-button">Profile ğŸ’ğŸŒ¸</button>
      <button id="settingsBtn" class="retro-button">Settings ğŸ’ğŸŒ¸</button>
      <button id="pomodoroBtn" class="retro-button">Pomodoro ğŸ’ğŸŒ¸</button>
      <button id="loginSignupBtn" class="retro-button">Login ğŸ’ğŸŒ¸</button>
    </div>

    <!-- URL Input -->
    <div class="input-section">
      <input id="urlInput" type="text" placeholder="YouTube Playlist/Video ğŸ’ğŸŒ¸" class="retro-border">
      <button id="loadUrl" class="retro-button">Load ğŸ’ğŸŒ¸</button>
    </div>

    <!-- Player Controls -->
    <div id="player" class="hidden"></div>
    <div class="media-controls">
      <div id="currentSong" class="text-center mb-2 font-bold text-lg">No Track Loaded ğŸ’ğŸŒ¸</div>
      <div class="buttons">
        <button id="prevBtn" class="retro-button">Previous ğŸ’</button>
        <button id="playPauseBtn" class="retro-button">Play/Pause ğŸŒ¸</button>
        <button id="nextBtn" class="retro-button">Next ğŸ’</button>
      </div>
      <div class="seek-bar">
        <input type="range" id="seekSlider" min="0" max="100" value="0">
      </div>
    </div>

    <!-- Queue and History -->
    <div class="queue-history">
      <h2>Queue ğŸ’</h2>
      <ul id="queueList"></ul>
    </div>
    <div class="queue-history">
      <h2>History ğŸŒ¸</h2>
      <ul id="historyList"></ul>
    </div>
  </div>

  <!-- AI Chat Bubbles (Bottom Right) -->
  <div id="radioHostBubble" class="radio-host-bubble">ğŸµ Hello, music enthusiasts! Iâ€™m your dazzling DJ Sunny â˜€ï¸, here to spin the hottest tracks! Letâ€™s kick off this partyâ€”whatâ€™s your vibe today? ğŸ‰ğŸ’ğŸŒ¸</div>
  <div id="psychiatristBubble" class="psychiatrist-bubble">ğŸ§  Greetings, dear soul! Iâ€™m Dr. Melody, your musical therapist. Iâ€™m here to guide you through an emotional journey with these tunesâ€”how are you feeling right now? ğŸ’–ğŸ’ğŸŒ¸</div>

  <!-- Popups -->
  <div id="authPopup" class="popup">
    <h2 id="authTitle" class="text-center font-bold mb-3 text-sm">Login ğŸ’ğŸŒ¸</h2>
    <button id="toggleAuth" class="retro-button w-full mb-3">Switch to Sign Up ğŸ’ğŸŒ¸</button>
    <input id="authEmail" type="email" placeholder="Email ğŸ’ğŸŒ¸" class="w-full mb-3">
    <input id="authPassword" type="password" placeholder="Password ğŸŒ¸ğŸ’" class="w-full mb-3">
    <button id="submitAuth" class="retro-button w-full mb-3">Login ğŸ’ğŸŒ¸</button>
    <button id="closeAuth" class="retro-button w-full">Close ğŸŒ¸ğŸ’</button>
  </div>
  <div id="profilePopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Profile ğŸ’ğŸŒ¸</h2>
    <p class="mb-3">User: Guest ğŸ’ğŸŒ¸</p>
    <button id="signOutBtn" class="retro-button w-full mb-3">Sign Out ğŸ’ğŸŒ¸</button>
    <button id="closeProfile" class="retro-button w-full">Close ğŸŒ¸ğŸ’</button>
  </div>
  <div id="settingsPopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Settings ğŸ’ğŸŒ¸</h2>
    <h3 class="font-bold mb-3">Audio Settings ğŸ’ğŸŒ¸</h3>
    <div class="flex items-center mb-3">
      <label class="text-xs mr-3">Mute YouTube Ads ğŸ’ğŸŒ¸</label>
      <label class="toggle-switch">
        <input type="checkbox" id="muteAdToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="flex items-center mb-3">
      <label class="text-xs mr-3">HiFi Mode ğŸŒ¸ğŸ’</label>
      <label class="toggle-switch">
        <input type="checkbox" id="hifiModeToggle">
        <span class="slider"></span>
      </label>
    </div>
    <div class="flex items-center mb-3">
      <label class="text-xs mr-3">Voice for AI Bubbles ğŸ’ğŸŒ¸</label>
      <label class="toggle-switch">
        <input type="checkbox" id="voiceToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    <h3 class="font-bold mb-3">Equalizer ğŸ’ğŸŒ¸</h3>
    <div class="flex space-x-3 mb-3">
      <div>
        <label class="text-xs">Bass ğŸ’ğŸŒ¸</label>
        <input type="range" id="bass" min="-12" max="12" value="0" class="w-full">
      </div>
      <div>
        <label class="text-xs">Mid ğŸŒ¸ğŸ’</label>
        <input type="range" id="mid" min="-12" max="12" value="0" class="w-full">
      </div>
      <div>
        <label class="text-xs">Treble ğŸ’ğŸŒ¸</label>
        <input type="range" id="treble" min="-12" max="12" value="0" class="w-full">
      </div>
    </div>
    <button id="closeSettings" class="retro-button w-full">Close ğŸŒ¸ğŸ’</button>
  </div>
  <div id="pomodoroPopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Pomodoro Timer ğŸ’ğŸŒ¸</h2>
    <div id="pomodoroTime" class="text-center mb-3 text-sm">Work Session ğŸ’ğŸŒ¸</div>
    <div class="flex justify-center space-x-3 mb-3">
      <button id="pomodoroStart" class="retro-button">Start ğŸ’ğŸŒ¸</button>
      <button id="pomodoroReset" class="retro-button">Reset ğŸŒ¸ğŸ’</button>
    </div>
    <div class="flex flex-wrap gap-3">
      <label class="text-xs">Work (min): ğŸ’ğŸŒ¸</label>
      <input id="pomodoroWork" type="number" value="25" class="w-20 p-2">
      <label class="text-xs">Break (min): ğŸŒ¸ğŸ’</label>
      <input id="pomodoroBreak" type="number" value="5" class="w-20 p-2">
    </div>
    <button id="closePomodoro" class="retro-button mt-3 w-full">Close ğŸŒ¸ğŸ’</button>
  </div>
  <div id="popupOverlay" class="popup-overlay"></div>

  <script>
    let player;
    let playlist = [];
    let history = [];
    let currentIndex = -1;
    let isLooping = false;
    let isShuffling = false;
    let isLoginMode = true;
    let isAdMuted = true; // Enabled by default
    let isHifiMode = false;
    let isVoiceEnabled = true; // Voice enabled by default
    let isAdPlaying = false;
    let lastStateChangeTime = 0;
    let lastVideoId = null;
    let lastDuration = 0;
    let lastPlaybackQuality = '';
    let stateHistory = []; // Rolling window of last 3 states
    let userInitiatedPlayback = false; // Track user interaction
    const AD_DURATION_THRESHOLD = 60; // Ads can be up to 60 seconds (e.g., skippable)
    const STATE_WINDOW_SIZE = 3; // Track last 3 states
    const TRANSITION_THRESHOLD = 5; // Seconds for frequent transitions
    const API_KEY = 'AIzaSyBitewTBcoYxggjLlqbMm1qWhFatR6kvP8';
    const adPatterns = {
      title: /(sponsored|ad|promo|advertisement)/i,
      channel: /(google ads|doubleclick|admob)/i
    };
    let videoMetadataCache = {}; // Cache metadata to avoid repeated API calls
    const radioHostBubble = document.getElementById('radioHostBubble');
    const psychiatristBubble = document.getElementById('psychiatristBubble');
    const synth = window.speechSynthesis;
    let sunnyVoice, melodyVoice;

    // User behavior tracking for smarter AIs
    let userActions = {
      pauses: 0,
      skips: 0,
      equalizerChanges: 0,
      lastSong: null,
      lastAction: null
    };

    // Expanded phrase arrays for more talkative AIs
    const adDetectedPhrases = [
      `ğŸµ Oh no, an ad just crashed the party! DJ Sunny â˜€ï¸ is muting it faster than you can say "groove"â€”weâ€™re keeping this dance floor ad-free! Whatâ€™s your favorite beat to get back to? ğŸ‰ğŸ’ğŸŒ¸`,
      `ğŸµ Ad alert, my fabulous listeners! DJ Sunny â˜€ï¸ is on it, muting that interruption so we can keep the vibes high! Did you know ads often use catchy jingles to grab attention? Letâ€™s stick to our tunes! ğŸ’ƒğŸ’ğŸŒ¸`,
      `ğŸµ Not today, ads! DJ Sunny â˜€ï¸ mutes them to keep our musical journey smooth as silk! What kind of music gets you in the zoneâ€”pop, rock, or something chill? ğŸŒŸğŸ’ğŸŒ¸`,
      `ğŸµ An ad tried to sneak in, but DJ Sunny â˜€ï¸ says no way! Muting it now to protect our rhythm. Have you found a song that really speaks to you yet? ğŸ¸ğŸ’ğŸŒ¸`,
      `ğŸµ Ad incoming, but donâ€™t worry, your girl DJ Sunny â˜€ï¸ has got it covered! Muting it so we can keep rocking. Whatâ€™s the last song that made you dance like nobodyâ€™s watching? ğŸ•ºğŸ’ğŸŒ¸`,
      `ğŸµ Hold the beat, superstars! DJ Sunny â˜€ï¸ spots an ad and mutes itâ€”letâ€™s keep the music pure! Whatâ€™s the next track youâ€™re excited to hear? ğŸ§ğŸ’ğŸŒ¸`
    ];

    const adDetectedPhrasesPsych = [
      `ğŸ§  Oh my, an ad has interrupted our flow! Dr. Melody is muting it to preserve your musical sanctuary. How do these interruptions make you feel, dear listener? ğŸ§˜â€â™€ï¸ğŸ’ğŸŒ¸`,
      `ğŸ§  I sense an ad trying to disrupt our harmony! Dr. Melody mutes it to keep your emotional journey intact. What emotions are you hoping to explore with the next song? ğŸ’–ğŸ’ğŸŒ¸`,
      `ğŸ§  An ad has appeared, but Dr. Melody is here to mute it for you! Letâ€™s stay focused on the healing power of music. Have you noticed how certain songs lift your spirits? ğŸŒˆğŸ’ğŸŒ¸`,
      `ğŸ§  Not to worry, an ad has surfaced, but Dr. Melody mutes it to protect your vibe! What kind of music helps you unwind after a busy day? ğŸ•Šï¸ğŸ’ğŸŒ¸`,
      `ğŸ§  Oh, an ad interruption! Dr. Melody mutes it to ensure your musical therapy continues smoothly. How does this playlist reflect your current mood? ğŸŒ¿ğŸ’ğŸŒ¸`,
      `ğŸ§  An ad has popped up, but Dr. Melody is muting it to keep our session serene! What memories does the last song you heard bring to mind? ğŸŒŸğŸ’ğŸŒ¸`
    ];

    const adEndedPhrases = [
      `ğŸµ The adâ€™s gone, party people! DJ Sunny â˜€ï¸ unmutes the tunesâ€”letâ€™s get back to the beats that make us move! What song always gets you hyped up? ğŸ¶ğŸ’ğŸŒ¸`,
      `ğŸµ Ad break over, my musical friends! DJ Sunny â˜€ï¸ cranks the volume back upâ€”time to dive into the rhythm! Whatâ€™s your go-to genre for a mood boost? ğŸ”¥ğŸ’ğŸŒ¸`,
      `ğŸµ Weâ€™re ad-free again, groove masters! DJ Sunny â˜€ï¸ unmutes the magicâ€”letâ€™s keep this party rocking! Have you ever been to a concert that blew your mind? ğŸ¤ğŸ’ğŸŒ¸`,
      `ğŸµ Adâ€™s out, musicâ€™s in! DJ Sunny â˜€ï¸ unmutes the vibesâ€”back to our musical adventure! Whatâ€™s the most epic song in your playlist right now? ğŸ¸ğŸ’ğŸŒ¸`,
      `ğŸµ No more ads, just pure beats! DJ Sunny â˜€ï¸ unmutesâ€”letâ€™s get lost in the music! Whatâ€™s a song that always brings back great memories for you? ğŸ‰ğŸ’ğŸŒ¸`,
      `ğŸµ Ad-free at last, my friends! DJ Sunny â˜€ï¸ unmutes the tunesâ€”letâ€™s keep the good vibes rolling! Whatâ€™s the next song youâ€™d love to hear? ğŸŒŸğŸ’ğŸŒ¸`
    ];

    const adEndedPhrasesPsych = [
      `ğŸ§  The ad has passed, dear listener! Dr. Melody unmutes the musicâ€”letâ€™s return to the sounds that soothe your soul. How does this song make you feel right now? ğŸ’–ğŸ’ğŸŒ¸`,
      `ğŸ§  That ad is behind us now! Dr. Melody restores the melodyâ€”letâ€™s reconnect with your musical essence. What emotions does this track stir in you? ğŸŒˆğŸ’ğŸŒ¸`,
      `ğŸ§  Weâ€™re ad-free once more! Dr. Melody brings back the musicâ€”let these notes nurture your inner peace. Have you found a song that feels like a warm hug? ğŸ•Šï¸ğŸ’ğŸŒ¸`,
      `ğŸ§  The interruption is over! Dr. Melody unmutesâ€”immerse yourself in the healing power of your playlist. What kind of music helps you feel centered? ğŸŒ¿ğŸ’ğŸŒ¸`,
      `ğŸ§  Ad-free and serene again! Dr. Melody unmutes the tunesâ€”letâ€™s dive back into your emotional journey. Does this song resonate with your heart? ğŸŒŸğŸ’ğŸŒ¸`,
      `ğŸ§  The ad is gone, and Dr. Melody unmutes the music for you! Letâ€™s explore how this track speaks to your soul. What feelings are bubbling up as you listen? ğŸ’–ğŸ’ğŸŒ¸`
    ];

    // Play/Pause Phrases
    const playPhrasesSunny = [
      `ğŸµ Letâ€™s crank it up, my musical superstars! DJ Sunny â˜€ï¸ hits playâ€”feel the rhythm take over! Whatâ€™s your favorite lyric from this song? ğŸ¶ğŸ’ğŸŒ¸`,
      `ğŸµ The beat is back, party people! DJ Sunny â˜€ï¸ presses playâ€”letâ€™s get this dance floor shaking! Did you know this artist has a crazy backstory? Whoâ€™s your favorite band? ğŸ’ƒğŸ’ğŸŒ¸`,
      `ğŸµ Here we go, groove masters! DJ Sunny â˜€ï¸ hits playâ€”time to let the music move you! Whatâ€™s the best concert youâ€™ve ever been to? ğŸ¤ğŸ’ğŸŒ¸`,
      `ğŸµ Letâ€™s roll, my friends! DJ Sunny â˜€ï¸ plays the next trackâ€”get ready to vibe! Whatâ€™s a song that always makes you smile? ğŸ‰ğŸ’ğŸŒ¸`,
      `ğŸµ The partyâ€™s on, listeners! DJ Sunny â˜€ï¸ hits playâ€”letâ€™s dive into this musical magic! Whatâ€™s your go-to song for a road trip? ğŸš—ğŸ’ğŸŒ¸`,
      `ğŸµ Feel the beat, music lovers! DJ Sunny â˜€ï¸ presses playâ€”letâ€™s get lost in the rhythm! Whatâ€™s the last song that gave you chills? ğŸŒŸğŸ’ğŸŒ¸`
    ];

    const playPhrasesMelody = [
      `ğŸ§  The music resumes, dear listener! Dr. Melody senses your energy shiftingâ€”how does this song lift your spirits? What memories does it bring up? ğŸ’–ğŸ’ğŸŒ¸`,
      `ğŸ§  Weâ€™re back to the melody, my friend! Dr. Melody feels the rhythm soothing your soulâ€”how does this track make you feel? What emotions are you exploring today? ğŸŒˆğŸ’ğŸŒ¸`,
      `ğŸ§  The music flows again! Dr. Melody hopes this song brings you joyâ€”how does it resonate with your heart? Have you found a tune that feels like home? ğŸ•Šï¸ğŸ’ğŸŒ¸`,
      `ğŸ§  Letâ€™s dive back into the music! Dr. Melody senses a shift in your moodâ€”how does this song speak to you? What kind of music helps you relax? ğŸŒ¿ğŸ’ğŸŒ¸`,
      `ğŸ§  The melody returns, dear soul! Dr. Melody wondersâ€”how does this track connect with your emotions? Whatâ€™s a song that always calms your mind? ğŸŒŸğŸ’ğŸŒ¸`,
      `ğŸ§  Music is back, my friend! Dr. Melody feels the energyâ€”how does this song touch your heart? What feelings are you experiencing right now? ğŸ’–ğŸ’ğŸŒ¸`
    ];

    const pausePhrasesSunny = [
      `ğŸµ Taking a breather, my groove gurus! DJ Sunny â˜€ï¸ pauses the musicâ€”letâ€™s soak in the silence for a moment! Whatâ€™s your favorite chill activity to do during a break? ğŸ§˜â€â™€ï¸ğŸ’ğŸŒ¸`,
      `ğŸµ Hold the beat, party people! DJ Sunny â˜€ï¸ pauses the tunesâ€”time for a quick vibe check! Whatâ€™s the most relaxing song youâ€™ve ever heard? ğŸŒ™ğŸ’ğŸŒ¸`,
      `ğŸµ Letâ€™s pause the party, my friends! DJ Sunny â˜€ï¸ hits pauseâ€”enjoy the quiet for a sec! Whatâ€™s your go-to way to unwind after a long day? ğŸ›ğŸ’ğŸŒ¸`,
      `ğŸµ Break time, music lovers! DJ Sunny â˜€ï¸ pauses the trackâ€”letâ€™s take a moment to breathe! Whatâ€™s a song that always helps you reset? ğŸŒŸğŸ’ğŸŒ¸`,
      `ğŸµ Pausing the rhythm, superstars! DJ Sunny â˜€ï¸ gives you a moment to chillâ€”silence can be golden! Whatâ€™s your favorite way to relax with music? ğŸ§ğŸ’ğŸŒ¸`,
      `ğŸµ Letâ€™s hit pause, my fabulous listeners! DJ Sunny â˜€ï¸ stops the beatâ€”time for a quick breather! Whatâ€™s the last song that made you feel totally zen? ğŸ•Šï¸ğŸ’ğŸŒ¸`
    ];

    const pausePhrasesMelody = [
      `ğŸ§  A pause in the music, how intriguing! Dr. Melody wondersâ€”does this silence bring you calm or anticipation? How do you feel in this quiet moment? ğŸ§˜â€â™€ï¸ğŸ’ğŸŒ¸`,
      `ğŸ§  The music pauses, dear listener! Dr. Melody senses a moment of reflectionâ€”how does this break feel for you? What thoughts are coming up? ğŸŒ™ğŸ’ğŸŒ¸`,
      `ğŸ§  A brief silence, my friend! Dr. Melody hopes this pause brings you peaceâ€”how are you feeling right now? Whatâ€™s a memory this song evokes? ğŸ›ğŸ’ğŸŒ¸`,
      `ğŸ§  Letâ€™s take a pause, dear soul! Dr. Melody feels the calmâ€”how does this moment of quiet resonate with you? What emotions are surfacing? ğŸŒŸğŸ’ğŸŒ¸`,
      `ğŸ§  The music stops for a moment! Dr. Melody senses a shiftâ€”how does this silence affect your mood? Whatâ€™s a song that helps you find inner peace? ğŸ§ğŸ’ğŸŒ¸`,
      `ğŸ§  A pause in our journey, how grounding! Dr. Melody wondersâ€”how does this quiet feel for you? Whatâ€™s a melody that always soothes your soul? ğŸ•Šï¸ğŸ’ğŸŒ¸`
    ];

    // Next/Previous Phrases
    const nextPhrasesSunny = [
      `ğŸµ Onward we go, music maestros! DJ Sunny â˜€ï¸ cues the next trackâ€”letâ€™s keep the party pumping! Whatâ€™s your all-time favorite song to dance to? ğŸ’ƒğŸ’ğŸŒ¸`,
      `ğŸµ Next up, my groove gurus! DJ Sunny â˜€ï¸ spins the next tuneâ€”get ready to vibe! Whatâ€™s a song that always gets you moving? ğŸ¶ğŸ’ğŸŒ¸`,
      `ğŸµ Letâ€™s keep it rolling, party people! DJ Sunny â˜€ï¸ plays the next trackâ€”time to rock this beat! Whatâ€™s the best live performance youâ€™ve ever seen? ğŸ¤ğŸ’ğŸŒ¸`,
      `ğŸµ Moving forward, my friends! DJ Sunny â˜€ï¸ brings the next songâ€”letâ€™s keep the energy high! Whatâ€™s a track that always lifts your spirits? ğŸŒŸğŸ’ğŸŒ¸`,
      `ğŸµ Next track, superstars! DJ Sunny â˜€ï¸ keeps the rhythm flowingâ€”letâ€™s dive into this beat! Whatâ€™s a song that reminds you of a great memory? ğŸ‰ğŸ’ğŸŒ¸`,
      `ğŸµ On to the next, music lovers! DJ Sunny â˜€ï¸ spins a fresh tuneâ€”letâ€™s get lost in the music! Whatâ€™s a song youâ€™d love to hear live someday? ğŸ¸ğŸ’ğŸŒ¸`
    ];

    const nextPhrasesMelody = [
      `ğŸ§  Moving to the next song, dear listener! Dr. Melody hopes this track brings a new layer of joyâ€”how does it make you feel? What emotions are you noticing? ğŸ’–ğŸ’ğŸŒ¸`,
      `ğŸ§  The next track begins, my friend! Dr. Melody senses a shiftâ€”how does this song resonate with your heart? What memories does it bring up? ğŸŒˆğŸ’ğŸŒ¸`,
      `ğŸ§  A new song, how delightful! Dr. Melody feels the energyâ€”how does this track speak to your soul? Have you found a melody that feels like a warm embrace? ğŸ•Šï¸ğŸ’ğŸŒ¸`,
      `ğŸ§  Letâ€™s explore the next tune, dear soul! Dr. Melody wondersâ€”how does this song connect with your emotions? What kind of music helps you feel grounded? ğŸŒ¿ğŸ’ğŸŒ¸`,
      `ğŸ§  The next track plays, my friend! Dr. Melody senses a new vibeâ€”how does this song touch your heart? What feelings are you experiencing now? ğŸŒŸğŸ’ğŸŒ¸`,
      `ğŸ§  A fresh song begins! Dr. Melody hopes it brings you peaceâ€”how does this track feel for you? Whatâ€™s a melody that always calms your mind? ğŸ’–ğŸ’ğŸŒ¸`
    ];

    const prevPhrasesSunny = [
      `ğŸµ Back we go, my musical time travelers! DJ Sunny â˜€ï¸ rewinds to the previous gemâ€”letâ€™s relive this magic! Whatâ€™s a song that always takes you back to a special moment? ğŸ•°ï¸ğŸ’ğŸŒ¸`,
      `ğŸµ Letâ€™s rewind, groove masters! DJ Sunny â˜€ï¸ spins the previous trackâ€”time to revisit this beat! Whatâ€™s your favorite throwback song of all time? ğŸ¶ğŸ’ğŸŒ¸`,
      `ğŸµ Going back, party people! DJ Sunny â˜€ï¸ plays the last trackâ€”letâ€™s enjoy this blast from the past! Whatâ€™s a song that reminds you of your childhood? ğŸ‰ğŸ’ğŸŒ¸`,
      `ğŸµ Rewinding the vibes, my friends! DJ Sunny â˜€ï¸ brings back the previous tuneâ€”letâ€™s groove again! Whatâ€™s a track that always makes you nostalgic? ğŸŒŸğŸ’ğŸŒ¸`,
      `ğŸµ Back in time, superstars! DJ Sunny â˜€ï¸ spins the last songâ€”letâ€™s relive the magic! Whatâ€™s a song that brings back a flood of memories? ğŸ¸ğŸ’ğŸŒ¸`,
      `ğŸµ Letâ€™s go back, music lovers! DJ Sunny â˜€ï¸ plays the previous trackâ€”time for a nostalgic vibe! Whatâ€™s a song that always takes you down memory lane? ğŸ•ºğŸ’ğŸŒ¸`
    ];

    const prevPhrasesMelody = [
      `ğŸ§  A step back in your musical journey, dear listener! Dr. Melody senses nostalgiaâ€”does this song hold special memories for you? How does it make you feel? ğŸ•°ï¸ğŸ’ğŸŒ¸`,
      `ğŸ§  Revisiting the previous track, my friend! Dr. Melody feels the memoriesâ€”how does this song resonate with you now? What emotions are coming up? ğŸ¶ğŸ’ğŸŒ¸`,
      `ğŸ§  Back to the last song, how nostalgic! Dr. Melody wondersâ€”what does this track remind you of? Have you noticed how music can transport you to another time? ğŸ‰ğŸ’ğŸŒ¸`,
      `ğŸ§  A return to the previous tune, dear soul! Dr. Melody senses a wave of emotionâ€”how does this song feel now compared to before? What memories does it evoke? ğŸŒŸğŸ’ğŸŒ¸`,
      `ğŸ§  Letâ€™s revisit the last track, my friend! Dr. Melody feels the nostalgiaâ€”how does this song speak to your heart? Whatâ€™s a memory it brings to mind? ğŸ¸ğŸ’ğŸŒ¸`,
      `ğŸ§  Back to the previous song, how grounding! Dr. Melody wondersâ€”how does this track make you feel now? Whatâ€™s a song that always brings you comfort? ğŸ•ºğŸ’ğŸŒ¸`
    ];

    // Initialize voices for the AIs
    function initializeVoices() {
      const voices = synth.getVoices();
      // Select a female voice for DJ Sunny â˜€ï¸ (prefer Google US English Female)
      sunnyVoice = voices.find(voice => voice.name.includes('Google US English Female')) || 
                   voices.find(voice => voice.gender === 'female') || 
                   voices[0];
      // Select a different female voice for Dr. Melody (prefer Google UK English Female)
      melodyVoice = voices.find(voice => voice.name.includes('Google UK English Female') && voice.name !== sunnyVoice.name) || 
                    voices.find(voice => voice.gender === 'female' && voice.name !== sunnyVoice.name) || 
                    voices[1] || 
                    voices[0];
      // Ensure voices are different
      if (sunnyVoice.name === melodyVoice.name && voices.length > 1) {
        melodyVoice = voices.find(voice => voice.name !== sunnyVoice.name) || voices[1];
      }
      // Log selected voices for debugging
      console.log('DJ Sunny Voice:', sunnyVoice?.name);
      console.log('Dr. Melody Voice:', melodyVoice?.name);
    }

    // Ensure voices are loaded (some browsers need this)
    if (synth.getVoices().length > 0) {
      initializeVoices();
    } else {
      synth.onvoiceschanged = initializeVoices;
    }

    function showRadioHostMessage(message, followUp = true) {
      radioHostBubble.textContent = message;
      radioHostBubble.classList.add('visible');
      if (isVoiceEnabled) {
        speakMessage(radioHostBubble.textContent, 'sunny');
      }
      setTimeout(() => {
        radioHostBubble.classList.remove('visible');
      }, 10000); // Hide after 10 seconds
      // Dr. Melody responds to DJ Sunny â˜€ï¸
      if (followUp) {
        setTimeout(() => {
          const melodyResponse = `ğŸ§  Oh, I love your energy, DJ Sunny â˜€ï¸! Letâ€™s dive deeper into that vibeâ€”what emotions does this moment spark for you, dear listener? ğŸ’–ğŸ’ğŸŒ¸`;
          showPsychiatristMessage(melodyResponse, false);
        }, 2000); // Delay Dr. Melody's response by 2 seconds
      }
    }

    function showPsychiatristMessage(message, followUp = true) {
      psychiatristBubble.textContent = message;
      psychiatristBubble.classList.add('visible');
      if (isVoiceEnabled) {
        speakMessage(psychiatristBubble.textContent, 'melody');
      }
      setTimeout(() => {
        psychiatristBubble.classList.remove('visible');
      }, 10000); // Hide after 10 seconds
      // DJ Sunny â˜€ï¸ responds to Dr. Melody
      if (followUp) {
        setTimeout(() => {
          const sunnyResponse = `ğŸµ Dr. Melody, youâ€™re always so deep, I love it! Letâ€™s keep the party goingâ€”how about a song that makes you dance, listener? ğŸ‰ğŸ’ğŸŒ¸`;
          showRadioHostMessage(sunnyResponse, false);
        }, 2000); // Delay DJ Sunny â˜€ï¸'s response by 2 seconds
      }
    }

    function speakMessage(message, ai) {
      // Cancel any ongoing speech to prevent overlap
      synth.cancel();
      const utterance = new SpeechSynthesisUtterance(message); // Read the bubble content directly
      if (ai === 'sunny') {
        utterance.voice = sunnyVoice;
        utterance.pitch = 1.4; // Higher pitch for lively female tone
        utterance.rate = 1.2; // Slightly faster for energetic vibe
      } else {
        utterance.voice = melodyVoice;
        utterance.pitch = 0.8; // Lower pitch for soothing female tone
        utterance.rate = 0.9; // Slower for calm vibe
      }
      synth.speak(utterance);
    }

    function getRandomPhrase(phrases) {
      return phrases[Math.floor(Math.random() * phrases.length)];
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '0',
        width: '0',
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onPlaybackQualityChange': onPlaybackQualityChange
        }
      });
      showRadioHostMessage('ğŸµ Hello, music enthusiasts! Iâ€™m your dazzling DJ Sunny â˜€ï¸, here to spin the hottest tracks! Letâ€™s kick off this partyâ€”whatâ€™s your vibe today? ğŸ‰ğŸ’ğŸŒ¸');
      showPsychiatristMessage('ğŸ§  Greetings, dear soul! Iâ€™m Dr. Melody, your musical therapist. Iâ€™m here to guide you through an emotional journey with these tunesâ€”how are you feeling right now? ğŸ’–ğŸ’ğŸŒ¸');
    }

    function onPlayerReady(event) {
      document.getElementById('seekSlider').addEventListener('input', () => {
        const seekTo = (document.getElementById('seekSlider').value / 100) * player.getDuration();
        player.seekTo(seekTo);
        showRadioHostMessage(`ğŸµ Adjusting the track, my savvy listener! DJ Sunny â˜€ï¸ loves how youâ€™re taking controlâ€”where in the song do you love to jump to? ğŸ¶ğŸ’ğŸŒ¸`);
        showPsychiatristMessage(`ğŸ§  Seeking through the song, how thoughtful! Dr. Melody wondersâ€”what part of this track speaks to your heart the most? ğŸ’–ğŸ’ğŸŒ¸`);
      });
      updateSeekSlider();
      if (isAdMuted && isAdPlaying) {
        player.mute();
      }
    }

    function onPlaybackQualityChange(event) {
      const currentQuality = event.data;
      if (lastPlaybackQuality && currentQuality !== lastPlaybackQuality) {
        console.log(`Playback quality changed: ${lastPlaybackQuality} -> ${currentQuality}`);
        showRadioHostMessage(`ğŸµ Whoa, the quality just changed to ${currentQuality}, audiophiles! DJ Sunny â˜€ï¸ loves a crisp soundâ€”howâ€™s it sounding on your end? ğŸ§ğŸ’ğŸŒ¸`);
        showPsychiatristMessage(`ğŸ§  A shift in playback quality, how interesting! Dr. Melody senses a clearer vibeâ€”does this enhance your listening experience? ğŸŒŸğŸ’ğŸŒ¸`);
      }
      lastPlaybackQuality = currentQuality;
    }

    async function fetchVideoMetadata(videoId) {
      if (videoMetadataCache[videoId]) {
        return videoMetadataCache[videoId];
      }
      try {
        const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${API_KEY}`);
        const data = await response.json();
        if (data.items && data.items.length > 0) {
          const metadata = {
            title: data.items[0].snippet.title,
            channel: data.items[0].snippet.channelTitle
          };
          videoMetadataCache[videoId] = metadata;
          return metadata;
        }
        return null;
      } catch (err) {
        console.error('Error fetching video metadata:', err);
        return null;
      }
    }

    async function isLikelyAd(videoId, duration) {
      const metadata = await fetchVideoMetadata(videoId);
      if (!metadata) return false;

      const { title, channel } = metadata;
      const isShortVideo = duration > 0 && duration <= AD_DURATION_THRESHOLD;
      const hasAdKeywords = adPatterns.title.test(title) || adPatterns.channel.test(channel);

      console.log(`Metadata check - Title: ${title}, Channel: ${channel}, Duration: ${duration}s, IsShortVideo: ${isShortVideo}, HasAdKeywords: ${hasAdKeywords}`);

      return hasAdKeywords || isShortVideo;
    }

    function onPlayerStateChange(event) {
      const currentTime = Date.now();
      const state = event.data;
      const currentVideoId = player.getVideoData()['video_id'];
      const duration = player.getDuration();

      // Update state history (rolling window of last 3 states)
      stateHistory.push({ state, time: currentTime });
      if (stateHistory.length > STATE_WINDOW_SIZE) {
        stateHistory.shift();
      }

      // Analyze state transitions
      const isFrequentTransition = stateHistory.length >= 2 && 
        (currentTime - stateHistory[stateHistory.length - 2].time) / 1000 < TRANSITION_THRESHOLD;
      const isAdLikeTransition = stateHistory.some(s => s.state === YT.PlayerState.PAUSED) && 
        stateHistory.some(s => s.state === YT.PlayerState.PLAYING) && 
        state === YT.PlayerState.PLAYING;

      // Check playback quality change
      const isQualityChange = lastPlaybackQuality && player.getPlaybackQuality() !== lastPlaybackQuality;

      // Check if playback was user-initiated
      const isAutoPlay = !userInitiatedPlayback;

      // Determine if this is likely an ad
      const detectAd = async () => {
        const isShortVideo = duration > 0 && duration <= AD_DURATION_THRESHOLD;
        const isMetadataAd = await isLikelyAd(currentVideoId, duration);
        const isLikelyAdPlayback = (isShortVideo || isFrequentTransition || isAdLikeTransition || isQualityChange) && isAutoPlay;

        console.log(`Ad Detection - VideoID: ${currentVideoId}, Duration: ${duration}s, IsShortVideo: ${isShortVideo}, FrequentTransition: ${isFrequentTransition}, AdLikeTransition: ${isAdLikeTransition}, QualityChange: ${isQualityChange}, AutoPlay: ${isAutoPlay}, MetadataAd: ${isMetadataAd}`);

        return isMetadataAd || isLikelyAdPlayback;
      };

      // Update ad playing state
      detectAd().then(isAd => {
        if (currentVideoId !== lastVideoId) {
          if (isAd) {
            isAdPlaying = true;
            if (isAdMuted) {
              player.mute();
              const randomAdPhrase = getRandomPhrase(adDetectedPhrases);
              const randomAdPhrasePsych = getRandomPhrase(adDetectedPhrasesPsych);
              showRadioHostMessage(randomAdPhrase);
              showPsychiatristMessage(randomAdPhrasePsych);
            }
          } else {
            if (isAdPlaying) {
              isAdPlaying = false;
              if (isAdMuted) {
                player.unMute();
                const randomAdEndPhrase = getRandomPhrase(adEndedPhrases);
                const randomAdEndPhrasePsych = getRandomPhrase(adEndedPhrasesPsych);
                showRadioHostMessage(randomAdEndPhrase);
                showPsychiatristMessage(randomAdEndPhrasePsych);
              }
            }
          }
        }

        // Reset user-initiated flag after detection
        userInitiatedPlayback = false;
      });

      // Update tracking variables
      lastStateChangeTime = currentTime;
      lastVideoId = currentVideoId;
      lastDuration = duration;

      // Handle video end for playlist navigation
      if (state === YT.PlayerState.ENDED) {
        if (isLooping && currentIndex >= 0) {
          player.loadVideoById(playlist[currentIndex].id);
          showRadioHostMessage(`ğŸµ Looping this gem, my musical friends! DJ Sunny â˜€ï¸ loves how much you adore ${playlist[currentIndex].title}! Whatâ€™s your favorite part of this song? ğŸ”„ğŸ’ğŸŒ¸`);
          showPsychiatristMessage(`ğŸ§  Looping the same track, how fascinating! Dr. Melody senses a deep connectionâ€”does this song hold a special meaning for you? ğŸ’–ğŸ’ğŸŒ¸`);
        } else {
          playNext();
        }
      }
    }

    function updateSeekSlider() {
      if (player && player.getCurrentTime) {
        const current = player.getCurrentTime();
        const duration = player.getDuration();
        document.getElementById('seekSlider').value = (current / duration) * 100 || 0;
        setTimeout(updateSeekSlider, 1000);
      }
    }

    function loadUrl() {
      const url = document.getElementById('urlInput').value;
      const playlistId = url.match(/list=([a-zA-Z0-9_-]+)/)?.[1];
      if (playlistId) {
        fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${API_KEY}`)
          .then(response => response.json())
          .then(data => {
            playlist = data.items.map(item => ({
              id: item.snippet.resourceId.videoId,
              title: item.snippet.title
            }));
            updateQueue();
            if (playlist.length > 0) {
              currentIndex = 0;
              userInitiatedPlayback = true; // User initiated
              playSong();
              showRadioHostMessage(`ğŸµ Oh, what a treat, my fabulous listeners! DJ Sunny â˜€ï¸ is loading a playlist with ${playlist.length} songsâ€”letâ€™s dive into this musical masterpiece! What inspired this choice? ğŸ‰ğŸ’ğŸŒ¸`);
              showPsychiatristMessage(`ğŸ§  A playlist with ${playlist.length} tracks, how wonderful! Dr. Melody senses this selection reflects your moodâ€”does this mix feel energizing or calming to you? ğŸ’–ğŸ’ğŸŒ¸`);
            }
          })
          .catch(err => alert('Error loading playlist. Please check the URL or API key.'));
      } else {
        const videoId = url.match(/(?:v=)([a-zA-Z0-9_-]+)/)?.[1];
        if (videoId) {
          fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${API_KEY}`)
            .then(response => response.json())
            .then(data => {
              if (data.items.length > 0) {
                playlist.push({
                  id: videoId,
                  title: data.items[0].snippet.title
                });
                updateQueue();
                if (currentIndex === -1) {
                  currentIndex = 0;
                  userInitiatedPlayback = true; // User initiated
                  playSong();
                  showRadioHostMessage(`ğŸµ Fantastic pick, party people! DJ Sunny â˜€ï¸ is spinning ${data.items[0].snippet.title}â€”get ready for a sonic adventure! What made you choose this track? ğŸ¶ğŸ’ğŸŒ¸`);
                  showPsychiatristMessage(`ğŸ§  A single track, ${data.items[0].snippet.title}, how intriguing! Dr. Melody wondersâ€”what emotions does this song stir in you? Does it bring back any memories? ğŸ’–ğŸ’ğŸŒ¸`);
                }
              } else {
                alert('Invalid video URL');
              }
            });
        } else {
          alert('Invalid URL');
        }
      }
      userActions.lastAction = 'load';
    }

    function playSong() {
      if (currentIndex >= 0 && currentIndex < playlist.length) {
        player.loadVideoById(playlist[currentIndex].id);
        document.getElementById('currentSong').textContent = playlist[currentIndex].title || 'No Track Loaded ğŸ’ğŸŒ¸';
        document.getElementById('currentSong').classList.add('playing');
        if (!history.includes(playlist[currentIndex])) {
          history.push(playlist[currentIndex]);
          updateHistory();
        }
        userActions.lastSong = playlist[currentIndex].title;
        showRadioHostMessage(`ğŸµ Now playing ${playlist[currentIndex].title}, my groove gurus! DJ Sunny â˜€ï¸ loves this vibeâ€”does this song get you dancing or singing along? ğŸ’ƒğŸ’ğŸŒ¸`);
        showPsychiatristMessage(`ğŸ§  Weâ€™re listening to ${playlist[currentIndex].title}, dear listener! Dr. Melody feels its energyâ€”how does this track make you feel? Does it spark any emotions? ğŸ’–ğŸ’ğŸŒ¸`);
      }
    }

    function playNext() {
      if (isShuffling) {
        currentIndex = Math.floor(Math.random() * playlist.length);
      } else {
        currentIndex = (currentIndex + 1) % playlist.length;
      }
      userInitiatedPlayback = true; // User initiated
      userActions.skips++;
      userActions.lastAction = 'next';
      playSong();
      if (userActions.skips > 2) {
        showRadioHostMessage(`ğŸµ Youâ€™re quite the skipper, my friend! DJ Sunny â˜€ï¸ notices youâ€™ve skipped ${userActions.skips} timesâ€”looking for a perfect vibe? Whatâ€™s your dream song right now? ğŸ¶ğŸ’ğŸŒ¸`);
        showPsychiatristMessage(`ğŸ§  I see youâ€™ve skipped ${userActions.skips} tracks, dear listener! Dr. Melody wondersâ€”are you searching for a specific feeling? What kind of music are you craving? ğŸ’–ğŸ’ğŸŒ¸`);
      } else {
        showRadioHostMessage(getRandomPhrase(nextPhrasesSunny));
        showPsychiatristMessage(getRandomPhrase(nextPhrasesMelody));
      }
    }

    function playPrevious() {
      currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
      userInitiatedPlayback = true; // User initiated
      userActions.skips++;
      userActions.lastAction = 'previous';
      playSong();
      if (userActions.skips > 2) {
        showRadioHostMessage(`ğŸµ Youâ€™re loving the rewind, my time traveler! DJ Sunny â˜€ï¸ sees youâ€™ve skipped ${userActions.skips} timesâ€”chasing a nostalgic vibe? Whatâ€™s a song that takes you back? ğŸ•°ï¸ğŸ’ğŸŒ¸`);
        showPsychiatristMessage(`ğŸ§  Youâ€™ve skipped ${userActions.skips} tracks, dear listener! Dr. Melody senses a longing for the pastâ€”are you revisiting a special memory? What does this song mean to you? ğŸ’–ğŸ’ğŸŒ¸`);
      } else {
        showRadioHostMessage(getRandomPhrase(prevPhrasesSunny));
        showPsychiatristMessage(getRandomPhrase(prevPhrasesMelody));
      }
    }

    function updateQueue() {
      const queueList = document.getElementById('queueList');
      queueList.innerHTML = '';
      playlist.forEach((song, index) => {
        const li = document.createElement('li');
        li.textContent = `ğŸ’ ${song.title} ğŸŒ¸`;
        li.className = 'cursor-pointer hover:bg-pink-200';
        li.onclick = () => {
          currentIndex = index;
          userInitiatedPlayback = true; // User initiated
          userActions.lastAction = 'queue';
          playSong();
          showRadioHostMessage(`ğŸµ Brilliant choice from the queue, my musical genius! DJ Sunny â˜€ï¸ is now playing ${song.title}â€”what made you pick this gem? ğŸ¶ğŸ’ğŸŒ¸`);
          showPsychiatristMessage(`ğŸ§  A thoughtful selection from the queue, ${song.title}! Dr. Melody is curiousâ€”what drew you to this song today? How does it make you feel? ğŸ’–ğŸ’ğŸŒ¸`);
        };
        queueList.appendChild(li);
      });
    }

    function updateHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      history.forEach((song, index) => {
        const li = document.createElement('li');
        li.textContent = `ğŸŒ¸ ${song.title} ğŸ’`;
        li.className = 'cursor-pointer hover:bg-pink-200';
        li.onclick = () => {
          currentIndex = playlist.findIndex(s => s.id === song.id);
          if (currentIndex !== -1) {
            userInitiatedPlayback = true; // User initiated
            userActions.lastAction = 'history';
            playSong();
            showRadioHostMessage(`ğŸµ Nostalgia alert, my fabulous listeners! DJ Sunny â˜€ï¸ is replaying ${song.title} from your historyâ€”pure auditory bliss! Whatâ€™s your favorite memory tied to this song? ğŸ‰ğŸ’ğŸŒ¸`);
            showPsychiatristMessage(`ğŸ§  Revisiting ${song.title} from your history, how special! Dr. Melody wondersâ€”what emotions does this song bring back for you? Does it feel different this time? ğŸ’–ğŸ’ğŸŒ¸`);
          }
        };
        historyList.appendChild(li);
      });
    }

    function togglePopup(popupId, show) {
      document.getElementById(popupId).style.display = show ? 'block' : 'none';
      document.getElementById('popupOverlay').style.display = show ? 'block' : 'none';
    }

    // Event Listeners
    document.getElementById('loadUrl').addEventListener('click', loadUrl);
    document.getElementById('playPauseBtn').addEventListener('click', () => {
      if (player.getPlayerState() === YT.PlayerState.PLAYING) {
        player.pauseVideo();
        document.getElementById('playPauseBtn').textContent = 'Play ğŸ’ğŸŒ¸';
        userActions.pauses++;
        userActions.lastAction = 'pause';
        if (userActions.pauses > 2) {
          showRadioHostMessage(`ğŸµ Youâ€™re a fan of pauses, arenâ€™t you? DJ Sunny â˜€ï¸ notices youâ€™ve paused ${userActions.pauses} timesâ€”needing a breather? Whatâ€™s your favorite way to relax during a break? ğŸ§˜â€â™€ï¸ğŸ’ğŸŒ¸`);
          showPsychiatristMessage(`ğŸ§  I see youâ€™ve paused ${userActions.pauses} times, dear listener! Dr. Melody senses youâ€™re taking your timeâ€”how does this moment of stillness feel for you? Whatâ€™s on your mind? ğŸ’–ğŸ’ğŸŒ¸`);
        } else {
          showRadioHostMessage(getRandomPhrase(pausePhrasesSunny));
          showPsychiatristMessage(getRandomPhrase(pausePhrasesMelody));
        }
      } else {
        player.playVideo();
        document.getElementById('playPauseBtn').textContent = 'Pause ğŸ’ğŸŒ¸';
        userActions.lastAction = 'play';
        showRadioHostMessage(getRandomPhrase(playPhrasesSunny));
        showPsychiatristMessage(getRandomPhrase(playPhrasesMelody));
        userInitiatedPlayback = true; // User initiated
      }
    });
    document.getElementById('prevBtn').addEventListener('click', playPrevious);
    document.getElementById('nextBtn').addEventListener('click', playNext);

    // Popup Controls
    document.getElementById('profileBtn').addEventListener('click', () => {
      togglePopup('profilePopup', true);
      userActions.lastAction = 'profile';
      showRadioHostMessage(`ğŸµ Step into the spotlight, my VIP listener! DJ Sunny â˜€ï¸ opens your Profileâ€”look at all the tunes youâ€™ve loved! Whatâ€™s been your favorite song lately? ğŸ‰ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  Exploring your profile, how exciting! Dr. Melody is here to reflectâ€”how does seeing your musical journey make you feel? What track has meant the most to you? ğŸ’–ğŸ’ğŸŒ¸`);
    });
    document.getElementById('settingsBtn').addEventListener('click', () => {
      togglePopup('settingsPopup', true);
      userActions.lastAction = 'settings';
      showRadioHostMessage(`ğŸµ Time to tweak the vibes, my audio wizards! DJ Sunny â˜€ï¸ unveils Settingsâ€”letâ€™s fine-tune your experience! Whatâ€™s your favorite audio setting to play with? ğŸ§ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  Adjusting your settings, how empowering! Dr. Melody senses youâ€™re taking controlâ€”how does customizing this experience align with your mood today? ğŸ’–ğŸ’ğŸŒ¸`);
    });
    document.getElementById('pomodoroBtn').addEventListener('click', () => {
      togglePopup('pomodoroPopup', true);
      userActions.lastAction = 'pomodoro';
      showRadioHostMessage(`ğŸµ Productivity time, my musical maestros! DJ Sunny â˜€ï¸ starts the Pomodoro timerâ€”letâ€™s work hard and groove harder! Whatâ€™s your favorite focus song? ğŸ“šğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  A Pomodoro timer, how proactive! Dr. Melody supports your focusâ€”letâ€™s balance productivity with the soothing power of music. What helps you stay motivated? ğŸ’–ğŸ’ğŸŒ¸`);
    });
    document.getElementById('loginSignupBtn').addEventListener('click', () => {
      togglePopup('authPopup', true);
      userActions.lastAction = 'login';
      showRadioHostMessage(`ğŸµ Welcome aboard, my new musical friends! DJ Sunny â˜€ï¸ opens the Login/Sign-up portalâ€”join the party! What kind of music are you excited to explore with us? ğŸ‰ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  Joining our community, how wonderful! Dr. Melody welcomes youâ€”how does becoming part of this musical space feel for you? What tunes are you looking forward to? ğŸ’–ğŸ’ğŸŒ¸`);
    });
    document.getElementById('closeAuth').addEventListener('click', () => {
      togglePopup('authPopup', false);
      showRadioHostMessage(`ğŸµ Closing the login portal, my friends! DJ Sunny â˜€ï¸ hopes youâ€™ll join us soonâ€”letâ€™s keep the music playing! Whatâ€™s your next musical adventure? ğŸ¶ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  Stepping back from login, I see! Dr. Melody hopes you feel welcomeâ€”how can we make your musical journey even better? ğŸ’–ğŸ’ğŸŒ¸`);
    });
    document.getElementById('closeProfile').addEventListener('click', () => {
      togglePopup('profilePopup', false);
      showRadioHostMessage(`ğŸµ Closing your profile, my VIP! DJ Sunny â˜€ï¸ loved showing off your statsâ€”letâ€™s keep rocking those tunes! Whatâ€™s next on your playlist? ğŸ‰ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  Leaving your profile, dear listener! Dr. Melody hopes you feel proud of your journeyâ€”how has music shaped your emotions lately? ğŸ’–ğŸ’ğŸŒ¸`);
    });
    document.getElementById('closeSettings').addEventListener('click', () => {
      togglePopup('settingsPopup', false);
      showRadioHostMessage(`ğŸµ Settings saved, my audio experts! DJ Sunny â˜€ï¸ closes the panelâ€”letâ€™s enjoy the tunes with your new vibe! Whatâ€™s your favorite sound tweak? ğŸ§ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  Settings adjusted, how satisfying! Dr. Melody closes the panelâ€”how do these changes make your listening experience feel? ğŸ’–ğŸ’ğŸŒ¸`);
    });
    document.getElementById('closePomodoro').addEventListener('click', () => {
      togglePopup('pomodoroPopup', false);
      showRadioHostMessage(`ğŸµ Pomodoro closed, my productivity stars! DJ Sunny â˜€ï¸ hopes you got a lot doneâ€”letâ€™s celebrate with some tunes! Whatâ€™s your victory song? ğŸ‰ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  Closing the Pomodoro, dear listener! Dr. Melody hopes you feel accomplishedâ€”how did music support your focus today? ğŸ’–ğŸ’ğŸŒ¸`);
    });

    // Auth Popup
    document.getElementById('toggleAuth').addEventListener('click', () => {
      isLoginMode = !isLoginMode;
      document.getElementById('authTitle').textContent = isLoginMode ? 'Login ğŸ’ğŸŒ¸' : 'Sign Up ğŸŒ¸ğŸ’';
      document.getElementById('toggleAuth').textContent = isLoginMode ? 'Switch to Sign Up ğŸ’ğŸŒ¸' : 'Switch to Login ğŸŒ¸ğŸ’';
      document.getElementById('submitAuth').textContent = isLoginMode ? 'Login ğŸ’ğŸŒ¸' : 'Sign Up ğŸŒ¸ğŸ’';
      showRadioHostMessage(`ğŸµ Switching to ${isLoginMode ? 'Login' : 'Sign Up'}, my friends! DJ Sunny â˜€ï¸ loves welcoming new listenersâ€”what kind of music are you into? ğŸ¶ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  Toggling to ${isLoginMode ? 'Login' : 'Sign Up'}, how exciting! Dr. Melody wondersâ€”what brings you here today? Are you seeking joy or relaxation through music? ğŸ’–ğŸ’ğŸŒ¸`);
    });
    document.getElementById('submitAuth').addEventListener('click', () => {
      alert(`${isLoginMode ? 'Login' : 'Sign-up'} functionality not implemented. Replace with real authentication.`);
      togglePopup('authPopup', false);
      showRadioHostMessage(`ğŸµ ${isLoginMode ? 'Logging in' : 'Signing up'}, my musical friend! DJ Sunny â˜€ï¸ welcomes youâ€”letâ€™s celebrate with a great track! Whatâ€™s your first song request? ğŸ‰ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  ${isLoginMode ? 'Logging in' : 'Signing up'}, how wonderful! Dr. Melody is here for youâ€”how does joining this musical space make you feel? ğŸ’–ğŸ’ğŸŒ¸`);
    });

    // Profile Popup
    document.getElementById('signOutBtn').addEventListener('click', () => {
      alert('Sign out functionality not implemented. Replace with real authentication.');
      document.getElementById('profilePopup').querySelector('p').textContent = 'User: Guest ğŸ’ğŸŒ¸';
      togglePopup('profilePopup', false);
      showRadioHostMessage(`ğŸµ Farewell for now, my VIP listener! DJ Sunny â˜€ï¸ logs you outâ€”come back soon for more musical magic! Whatâ€™s the last song youâ€™ll play before you go? ğŸ¶ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  Signing out, dear listener! Dr. Melody hopes this musical journey brought you joyâ€”how do you feel as you step away? Until we meet again! ğŸ’–ğŸ’ğŸŒ¸`);
    });

    // Pomodoro Timer
    let pomodoroInterval;
    let isWork = true;
    let timeLeft = 25 * 60;

    function updatePomodoroDisplay() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      document.getElementById('pomodoroTime').textContent = `${isWork ? 'Work' : 'Break'} Session ğŸ’ğŸŒ¸`;
    }

    document.getElementById('pomodoroStart').addEventListener('click', () => {
      if (!pomodoroInterval) {
        pomodoroInterval = setInterval(() => {
          timeLeft--;
          if (timeLeft <= 0) {
            isWork = !isWork;
            timeLeft = (isWork ? document.getElementById('pomodoroWork').value : document.getElementById('pomodoroBreak').value) * 60;
            showRadioHostMessage(`ğŸµ Timeâ€™s up, my productivity pros! DJ Sunny â˜€ï¸ switches to a ${isWork ? 'work' : 'break'} sessionâ€”keep the energy flowing! Whatâ€™s your favorite focus tune? ğŸ“šğŸ’ğŸŒ¸`);
            showPsychiatristMessage(`ğŸ§  A shift in focus, how refreshing! Dr. Melody supports your transition to a ${isWork ? 'work' : 'break'} sessionâ€”let the music guide your energy! How are you feeling now? ğŸ’–ğŸ’ğŸŒ¸`);
          }
          updatePomodoroDisplay();
        }, 1000);
        document.getElementById('pomodoroStart').textContent = 'Pause ğŸ’ğŸŒ¸';
        showRadioHostMessage(`ğŸµ Letâ€™s get productive, my music fans! DJ Sunny â˜€ï¸ starts the Pomodoroâ€”a full work session of focus awaits! Whatâ€™s your go-to song for getting things done? ğŸ“šğŸ’ğŸŒ¸`);
        showPsychiatristMessage(`ğŸ§  Starting the Pomodoro, how motivated! Dr. Melody is hereâ€”letâ€™s channel this focus into a harmonious balance with your tunes! What helps you stay on track? ğŸ’–ğŸ’ğŸŒ¸`);
      } else {
        clearInterval(pomodoroInterval);
        pomodoroInterval = null;
        document.getElementById('pomodoroStart').textContent = 'Start ğŸ’ğŸŒ¸';
        showRadioHostMessage(`ğŸµ Taking a break from the timer, my friends! DJ Sunny â˜€ï¸ pauses the Pomodoroâ€”rest those creative minds! Whatâ€™s your favorite way to unwind? ğŸ§˜â€â™€ï¸ğŸ’ğŸŒ¸`);
        showPsychiatristMessage(`ğŸ§  Pausing the timer, I see! Dr. Melody encourages this moment of restâ€”how does this break feel for you? Whatâ€™s on your mind right now? ğŸ’–ğŸ’ğŸŒ¸`);
      }
    });

    document.getElementById('pomodoroReset').addEventListener('click', () => {
      clearInterval(pomodoroInterval);
      pomodoroInterval = null;
      timeLeft = document.getElementById('pomodoroWork').value * 60;
      isWork = true;
      updatePomodoroDisplay();
      document.getElementById('pomodoroStart').textContent = 'Start ğŸ’ğŸŒ¸';
      showRadioHostMessage(`ğŸµ Resetting the Pomodoro, my time travelers! DJ Sunny â˜€ï¸ starts freshâ€”letâ€™s dive into a new session! Whatâ€™s your favorite productivity hack? ğŸ“šğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  A reset, how grounding! Dr. Melody appreciates your fresh startâ€”how does this new cycle feel for you? What music helps you focus best? ğŸ’–ğŸ’ğŸŒ¸`);
    });

    // Settings Toggles
    document.getElementById('muteAdToggle').addEventListener('change', () => {
      isAdMuted = document.getElementById('muteAdToggle').checked;
      if (isAdPlaying) {
        if (isAdMuted) {
          player.mute();
          showRadioHostMessage(`ğŸµ Silence those ads, my musical friends! DJ Sunny â˜€ï¸ mutes the interruptionsâ€”pure music magic ahead! Whatâ€™s your least favorite ad jingle? ğŸ¶ğŸ’ğŸŒ¸`);
          showPsychiatristMessage(`ğŸ§  Muting the ads, how soothing! Dr. Melody ensures your focus stays on the musicâ€”how does this change make you feel? ğŸ’–ğŸ’ğŸŒ¸`);
        } else {
          player.unMute();
          showRadioHostMessage(`ğŸµ Ads are back on, my listeners! DJ Sunny â˜€ï¸ unmutesâ€”embrace the full audio spectrum! Whatâ€™s an ad song you secretly like? ğŸ‰ğŸ’ğŸŒ¸`);
          showPsychiatristMessage(`ğŸ§  Unmuting the ads, I see! Dr. Melody senses your opennessâ€”how does this change affect your listening experience? ğŸ’–ğŸ’ğŸŒ¸`);
        }
      } else {
        showRadioHostMessage(`ğŸµ Toggled the ad mute, my savvy listeners! DJ Sunny â˜€ï¸ sets it to ${isAdMuted ? 'on' : 'off'}â€”youâ€™re in control! Whatâ€™s your favorite ad-free song? ğŸ¶ğŸ’ğŸŒ¸`);
        showPsychiatristMessage(`ğŸ§  Adjusting ad muting, how empowering! Dr. Melody supports your choiceâ€”does this setting align with your emotional needs? ğŸ’–ğŸ’ğŸŒ¸`);
      }
    });

    document.getElementById('hifiModeToggle').addEventListener('change', () => {
      isHifiMode = document.getElementById('hifiModeToggle').checked;
      showRadioHostMessage(`ğŸµ Elevating the soundstage, my audiophiles! DJ Sunny â˜€ï¸ switches HiFi Mode to ${isHifiMode ? 'on' : 'off'}â€”crisp vibes incoming! Whatâ€™s your favorite high-quality track? ğŸ§ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  HiFi Mode ${isHifiMode ? 'enabled' : 'disabled'}, how enriching! Dr. Melody wondersâ€”does this change deepen your connection to the music? ğŸ’–ğŸ’ğŸŒ¸`);
    });

    document.getElementById('voiceToggle').addEventListener('change', () => {
      isVoiceEnabled = document.getElementById('voiceToggle').checked;
      showRadioHostMessage(`ğŸµ Voice for AI messages is now ${isVoiceEnabled ? 'on' : 'off'}, my friends! DJ Sunny â˜€ï¸ keeps you in the loopâ€”do you love hearing our voices? ğŸ¶ğŸ’ğŸŒ¸`);
      showPsychiatristMessage(`ğŸ§  Voice messages ${isVoiceEnabled ? 'enabled' : 'disabled'}, how fascinating! Dr. Melody hopes this suits your listening experienceâ€”how do our voices make you feel? ğŸ’–ğŸ’ğŸŒ¸`);
    });

    // Equalizer (mock)
    document.getElementById('bass').addEventListener('input', () => {
      const value = document.getElementById('bass').value;
      userActions.equalizerChanges++;
      userActions.lastAction = 'equalizer';
      if (userActions.equalizerChanges > 2) {
        showRadioHostMessage(`ğŸµ Youâ€™re a sound wizard, my friend! DJ Sunny â˜€ï¸ notices youâ€™ve tweaked the equalizer ${userActions.equalizerChanges} timesâ€”loving that bass at ${value}! Whatâ€™s your favorite bass-heavy song? ğŸ¶ğŸ’ğŸŒ¸`);
        showPsychiatristMessage(`ğŸ§  Adjusting the equalizer ${userActions.equalizerChanges} times, how creative! Dr. Melody senses the bass at ${value}â€”does this low frequency resonate with your emotions? ğŸ’–ğŸ’ğŸŒ¸`);
      } else {
        showRadioHostMessage(`ğŸµ Thumping the bass, my beat masters! DJ Sunny â˜€ï¸ adjusts it to ${value}â€”feel the low-end love! Whatâ€™s a