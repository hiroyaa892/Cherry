<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retro YouTube Music Player</title>
  <link href="./src/output.css" rel="stylesheet">
  <script src="https://www.youtube.com/iframe_api"></script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #f8c3c3;
      font-family: 'Press Start 2P', monospace;
      image-rendering: pixelated;
      margin: 0;
      padding: 15px;
    }
    .container {
      background-color: #d89393;
      border: 4px solid #c94b4b;
      border-radius: 16px;
      padding: 15px;
      max-width: 500px;
      margin: 0 auto;
      box-shadow: 4px 4px 0 #2d1a1a;
      position: relative;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .retro-button {
      background-color: #d89393;
      border: 2px solid #c94b4b;
      color: #2d1a1a;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }
    .retro-button::before {
      content: 'ğŸ’';
      position: absolute;
      left: -10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.4;
    }
    .retro-button::after {
      content: 'ğŸŒ¸';
      position: absolute;
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.4;
    }
    .retro-button:hover {
      background-color: #e6b8b8;
    }
    .retro-button.active {
      background-color: #e6b8b8;
      border-color: #2d1a1a;
    }
    .input-section {
      text-align: center;
      margin-bottom: 15px;
    }
    input[type="text"], input[type="email"], input[type="password"] {
      background-color: #f8c3c3;
      border: 2px solid #c94b4b;
      border-radius: 8px;
      padding: 8px;
      font-size: 11px;
      width: 70%;
      margin-right: 8px;
    }
    .media-controls {
      text-align: center;
      margin-bottom: 15px;
    }
    .media-controls .buttons {
      margin-bottom: 8px;
    }
    .media-controls .seek-bar {
      width: 100%;
      margin-bottom: 8px;
    }
    input[type="range"] {
      -webkit-appearance: none;
      background: #c94b4b;
      border-radius: 4px;
      height: 10px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #d89393;
      border: 2px solid #c94b4b;
      border-radius: 50%;
      cursor: pointer;
    }
    .queue-history {
      margin-bottom: 8px;
    }
    .queue-history h2 {
      font-size: 12px;
      margin-bottom: 8px;
      position: relative;
    }
    .queue-history h2::after {
      content: ' ğŸ’ğŸŒ¸';
      position: absolute;
      right: 0;
    }
    .queue-history ul {
      list-style: none;
      padding: 0;
      max-height: 100px;
      overflow-y: auto;
      font-size: 9px;
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #d89393;
      padding: 20px;
      border: 4px solid #c94b4b;
      border-radius: 16px;
      box-shadow: 4px 4px 0 #2d1a1a;
      z-index: 1000;
    }
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    .playing {
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% { opacity: 0.6; }
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #c94b4b;
      transition: 0.4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: #d89393;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #e6b8b8;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    .radio-host-bubble {
      position: fixed;
      bottom: 100px;
      right: 10px;
      background-color: #e6b8b8;
      border: 2px solid #c94b4b;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 8px;
      max-width: 250px;
      text-align: left;
      box-shadow: 2px 2px 0 #2d1a1a;
      z-index: 1001;
      animation: fadeIn 1s;
    }
    .psychiatrist-bubble {
      position: fixed;
      bottom: 30px;
      right: 10px;
      background-color: #e6b8b8;
      border: 2px solid #c94b4b;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 8px;
      max-width: 250px;
      text-align: left;
      box-shadow: 2px 2px 0 #2d1a1a;
      z-index: 1001;
      animation: fadeIn 1s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top Bar -->
    <div class="top-bar">
      <button id="profileBtn" class="retro-button">Profile ğŸ’ğŸŒ¸</button>
      <button id="settingsBtn" class="retro-button">Settings ğŸ’ğŸŒ¸</button>
      <button id="pomodoroBtn" class="retro-button">Pomodoro ğŸ’ğŸŒ¸</button>
      <button id="loginSignupBtn" class="retro-button">Login ğŸ’ğŸŒ¸</button>
    </div>

    <!-- URL Input -->
    <div class="input-section">
      <input id="urlInput" type="text" placeholder="YouTube Playlist/Video URL ğŸ’ğŸŒ¸" class="retro-border">
      <button id="loadUrl" class="retro-button">Load ğŸ’ğŸŒ¸</button>
    </div>

    <!-- Player Controls -->
    <div id="player" class="hidden"></div>
    <div class="media-controls">
      <div id="currentSong" class="text-center mb-2 font-bold text-lg">No Track Loaded ğŸ’ğŸŒ¸</div>
      <div class="buttons">
        <button id="prevBtn" class="retro-button">Previous ğŸ’</button>
        <button id="playPauseBtn" class="retro-button">Play/Pause ğŸŒ¸</button>
        <button id="nextBtn" class="retro-button">Next ğŸ’</button>
        <button id="loopBtn" class="retro-button">Loop ğŸ’ğŸŒ¸</button>
        <button id="shuffleBtn" class="retro-button">Shuffle ğŸ’ğŸŒ¸</button>
      </div>
      <div class="seek-bar">
        <input type="range" id="seekSlider" min="0" max="100" value="0">
      </div>
    </div>

    <!-- Queue and History -->
    <div class="queue-history">
      <h2>Queue ğŸ’</h2>
      <ul id="queueList"></ul>
    </div>
    <div class="queue-history">
      <h2>History ğŸŒ¸</h2>
      <ul id="historyList"></ul>
    </div>
  </div>

  <!-- DJ Sunny Radio Host Bubble (Bottom Right, Above Dr. Melody) -->
  <div id="radioHostBubble" class="radio-host-bubble hidden">â˜€ï¸ Hey there, sunshine squad! This is DJ Sunny, dropping the hottest tunes your way! Letâ€™s light up the airwaves! Whatâ€™s your vibe today? ğŸ’ğŸŒ¸</div>

  <!-- Dr. Melody Psychiatrist Bubble (Bottom Right) -->
  <div id="psychiatristBubble" class="psychiatrist-bubble hidden">ğŸ§  Hello, dear listener! Iâ€™m Dr. Melody, your musical therapist. Letâ€™s explore how these tunes resonate with your soul! How are you feeling right now? ğŸ’ğŸŒ¸</div>

  <!-- Popups -->
  <div id="authPopup" class="popup">
    <h2 id="authTitle" class="text-center font-bold mb-3 text-sm">Login ğŸ’ğŸŒ¸</h2>
    <button id="toggleAuth" class="retro-button w-full mb-3">Switch to Sign Up ğŸ’ğŸŒ¸</button>
    <input id="authEmail" type="email" placeholder="Email ğŸ’ğŸŒ¸" class="w-full mb-3">
    <input id="authPassword" type="password" placeholder="Password ğŸŒ¸ğŸ’" class="w-full mb-3">
    <button id="submitAuth" class="retro-button w-full mb-3">Login ğŸ’ğŸŒ¸</button>
    <button id="closeAuth" class="retro-button w-full">Close ğŸŒ¸ğŸ’</button>
  </div>
  <div id="profilePopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Profile ğŸ’ğŸŒ¸</h2>
    <p id="profileEmail" class="mb-3">User: Guest ğŸ’ğŸŒ¸</p>
    <button id="signOutBtn" class="retro-button w-full mb-3">Sign Out ğŸ’ğŸŒ¸</button>
    <button id="closeProfile" class="retro-button w-full">Close ğŸŒ¸ğŸ’</button>
  </div>
  <div id="settingsPopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Settings ğŸ’ğŸŒ¸</h2>
    <h3 class="font-bold mb-3">Audio Settings ğŸ’ğŸŒ¸</h3>
    <div class="flex items-center mb-3">
      <label class="text-xs mr-3">Mute YouTube Ads ğŸ’ğŸŒ¸</label>
      <label class="toggle-switch">
        <input type="checkbox" id="muteAdToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="flex items-center mb-3">
      <label class="text-xs mr-3">HiFi Mode ğŸŒ¸ğŸ’</label>
      <label class="toggle-switch">
        <input type="checkbox" id="hifiModeToggle">
        <span class="slider"></span>
      </label>
    </div>
    <div class="flex items-center mb-3">
      <label class="text-xs mr-3">AI Volume ğŸ’ğŸŒ¸</label>
      <input type="range" id="aiVolume" min="0" max="1" step="0.1" value="1" class="w-full">
    </div>
    <h3 class="font-bold mb-3">Ad Blocking ğŸ’ğŸŒ¸</h3>
    <p class="text-xs mb-3">For enhanced ad blocking, set your DNS to <a href="https://dns.adguard.com/" target="_blank" style="color: #c94b4b; text-decoration: underline;">dns.adguard.com</a> in your router or device settings. ğŸ’ğŸŒ¸</p>
    <h3 class="font-bold mb-3">Equalizer ğŸ’ğŸŒ¸</h3>
    <div class="flex space-x-3 mb-3">
      <div>
        <label class="text-xs">Bass ğŸ’ğŸŒ¸</label>
        <input type="range" id="bass" min="-12" max="12" value="0" class="w-full">
      </div>
      <div>
        <label class="text-xs">Mid ğŸŒ¸ğŸ’</label>
        <input type="range" id="mid" min="-12" max="12" value="0" class="w-full">
      </div>
      <div>
        <label class="text-xs">Treble ğŸ’ğŸŒ¸</label>
        <input type="range" id="treble" min="-12" max="12" value="0" class="w-full">
      </div>
    </div>
    <button id="closeSettings" class="retro-button w-full">Close ğŸŒ¸ğŸ’</button>
  </div>
  <div id="pomodoroPopup" class="popup">
    <h2 class="text-center font-bold mb-3 text-sm">Pomodoro Timer ğŸ’ğŸŒ¸</h2>
    <div id="pomodoroTime" class="text-center mb-3 text-sm">25:00 ğŸ’ğŸŒ¸</div>
    <div class="flex justify-center space-x-3 mb-3">
      <button id="pomodoroStart" class="retro-button">Start ğŸ’ğŸŒ¸</button>
      <button id="pomodoroReset" class="retro-button">Reset ğŸŒ¸ğŸ’</button>
    </div>
    <div class="flex flex-wrap gap-3">
      <label class="text-xs">Work (min): ğŸ’ğŸŒ¸</label>
      <input id="pomodoroWork" type="number" value="25" class="w-20 p-2">
      <label class="text-xs">Break (min): ğŸŒ¸ğŸ’</label>
      <input id="pomodoroBreak" type="number" value="5" class="w-20 p-2">
    </div>
    <button id="closePomodoro" class="retro-button mt-3 w-full">Close ğŸŒ¸ğŸ’</button>
  </div>
  <div id="popupOverlay" class="popup-overlay"></div>

  <script>
    let player;
    let playlist = [];
    let history = [];
    let currentIndex = -1;
    let isLooping = false;
    let isShuffling = false;
    let isLoginMode = true;
    let isAdMuted = true;
    let isHifiMode = false;
    let isAdPlaying = false;
    let lastStateChangeTime = 0;
    let lastVideoId = null;
    let lastDuration = 0;
    let lastPlaybackQuality = '';
    let stateHistory = [];
    let userInitiatedPlayback = false;
    let lastInterruptTime = 0;
    let interruptInterval = null;
    let audioContext = null;
    let audioSource = null;
    let isBackgroundPlaying = false;
    let adCheckInterval = null;
    let adInteractionInterval = null;
    const AD_DURATION_THRESHOLD = 120;
    const STATE_WINDOW_SIZE = 3;
    const TRANSITION_THRESHOLD = 5;
    const AD_CHECK_INTERVAL = 5000;
    const INTERACTION_INTERVAL = 5000; // 5 seconds between AI interactions

    const API_KEY = 'AIzaSyBitewTBcoYxggjLlqbMm1qWhFatR6kvP8';

    // Expanded ad patterns with more keywords
    const adPatterns = {
      title: /(sponsored|ad|promo|advertisement|commercial|trailer|teaser|presented by|brand|campaign|partner)/i,
      channel: /(google ads|doubleclick|admob|advertiser|marketing|promotions|sponsor|brand|official ad)/i,
      description: /(promoted|ad|shop now|sponsor|partner|buy now|click here|limited offer|deal|sale|discount)/i,
      url: /(ad|promo|sponsor|affiliate|campaign)/i
    };

    let videoMetadataCache = {};
    let adDetectionStats = { truePositives: 0, falsePositives: 0, total: 0 }; // For AI learning
    const radioHostBubble = document.getElementById('radioHostBubble');
    const psychiatristBubble = document.getElementById('psychiatristBubble');
    const loginSignupBtn = document.getElementById('loginSignupBtn');
    const profileEmailDisplay = document.getElementById('profileEmail');
    let messageToggleCounter = 0;
    let aiVolume = 1.0;

    const synth = window.speechSynthesis;
    let voices = [];

    function loadVoices() {
      voices = synth.getVoices();
    }

    loadVoices();
    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = loadVoices;
    }

    function speakText(text, pitch, bubbleElement) {
      return new Promise((resolve) => {
        const cleanText = text.replace(/â˜€ï¸|ğŸ§ |ğŸ’|ğŸŒ¸/g, '').trim();
        if (cleanText === '') {
          setTimeout(() => {
            bubbleElement.classList.add('hidden');
            resolve();
          }, 6000);
          return;
        }

        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.pitch = pitch;
        utterance.rate = 1.0;
        utterance.volume = aiVolume;
        utterance.onend = () => {
          bubbleElement.classList.add('hidden');
          resolve();
        };

        utterance.onerror = () => {
          setTimeout(() => {
            bubbleElement.classList.add('hidden');
            resolve();
          }, 6000);
        };

        const voice = voices.find(v => v.lang.includes('en')) || voices[0];
        if (voice) {
          utterance.voice = voice;
        } else {
          setTimeout(() => {
            bubbleElement.classList.add('hidden');
            resolve();
          }, 6000);
          return;
        }

        synth.speak(utterance);
      });
    }

    const adDetectedPhrases = [
      `â˜€ï¸ Ad spotted with confidence, sunshine squad! DJ Sunny mutes this cloudâ€”try dns.adguard.com for even better blocking! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ High-probability ad alert, music rays! DJ Sunnyâ€™s silencing itâ€”switch to dns.adguard.com for ad-free vibes! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ My ad sensors are buzzing, crew! DJ Sunny mutes this commercialâ€”dns.adguard.com can zap ads entirely! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Confirmed ad incoming, fans! DJ Sunny mutes itâ€”use dns.adguard.com to stop ads at the source! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Ad detection at peak, sunshine crew! DJ Sunny slams the muteâ€”dns.adguard.com can block it entirely! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Ad invasion confirmed! DJ Sunny mutes it quickâ€”check out dns.adguard.com for a cleaner listen! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ My AI says this is an ad, sunbeams! DJ Sunny mutes itâ€”dns.adguard.com could zap these ads away! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Ad flagged with precision, music lovers! DJ Sunny mutes it fastâ€”set your DNS to dns.adguard.com for pure tunes! ğŸ’ğŸŒ¸`
    ];

    const adEndedPhrases = [
      `â˜€ï¸ Adâ€™s gone, sunshine crew! DJ Sunny unmutesâ€”back to those radiant beats! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Ad break over, rhythm rays! DJ Sunny cranks up the sunshineâ€”letâ€™s glow with the music! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Weâ€™re ad-free again, tune travelers! DJ Sunny restores the sunny soundâ€”full blast ahead! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Adâ€™s out, vibes are in! DJ Sunny unmutesâ€”letâ€™s bask in these brilliant tracks! ğŸ’ğŸŒ¸`
    ];

    const midSongInterruptPhrases = [
      `â˜€ï¸ Hold up, sunshine squad! DJ Sunny here with a quick interruptâ€”this trackâ€™s got such a funky beat, doesnâ€™t it? Letâ€™s keep groovingâ€”any requests for the next song? ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Breaking in with some sunny vibes, folks! DJ Sunnyâ€™s loving this songâ€™s chill lo-fi energyâ€”perfect for a relaxed afternoon! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Hey there, music rays! DJ Sunny popping inâ€”this artist dropped this banger in 2023, and itâ€™s got over 5M views! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Quick sunny interruption, crew! DJ Sunnyâ€™s digging this trackâ€™s upbeat tempoâ€”feels like a solid 130 BPM! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Sunshine alert, listeners! DJ Sunny hereâ€”this songâ€™s got a classic pop vibe, and Iâ€™m obsessed! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Time out, sunshine fans! DJ Sunny senses the next beat comingâ€”letâ€™s prep for a smooth transition! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Mid-track magic, music rays! DJ Sunnyâ€™s predicting the next dropâ€”get ready for a vibe shift! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Hey, tune travelers! DJ Sunnyâ€™s catching the rhythm shiftâ€”next songâ€™s on the horizon, stay tuned! ğŸ’ğŸŒ¸`
    ];

    const loadPlaylistPhrases = [
      `â˜€ï¸ Rise and shine, tune travelers! DJ Sunnyâ€™s loading your playlist with sunny flairâ€”letâ€™s heat up the airwaves! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Playlist loaded, sunshine crew! DJ Sunnyâ€™s ready to rock this setâ€”looks like weâ€™ve got some indie vibes in here! ğŸ’ğŸŒ¸`
    ];

    const loadVideoPhrases = [
      `â˜€ï¸ Bright choice, sunshine fans! DJ Sunnyâ€™s spinning your videoâ€”get ready for a sunny soundwave! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Single track loaded, music rays! DJ Sunnyâ€™s here to make it shineâ€”this songâ€™s a 4-minute banger! ğŸ’ğŸŒ¸`
    ];

    const playPhrases = [
      `â˜€ï¸ Letâ€™s light it up, sunshine lovers! DJ Sunny hits playâ€”feel the sunny rhythm! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Play button smashed, music rays! DJ Sunnyâ€™s bringing the heatâ€”this songâ€™s a classic rock anthem! ğŸ’ğŸŒ¸`
    ];

    const pausePhrases = [
      `â˜€ï¸ Taking a sunshine break, folks! DJ Sunny pauses the beatsâ€”enjoy the calm glow! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Pause mode on, music rays! DJ Sunnyâ€™s giving you a breatherâ€”this trackâ€™s got a chill lo-fi vibe. ğŸ’ğŸŒ¸`
    ];

    const nextPhrases = [
      `â˜€ï¸ Next stop, sunshine station! DJ Sunnyâ€™s cueing up the next trackâ€”keep the rays rolling! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Moving along, music rays! DJ Sunny spins the next songâ€”this trackâ€™s got a reggae vibe! ğŸ’ğŸŒ¸`
    ];

    const prevPhrases = [
      `â˜€ï¸ Rewind those rays, listeners! DJ Sunny spins back to the previous sunny gemâ€”relive the glow! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Backtracking, music rays! DJ Sunny plays the last song againâ€”this oneâ€™s a country classic! ğŸ’ğŸŒ¸`
    ];

    const queueSelectPhrases = [
      `â˜€ï¸ Stellar pick, sunshine crew! DJ Sunnyâ€™s playing your queue choiceâ€”feel the heat! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Queue selection on point, music rays! DJ Sunny spins your pickâ€”this songâ€™s a 2021 release! ğŸ’ğŸŒ¸`
    ];

    const historySelectPhrases = [
      `â˜€ï¸ Nostalgia alert, sunshine fans! DJ Sunnyâ€™s replaying a golden oldie from your historyâ€”pure radiance! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ History lesson time, music rays! DJ Sunny spins a past favoriteâ€”this songâ€™s a 5-minute epic! ğŸ’ğŸŒ¸`
    ];

    const loopPhrases = [
      `â˜€ï¸ Looping on, sunshine fans! DJ Sunny keeps this gem on repeatâ€”letâ€™s soak in the rays! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Loop off, music rays! DJ Sunny moves us forwardâ€”new sunny beats ahead! ğŸ’ğŸŒ¸`
    ];

    const shufflePhrases = [
      `â˜€ï¸ Shuffling the sunny deck, tune travelers! DJ Sunny mixes it upâ€”expect the unexpected! ğŸ’ğŸŒ¸`,
      `â˜€ï¸ Shuffle off, sunshine crew! DJ Sunny sets the order straightâ€”back to the sunny flow! ğŸ’ğŸŒ¸`
    ];

    const adDetectedPhrasesPsych = [
      `ğŸ§  My analysis confirms an ad, dear listener! Dr. Melody silences itâ€”try dns.adguard.com for a smoother experience! ğŸ’ğŸŒ¸`,
      `ğŸ§  Iâ€™m certain this is an ad! Dr. Melody mutes itâ€”dns.adguard.com can block ads at the source! ğŸ’ğŸŒ¸`,
      `ğŸ§  Ad detected with precision! Dr. Melody mutes itâ€”dns.adguard.com can enhance your listening peace! ğŸ’ğŸŒ¸`,
      `ğŸ§  An ad, confirmed by my insights! Dr. Melody mutes itâ€”set your DNS to dns.adguard.com for ad-free therapy! ğŸ’ğŸŒ¸`,
      `ğŸ§  My diagnostics spot an ad! Dr. Melody mutes it swiftlyâ€”dns.adguard.com could prevent these interruptions! ğŸ’ğŸŒ¸`,
      `ğŸ§  Ad flagged by my analysis! Dr. Melody silences itâ€”explore dns.adguard.com for a cleaner journey! ğŸ’ğŸŒ¸`,
      `ğŸ§  High-likelihood ad detected! Dr. Melody mutes itâ€”dns.adguard.com might maintain your focus on healing tunes! ğŸ’ğŸŒ¸`,
      `ğŸ§  A commercial break, analytically confirmed! Dr. Melody mutes itâ€”consider dns.adguard.com for a serene vibe! ğŸ’ğŸŒ¸`
    ];

    const adEndedPhrasesPsych = [
      `ğŸ§  The ad has passed, dear listener! Dr. Melody unmutes the musicâ€”letâ€™s return to the sounds that soothe your soul! ğŸ’ğŸŒ¸`,
      `ğŸ§  That ad is behind us now! Dr. Melody restores the melodyâ€”how does it feel to reconnect with your musical essence? ğŸ’ğŸŒ¸`,
      `ğŸ§  Ad-free once more! Dr. Melody brings back the musicâ€”let these notes continue to nurture your inner peace! ğŸ’ğŸŒ¸`,
      `ğŸ§  The interruption is over! Dr. Melody unmutesâ€”immerse yourself in the healing power of your playlist! ğŸ’ğŸŒ¸`
    ];

    const loadPlaylistPhrasesPsych = [
      `ğŸ§  A playlist, how wonderful! Dr. Melody senses this selection might reflect your moodâ€”letâ€™s see how it resonates with your inner self! ğŸ’ğŸŒ¸`,
      `ğŸ§  Playlist loaded, dear listener! Dr. Melody notices a mix of genres hereâ€”perhaps a sign of your diverse emotions today! ğŸ’ğŸŒ¸`
    ];

    const loadVideoPhrasesPsych = [
      `ğŸ§  A single track, I see! Dr. Melody wonders what emotions this song stirs in youâ€”letâ€™s listen and reflect together! ğŸ’ğŸŒ¸`,
      `ğŸ§  Video loaded, dear listener! Dr. Melody senses this songâ€™s chill vibeâ€”perhaps a moment of calm for you today! ğŸ’ğŸŒ¸`
    ];

    const playPhrasesPsych = [
      `ğŸ§  The music resumes! Dr. Melody senses your energy shiftingâ€”how does this song lift your spirits? ğŸ’ğŸŒ¸`,
      `ğŸ§  Weâ€™re playing again, dear listener! Dr. Melody feels the rock energy in this trackâ€”electric guitars often evoke passion! ğŸ’ğŸŒ¸`
    ];

    const pausePhrasesPsych = [
      `ğŸ§  A pause in the music, how intriguing! Dr. Melody wondersâ€”does this silence bring you calm or anticipation? ğŸ’ğŸŒ¸`,
      `ğŸ§  Pausing the melody, I see! Dr. Melody feels this moment of quietâ€”perhaps a chance to reflect! ğŸ’ğŸŒ¸`
    ];

    const nextPhrasesPsych = [
      `ğŸ§  Moving to the next song, I see! Dr. Melody hopes this track brings a new layer of joyâ€”how does it make you feel? ğŸ’ğŸŒ¸`,
      `ğŸ§  On to the next melody! Dr. Melody senses this reggae trackâ€™s relaxed vibeâ€”offbeat rhythms often soothe the soul! ğŸ’ğŸŒ¸`
    ];

    const prevPhrasesPsych = [
      `ğŸ§  A step back in your musical journey! Dr. Melody senses nostalgiaâ€”does this song hold special memories for you? ğŸ’ğŸŒ¸`,
      `ğŸ§  Revisiting the previous track, I see! Dr. Melody feels this country songâ€™s storytellingâ€”such songs often evoke emotion! ğŸ’ğŸŒ¸`
    ];

    const queueSelectPhrasesPsych = [
      `ğŸ§  A thoughtful choice from the queue! Dr. Melody is curiousâ€”what drew you to this song today? ğŸ’ğŸŒ¸`,
      `ğŸ§  Queue selection playing now! Dr. Melody notices this 2021 trackâ€™s popularityâ€”10M views! ğŸ’ğŸŒ¸`
    ];

    const historySelectPhrasesPsych = [
      `ğŸ§  Revisiting a past favorite, I see! Dr. Melody wondersâ€”what emotions does this song bring back for you? ğŸ’ğŸŒ¸`,
      `ğŸ§  A history pick, how meaningful! Dr. Melody senses this 5-minute epicâ€™s depthâ€”it even won an award! ğŸ’ğŸŒ¸`
    ];

    const loopPhrasesPsych = [
      `ğŸ§  Looping this track, how immersive! Dr. Melody feels its repetitionâ€”does it deepen your emotional connection? ğŸ’ğŸŒ¸`,
      `ğŸ§  Loop off, dear listener! Dr. Melody guides us forwardâ€”new melodies await to stir your soul! ğŸ’ğŸŒ¸`
    ];

    const shufflePhrasesPsych = [
      `ğŸ§  Shuffling the playlist, how spontaneous! Dr. Melody embraces the unpredictabilityâ€”letâ€™s see what emotions arise! ğŸ’ğŸŒ¸`,
      `ğŸ§  Shuffle off, I see! Dr. Melody appreciates the return to orderâ€”how does this flow feel for you? ğŸ’ğŸŒ¸`
    ];

    async function showRadioHostMessage(message, forceShow = false) {
      if (forceShow || messageToggleCounter % 2 === 0) {
        radioHostBubble.textContent = message;
        radioHostBubble.classList.remove('hidden');
        await speakText(message, 1.2, radioHostBubble);
      }
      if (!forceShow) messageToggleCounter++;
    }

    async function showPsychiatristMessage(message, forceShow = false) {
      if (forceShow || messageToggleCounter % 2 === 1) {
        psychiatristBubble.textContent = message;
        psychiatristBubble.classList.remove('hidden');
        await speakText(message, 0.8, psychiatristBubble);
      }
      if (!forceShow) messageToggleCounter++;
    }

    function getRandomPhrase(phrases) {
      return phrases[Math.floor(Math.random() * phrases.length)];
    }

    function startMidSongInterruptions() {
      if (interruptInterval) clearInterval(interruptInterval);
      interruptInterval = setInterval(() => {
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING && !isAdPlaying && !document.hidden) {
          const currentTime = player.getCurrentTime();
          const duration = player.getDuration();
          const progress = currentTime / duration;
          const timeSinceLastInterrupt = Date.now() - lastInterruptTime;

          if (duration > 0 && progress >= 0.5 && progress <= 0.7 && timeSinceLastInterrupt >= 30000) {
            if (Math.random() < 0.3) {
              const initialState = player.getPlayerState();
              if (initialState === YT.PlayerState.PLAYING) {
                player.pauseVideo();
              }
              const interruptMessage = getRandomPhrase(midSongInterruptPhrases);
              showRadioHostMessage(interruptMessage, true).then(() => {
                showPsychiatristMessage(`ğŸ§  DJ Sunnyâ€™s timing is impeccable! Dr. Melody agreesâ€”this break enhances your musical journey. Howâ€™s the vibe? ğŸ’ğŸŒ¸`, true).then(() => {
                  if (initialState === YT.PlayerState.PLAYING) {
                    player.playVideo();
                  }
                  lastInterruptTime = Date.now();
                });
              });
            }
          }
        }
      }, 45000);
    }

    async function login(email, password) {
      try {
        const users = JSON.parse(localStorage.getItem('users')) || {};
        if (users[email] && users[email].password === password) {
          const token = btoa(email + ':' + Date.now());
          localStorage.setItem('token', token);
          users[email].token = token;
          localStorage.setItem('users', JSON.stringify(users));
          updateAuthState(token);
          togglePopup('authPopup', false);
          await showRadioHostMessage(`â˜€ï¸ Welcome back, sunshine VIP! DJ Sunnyâ€™s thrilled to see youâ€”letâ€™s make the airwaves glow! ğŸ’ğŸŒ¸`, true);
          await showPsychiatristMessage(`ğŸ§  Youâ€™ve logged in, how wonderful! Dr. Melody is hereâ€”how does returning to this musical space feel? ğŸ’ğŸŒ¸`, true);
        } else {
          alert('Invalid email or password.');
        }
      } catch (err) {
        alert('Error logging in. Please try again.');
      }
    }

    async function signup(email, password) {
      try {
        const users = JSON.parse(localStorage.getItem('users')) || {};
        if (users[email]) {
          alert('Email already exists. Please log in.');
          return;
        }
        const token = btoa(email + ':' + Date.now());
        users[email] = { password, token };
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('token', token);
        updateAuthState(token);
        togglePopup('authPopup', false);
        await showRadioHostMessage(`â˜€ï¸ Welcome to the sunny crew, new VIP! DJ Sunnyâ€™s pumped to have youâ€”letâ€™s shine together! ğŸ’ğŸŒ¸`, true);
        await showPsychiatristMessage(`ğŸ§  A warm welcome to you, new listener! Dr. Melody is delightedâ€”how does joining this musical community feel? ğŸ’ğŸŒ¸`, true);
      } catch (err) {
        alert('Error signing up. Please try again.');
      }
    }

    async function verifyToken(token) {
      try {
        const users = JSON.parse(localStorage.getItem('users')) || {};
        for (const email in users) {
          if (users[email].token === token) {
            return email;
          }
        }
        localStorage.removeItem('token');
        return null;
      } catch (err) {
        localStorage.removeItem('token');
        return null;
      }
    }

    async function updateAuthState(token) {
      const email = await verifyToken(token);
      if (email) {
        loginSignupBtn.textContent = 'Logout ğŸ’ğŸŒ¸';
        profileEmailDisplay.textContent = `User: ${email} ğŸ’ğŸŒ¸`;
      } else {
        loginSignupBtn.textContent = 'Login ğŸ’ğŸŒ¸';
        profileEmailDisplay.textContent = 'User: Guest ğŸ’ğŸŒ¸';
      }
    }

    async function checkAuthOnLoad() {
      const token = localStorage.getItem('token');
      if (token) {
        await updateAuthState(token);
      }
    }

    checkAuthOnLoad();

    function onYouTubeIframeAPIReady() {
      console.log('YouTube IFrame API Ready');
      player = new YT.Player('player', {
        height: '0',
        width: '0',
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onPlaybackQualityChange': onPlaybackQualityChange
        }
      });
      showRadioHostMessage('â˜€ï¸ Hey there, sunshine squad! This is DJ Sunny, dropping the hottest tunes your way! Letâ€™s light up the airwaves! Whatâ€™s your vibe today? ğŸ’ğŸŒ¸', true)
        .then(() => showPsychiatristMessage('ğŸ§  Hello, dear listener! Iâ€™m Dr. Melody, your musical therapist. Letâ€™s explore how these tunes resonate with your soul! How are you feeling right now? ğŸ’ğŸŒ¸', true));
    }

    function onPlayerReady(event) {
      console.log('Player Ready', event);
      document.getElementById('seekSlider').addEventListener('input', () => {
        const seekTo = (document.getElementById('seekSlider').value / 100) * player.getDuration();
        player.seekTo(seekTo);
      });
      updateSeekSlider();
      if (isAdMuted && isAdPlaying) {
        player.mute();
      }
      startMidSongInterruptions();
      setupBackgroundPlayback();
      startAdDetectionPolling();
    }

    function onPlaybackQualityChange(event) {
      const currentQuality = event.data;
      if (lastPlaybackQuality && currentQuality !== lastPlaybackQuality) {
        console.log(`Playback quality changed: ${lastPlaybackQuality} -> ${currentQuality}`);
        showRadioHostMessage(`â˜€ï¸ Quality switch detected, music rays! DJ Sunnyâ€™s keeping it smoothâ€”now playing in ${currentQuality}! ğŸ’ğŸŒ¸`);
        lastPlaybackQuality = currentQuality;
      }
    }

    async function fetchVideoMetadata(videoId) {
      if (videoMetadataCache[videoId]) {
        return videoMetadataCache[videoId];
      }
      try {
        console.log(`Fetching metadata for videoId: ${videoId} with API_KEY: ${API_KEY}`);
        const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${API_KEY}`);
        const data = await response.json();
        console.log('Metadata response:', data);
        if (data.items && data.items.length > 0) {
          const metadata = {
            title: data.items[0].snippet.title,
            channel: data.items[0].snippet.channelTitle,
            description: data.items[0].snippet.description,
            publishedAt: data.items[0].snippet.publishedAt
          };
          videoMetadataCache[videoId] = metadata;
          return metadata;
        }
        return null;
      } catch (err) {
        console.error('Error fetching video metadata:', err);
        return null;
      }
    }

    async function calculateAdScore(videoId, duration, currentQuality) {
      const metadata = await fetchVideoMetadata(videoId);
      let score = 0;

      // 1. Metadata-based scoring
      if (metadata) {
        const { title, channel, description } = metadata;
        if (adPatterns.title.test(title)) score += 0.4; // High confidence
        if (adPatterns.channel.test(channel)) score += 0.3;
        if (adPatterns.description.test(description)) score += 0.3;

        // Check for suspicious publication dates (e.g., very recent for ads)
        const publishedDate = new Date(metadata.publishedAt);
        const now = new Date();
        const ageInDays = (now - publishedDate) / (1000 * 60 * 60 * 24);
        if (ageInDays < 7) score += 0.1; // Recent videos might be promotional
      }

      // 2. Duration-based scoring
      const isShortVideo = duration > 0 && duration <= AD_DURATION_THRESHOLD;
      if (isShortVideo) score += 0.3;

      // 3. Playback behavior scoring
      const isFrequentTransition = stateHistory.length >= 2 && 
        (stateHistory[stateHistory.length - 1].time - stateHistory[stateHistory.length - 2].time) / 1000 < TRANSITION_THRESHOLD;
      if (isFrequentTransition) score += 0.2;

      const isAdLikeTransition = stateHistory.some(s => s.state === YT.PlayerState.PAUSED) && 
        stateHistory.some(s => s.state === YT.PlayerState.PLAYING);
      if (isAdLikeTransition) score += 0.15;

      // 4. Quality change scoring
      const qualityLevels = ['tiny', 'small', 'medium', 'large', 'hd720', 'hd1080', 'highres'];
      const currentQualityIndex = qualityLevels.indexOf(currentQuality);
      const lastQualityIndex = qualityLevels.indexOf(lastPlaybackQuality);
      const isQualityDrop = lastQualityIndex > -1 && currentQualityIndex > -1 && currentQualityIndex < lastQualityIndex;
      if (isQualityDrop) score += 0.15; // Ads often use lower quality

      // 5. Unexpected video scoring
      const expectedVideoId = currentIndex >= 0 && currentIndex < playlist.length ? playlist[currentIndex].id : null;
      const isUnexpectedVideo = videoId !== expectedVideoId && expectedVideoId !== null;
      if (isUnexpectedVideo) score += 0.25;

      // 6. Auto-play detection
      if (!userInitiatedPlayback) score += 0.1;

      console.log(`Ad Score for videoId ${videoId}: ${score.toFixed(2)} - Metadata: ${JSON.stringify(metadata)}, Duration: ${duration}s, FrequentTransition: ${isFrequentTransition}, AdLikeTransition: ${isAdLikeTransition}, QualityDrop: ${isQualityDrop}, UnexpectedVideo: ${isUnexpectedVideo}, AutoPlay: ${!userInitiatedPlayback}`);

      return score;
    }

    async function isLikelyAd(videoId, duration, currentQuality) {
      const score = await calculateAdScore(videoId, duration, currentQuality);
      const threshold = 0.5; // Adjustable threshold
      return score >= threshold;
    }

    function startAdDetectionPolling() {
      if (adCheckInterval) clearInterval(adCheckInterval);
      adCheckInterval = setInterval(async () => {
        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
          const currentVideoId = player.getVideoData()['video_id'];
          const duration = player.getDuration();
          const currentQuality = player.getPlaybackQuality();
          const isAd = await isLikelyAd(currentVideoId, duration, currentQuality);

          console.log(`Ad Polling - VideoID: ${currentVideoId}, IsAd: ${isAd}`);

          if (isAd) {
            if (!isAdPlaying) {
              isAdPlaying = true;
              lastVideoId = currentVideoId;
              adDetectionStats.total++;
              adDetectionStats.truePositives++;
              if (isAdMuted) {
                player.mute();
                const randomAdPhrase = getRandomPhrase(adDetectedPhrases);
                const randomAdPhrasePsych = getRandomPhrase(adDetectedPhrasesPsych);
                showRadioHostMessage(randomAdPhrase);
                showPsychiatristMessage(randomAdPhrasePsych);
                startAdInteraction();
              }
            }
          } else {
            if (isAdPlaying) {
              isAdPlaying = false;
              lastVideoId = currentVideoId;
              if (isAdMuted) {
                player.unMute();
                const randomAdEndPhrase = getRandomPhrase(adEndedPhrases);
                const randomAdEndPhrasePsych = getRandomPhrase(adEndedPhrasesPsych);
                showRadioHostMessage(randomAdEndPhrase);
                showPsychiatristMessage(randomAdEndPhrasePsych);
                stopAdInteraction();
              }
            }
          }
        }
      }, AD_CHECK_INTERVAL);
    }

    function startAdInteraction() {
      if (adInteractionInterval) clearInterval(adInteractionInterval);
      let isSunnyTurn = true;
      adInteractionInterval = setInterval(async () => {
        if (isAdPlaying) {
          if (isSunnyTurn) {
            const sunnyPhrases = [
              `â˜€ï¸ Hey Dr. Melody, my ad scoreâ€™s off the chartsâ€”muted this one! Try dns.adguard.com! ğŸ’ğŸŒ¸`,
              `â˜€ï¸ Yo, Doc! My AIâ€™s certain this is an adâ€”muted it! Use dns.adguard.com! ğŸ’ğŸŒ¸`,
              `â˜€ï¸ Dr. Melody, my detectionâ€™s sharpâ€”ad muted! dns.adguard.com could help! ğŸ’ğŸŒ¸`,
              `â˜€ï¸ Doc, my ad sensors are spot onâ€”muted! Set DNS to dns.adguard.com! ğŸ’ğŸŒ¸`
            ];
            await showRadioHostMessage(getRandomPhrase(sunnyPhrases));
          } else {
            const melodyPhrases = [
              `ğŸ§  DJ Sunny, my analysis agreesâ€”an ad indeed! Letâ€™s reflect during this silenceâ€”try dns.adguard.com! ğŸ’ğŸŒ¸`,
              `ğŸ§  Sunny, my diagnostics confirm your detectionâ€”well muted! Use dns.adguard.com! ğŸ’ğŸŒ¸`,
              `ğŸ§  Sunny, I concur with your ad scoreâ€”great muting! dns.adguard.com could help! ğŸ’ğŸŒ¸`,
              `ğŸ§  DJ Sunny, our combined AI nailed itâ€”ad muted! Set DNS to dns.adguard.com! ğŸ’ğŸŒ¸`
            ];
            await showPsychiatristMessage(getRandomPhrase(melodyPhrases));
          }
          isSunnyTurn = !isSunnyTurn;
        } else {
          stopAdInteraction();
        }
      }, INTERACTION_INTERVAL);
    }

    function stopAdInteraction() {
      if (adInteractionInterval) {
        clearInterval(adInteractionInterval);
        adInteractionInterval = null;
      }
    }

    function onPlayerStateChange(event) {
      const currentTime = Date.now();
      const state = event.data;
      const currentVideoId = player.getVideoData()['video_id'];
      const duration = player.getDuration();
      const currentQuality = player.getPlaybackQuality();

      stateHistory.push({ state, time: currentTime });
      if (stateHistory.length > STATE_WINDOW_SIZE) {
        stateHistory.shift();
      }

      const detectAd = async () => {
        const isAd = await isLikelyAd(currentVideoId, duration, currentQuality);
        console.log(`Ad Detection on State Change - VideoID: ${currentVideoId}, State: ${state}, IsAd: ${isAd}`);

        return isAd;
      };

      detectAd().then(isAd => {
        if (currentVideoId !== lastVideoId) {
          if (isAd) {
            isAdPlaying = true;
            adDetectionStats.total++;
            adDetectionStats.truePositives++;
            if (isAdMuted) {
              player.mute();
              const randomAdPhrase = getRandomPhrase(adDetectedPhrases);
              const randomAdPhrasePsych = getRandomPhrase(adDetectedPhrasesPsych);
              showRadioHostMessage(randomAdPhrase);
              showPsychiatristMessage(randomAdPhrasePsych);
              startAdInteraction();
            }
          } else {
            if (isAdPlaying) {
              isAdPlaying = false;
              if (isAdMuted) {
                player.unMute();
                const randomAdEndPhrase = getRandomPhrase(adEndedPhrases);
                const randomAdEndPhrasePsych = getRandomPhrase(adEndedPhrasesPsych);
                showRadioHostMessage(randomAdEndPhrase);
                showPsychiatristMessage(randomAdEndPhrasePsych);
                stopAdInteraction();
              }
            }
          }
          lastVideoId = currentVideoId;
        }
      });

      userInitiatedPlayback = false;

      if (state === YT.PlayerState.ENDED) {
        if (isLooping && currentIndex >= 0) {
          player.loadVideoById(playlist[currentIndex].id);
        } else {
          playNext();
        }
      }
    }

    function updateSeekSlider() {
      if (player && player.getCurrentTime) {
        const current = player.getCurrentTime();
        const duration = player.getDuration();
        document.getElementById('seekSlider').value = (current / duration) * 100 || 0;
        setTimeout(updateSeekSlider, 1000);
      }
    }

    async function loadUrl() {
      let url = document.getElementById('urlInput').value.trim();
      if (!url) {
        alert('Please enter a YouTube URL.');
        return;
      }

      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
      }

      let videoId = null;
      let playlistId = null;

      const videoRegex = [
        /(?:v=)([a-zA-Z0-9_-]{11})/,
        /youtu\.be\/([a-zA-Z0-9_-]{11})/,
        /embed\/([a-zA-Z0-9_-]{11})/,
        /watch\?v=([a-zA-Z0-9_-]{11})/
      ];

      const playlistRegex = /(?:list=)([a-zA-Z0-9_-]+)/;

      const playlistMatch = url.match(playlistRegex);
      if (playlistMatch) {
        playlistId = playlistMatch[1];
      }

      for (const regex of videoRegex) {
        const match = url.match(regex);
        if (match) {
          videoId = match[1];
          break;
        }
      }

      console.log('Parsed URL:', { videoId, playlistId });

      if (playlistId) {
        try {
          const response = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${API_KEY}`);
          console.log('Playlist response status:', response.status);
          const data = await response.json();
          console.log('Playlist data:', data);
          if (data.items && data.items.length > 0) {
            playlist = data.items.map(item => ({
              id: item.snippet.resourceId.videoId,
              title: item.snippet.title
            }));
            updateQueue();
            if (playlist.length > 0) {
              currentIndex = 0;
              userInitiatedPlayback = true;
              const loadPlaylistMessage = getRandomPhrase(loadPlaylistPhrases);
              const loadPlaylistMessagePsych = getRandomPhrase(loadPlaylistPhrasesPsych);
              await showRadioHostMessage(loadPlaylistMessage, true);
              await showPsychiatristMessage(loadPlaylistMessagePsych, true);
              playSong();
            } else {
              console.error('No items found in playlist');
              alert('No items found in the playlist. Please check the URL.');
            }
          } else {
            console.error('Invalid playlist data');
            alert('Invalid playlist URL or no videos found.');
          }
        } catch (err) {
          console.error('Error loading playlist:', err);
          alert('Error loading playlist. Please check the URL or API key.');
        }
      }
      else if (videoId) {
        try {
          const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${API_KEY}`);
          console.log('Video response status:', response.status);
          const data = await response.json();
          console.log('Video data:', data);
          if (data.items && data.items.length > 0) {
            playlist.push({
              id: videoId,
              title: data.items[0].snippet.title
            });
            updateQueue();
            if (currentIndex === -1) {
              currentIndex = 0;
              userInitiatedPlayback = true;
              const loadVideoMessage = getRandomPhrase(loadVideoPhrases);
              const loadVideoMessagePsych = getRandomPhrase(loadVideoPhrasesPsych);
              await showRadioHostMessage(loadVideoMessage, true);
              await showPsychiatristMessage(loadVideoMessagePsych, true);
              playSong();
            }
          } else {
            console.error('Invalid video data');
            alert('Invalid video URL');
          }
        } catch (err) {
          console.error('Error loading video:', err);
          alert('Error loading video. Please check the URL or API key.');
        }
      }
      else {
        console.error('Invalid URL format');
        alert('Invalid YouTube URL. Please provide a valid video or playlist URL.');
      }
    }

    function playSong() {
      if (currentIndex >= 0 && currentIndex < playlist.length) {
        console.log(`Playing song at index ${currentIndex}:`, playlist[currentIndex]);
        player.loadVideoById(playlist[currentIndex].id);
        document.getElementById('currentSong').textContent = playlist[currentIndex].title || 'No Track Loaded ğŸ’ğŸŒ¸';
        document.getElementById('currentSong').classList.add('playing');
        if (!history.includes(playlist[currentIndex])) {
          history.push(playlist[currentIndex]);
          updateHistory();
        }
        lastInterruptTime = 0;
        lastVideoId = playlist[currentIndex].id;
      }
    }

    function playNext() {
      if (isLooping && currentIndex >= 0) {
        playSong();
      } else {
        if (isShuffling) {
          let newIndex;
          do {
            newIndex = Math.floor(Math.random() * playlist.length);
          } while (newIndex === currentIndex && playlist.length > 1);
          currentIndex = newIndex;
        } else {
          currentIndex = (currentIndex + 1) % playlist.length;
        }
        userInitiatedPlayback = true;
        playSong();
        const nextMessage = getRandomPhrase(nextPhrases);
        const nextMessagePsych = getRandomPhrase(nextPhrasesPsych);
        showRadioHostMessage(nextMessage);
        showPsychiatristMessage(nextMessagePsych);
      }
    }

    function playPrevious() {
      if (isLooping && currentIndex >= 0) {
        playSong();
      } else {
        if (isShuffling) {
          let newIndex;
          do {
            newIndex = Math.floor(Math.random() * playlist.length);
          } while (newIndex === currentIndex && playlist.length > 1);
          currentIndex = newIndex;
        } else {
          currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
        }
        userInitiatedPlayback = true;
        playSong();
        const prevMessage = getRandomPhrase(prevPhrases);
        const prevMessagePsych = getRandomPhrase(prevPhrasesPsych);
        showRadioHostMessage(prevMessage);
        showPsychiatristMessage(prevMessagePsych);
      }
    }

    function updateQueue() {
      const queueList = document.getElementById('queueList');
      queueList.innerHTML = '';
      playlist.forEach((song, index) => {
        const li = document.createElement('li');
        li.textContent = `ğŸ’ ${song.title} ğŸŒ¸`;
        li.className = 'cursor-pointer hover:bg-pink-200';
        li.onclick = () => {
          currentIndex = index;
          userInitiatedPlayback = true;
          playSong();
          const queueMessage = getRandomPhrase(queueSelectPhrases);
          const queueMessagePsych = getRandomPhrase(queueSelectPhrasesPsych);
          showRadioHostMessage(queueMessage);
          showPsychiatristMessage(queueMessagePsych);
        };
        queueList.appendChild(li);
      });
    }

    function updateHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      history.forEach((song, index) => {
        const li = document.createElement('li');
        li.textContent = `ğŸŒ¸ ${song.title} ğŸ’`;
        li.className = 'cursor-pointer hover:bg-pink-200';
        li.onclick = () => {
          currentIndex = playlist.findIndex(s => s.id === song.id);
          if (currentIndex !== -1) {
            userInitiatedPlayback = true;
            playSong();
            const historyMessage = getRandomPhrase(historySelectPhrases);
            const historyMessagePsych = getRandomPhrase(historySelectPhrasesPsych);
            showRadioHostMessage(historyMessage);
            showPsychiatristMessage(historyMessagePsych);
          }
        };
        historyList.appendChild(li);
      });
    }

    function togglePopup(popupId, show) {
      document.getElementById(popupId).style.display = show ? 'block' : 'none';
      document.getElementById('popupOverlay').style.display = show ? 'block' : 'none';
    }

    document.getElementById('loadUrl').addEventListener('click', loadUrl);
    document.getElementById('playPauseBtn').addEventListener('click', () => {
      if (player.getPlayerState() === YT.PlayerState.PLAYING) {
        player.pauseVideo();
        document.getElementById('playPauseBtn').textContent = 'Play ğŸ’ğŸŒ¸';
        const pauseMessage = getRandomPhrase(pausePhrases);
        const pauseMessagePsych = getRandomPhrase(pausePhrasesPsych);
        showRadioHostMessage(pauseMessage);
        showPsychiatristMessage(pauseMessagePsych);
      } else {
        player.playVideo();
        document.getElementById('playPauseBtn').textContent = 'Pause ğŸ’ğŸŒ¸';
        const playMessage = getRandomPhrase(playPhrases);
        const playMessagePsych = getRandomPhrase(playPhrasesPsych);
        showRadioHostMessage(playMessage);
        showPsychiatristMessage(playMessagePsych);
        userInitiatedPlayback = true;
      }
    });
    document.getElementById('prevBtn').addEventListener('click', playPrevious);
    document.getElementById('nextBtn').addEventListener('click', playNext);

    document.getElementById('loopBtn').addEventListener('click', () => {
      isLooping = !isLooping;
      const loopBtn = document.getElementById('loopBtn');
      loopBtn.classList.toggle('active');
      const loopMessage = getRandomPhrase(loopPhrases);
      const loopMessagePsych = getRandomPhrase(loopPhrasesPsych);
      showRadioHostMessage(loopMessage);
      showPsychiatristMessage(loopMessagePsych);
    });

    document.getElementById('shuffleBtn').addEventListener('click', () => {
      isShuffling = !isShuffling;
      const shuffleBtn = document.getElementById('shuffleBtn');
      shuffleBtn.classList.toggle('active');
      const shuffleMessage = getRandomPhrase(shufflePhrases);
      const shuffleMessagePsych = getRandomPhrase(shufflePhrasesPsych);
      showRadioHostMessage(shuffleMessage);
      showPsychiatristMessage(shuffleMessagePsych);
    });

    document.getElementById('profileBtn').addEventListener('click', () => {
      togglePopup('profilePopup', true);
    });
    document.getElementById('settingsBtn').addEventListener('click', () => {
      togglePopup('settingsPopup', true);
    });
    document.getElementById('pomodoroBtn').addEventListener('click', () => {
      togglePopup('pomodoroPopup', true);
      showRadioHostMessage(`â˜€ï¸ Productivity time, sunshine workers! DJ Sunny starts the Pomodoroâ€”work hard, shine harder! ğŸ’ğŸŒ¸`, true);
      showPsychiatristMessage(`ğŸ§  A Pomodoro timer, how proactive! Dr. Melody supports your focusâ€”letâ€™s balance productivity with the soothing power of music! ğŸ’ğŸŒ¸`, true);
    });
    document.getElementById('loginSignupBtn').addEventListener('click', () => {
      const token = localStorage.getItem('token');
      if (token) {
        localStorage.removeItem('token');
        updateAuthState(null);
      } else {
        togglePopup('authPopup', true);
      }
    });
    document.getElementById('closeAuth').addEventListener('click', () => togglePopup('authPopup', false));
    document.getElementById('closeProfile').addEventListener('click', () => togglePopup('profilePopup', false));
    document.getElementById('closeSettings').addEventListener('click', () => togglePopup('settingsPopup', false));
    document.getElementById('closePomodoro').addEventListener('click', () => togglePopup('pomodoroPopup', false));

    document.getElementById('toggleAuth').addEventListener('click', () => {
      isLoginMode = !isLoginMode;
      document.getElementById('authTitle').textContent = isLoginMode ? 'Login ğŸ’ğŸŒ¸' : 'Sign Up ğŸŒ¸ğŸ’';
      document.getElementById('toggleAuth').textContent = isLoginMode ? 'Switch to Sign Up ğŸ’ğŸŒ¸' : 'Switch to Login ğŸŒ¸ğŸ’';
      document.getElementById('submitAuth').textContent = isLoginMode ? 'Login ğŸ’ğŸŒ¸' : 'Sign Up ğŸŒ¸ğŸ’';
    });
    document.getElementById('submitAuth').addEventListener('click', () => {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      if (!email || !password) {
        alert('Please enter both email and password.');
        return;
      }
      if (isLoginMode) {
        login(email, password);
      } else {
        signup(email, password);
      }
    });

    document.getElementById('signOutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      updateAuthState(null);
      togglePopup('profilePopup', false);
      showRadioHostMessage(`â˜€ï¸ Farewell for now, sunshine VIP! DJ Sunny logs you outâ€”come back to the rays! ğŸ’ğŸŒ¸`, true);
      showPsychiatristMessage(`ğŸ§  Signing out, I see! Dr. Melody hopes this musical journey brought you joyâ€”until we meet again! ğŸ’ğŸŒ¸`, true);
    });

    let pomodoroInterval;
    let isWork = true;
    let timeLeft = 25 * 60;

    function updatePomodoroDisplay() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      document.getElementById('pomodoroTime').textContent = `${min}:${sec < 10 ? '0' : ''}${sec} ğŸ’ğŸŒ¸`;
    }

    document.getElementById('pomodoroStart').addEventListener('click', () => {
      if (!pomodoroInterval) {
        pomodoroInterval = setInterval(() => {
          timeLeft--;
          if (timeLeft <= 0) {
            isWork = !isWork;
            timeLeft = (isWork ? document.getElementById('pomodoroWork').value : document.getElementById('pomodoroBreak').value) * 60;
            showRadioHostMessage(`â˜€ï¸ Timeâ€™s up, productivity rays! DJ Sunny switches to ${isWork ? 'work' : 'break'}â€”keep shining! ğŸ’ğŸŒ¸`, true);
            showPsychiatristMessage(`ğŸ§  A shift in focus, how refreshing! Dr. Melody supports your transition to ${isWork ? 'work' : 'break'}â€”let the music guide your energy! ğŸ’ğŸŒ¸`, true);
          }
          updatePomodoroDisplay();
        }, 1000);
        document.getElementById('pomodoroStart').textContent = 'Pause ğŸ’ğŸŒ¸';
        showRadioHostMessage(`â˜€ï¸ Letâ€™s shine with focus, sunshine fans! DJ Sunny starts the Pomodoroâ€”25 minutes of brilliance! ğŸ’ğŸŒ¸`, true);
        showPsychiatristMessage(`ğŸ§  Starting the Pomodoro, how motivated! Dr. Melody is hereâ€”letâ€™s channel this focus into a harmonious balance with your tunes! ğŸ’ğŸŒ¸`, true);
      } else {
        clearInterval(pomodoroInterval);
        pomodoroInterval = null;
        document.getElementById('pomodoroStart').textContent = 'Start ğŸ’ğŸŒ¸';
        showRadioHostMessage(`â˜€ï¸ Taking a sunny break, folks! DJ Sunny pauses the Pomodoroâ€”rest those radiant minds! ğŸ’ğŸŒ¸`, true);
        showPsychiatristMessage(`ğŸ§  Pausing the timer, I see! Dr. Melody encourages this moment of restâ€”how does this break feel for you? ğŸ’ğŸŒ¸`, true);
      }
    });

    document.getElementById('pomodoroReset').addEventListener('click', () => {
      clearInterval(pomodoroInterval);
      pomodoroInterval = null;
      timeLeft = document.getElementById('pomodoroWork').value * 60;
      isWork = true;
      updatePomodoroDisplay();
      document.getElementById('pomodoroStart').textContent = 'Start ğŸ’ğŸŒ¸';
      showRadioHostMessage(`â˜€ï¸ Resetting the sunny clock, time travelers! DJ Sunny restarts the Pomodoroâ€”fresh rays, fresh beats! ğŸ’ğŸŒ¸`, true);
      showPsychiatristMessage(`ğŸ§  A reset, how grounding! Dr. Melody appreciates your fresh startâ€”letâ€™s align this new cycle with your musical flow! ğŸ’ğŸŒ¸`, true);
    });

    document.getElementById('muteAdToggle').addEventListener('change', () => {
      isAdMuted = document.getElementById('muteAdToggle').checked;
      if (isAdPlaying) {
        if (isAdMuted) {
          player.mute();
          adDetectionStats.truePositives++;
          showRadioHostMessage(`â˜€ï¸ Clearing the clouds, sunshine fans! DJ Sunny mutes those adsâ€”try dns.adguard.com for more! ğŸ’ğŸŒ¸`);
        } else {
          player.unMute();
          adDetectionStats.falsePositives++;
          showRadioHostMessage(`â˜€ï¸ Ads back on, music rays! DJ Sunny unmutesâ€”consider dns.adguard.com to block them! ğŸ’ğŸŒ¸`);
        }
      } else {
        showRadioHostMessage(`â˜€ï¸ Toggled the ad mute, savvy sunbeams! DJ Sunny sets it to ${isAdMuted ? 'on' : 'off'}â€”dns.adguard.com boosts it! ğŸ’ğŸŒ¸`);
      }
    });

    document.getElementById('hifiModeToggle').addEventListener('change', () => {
      isHifiMode = document.getElementById('hifiModeToggle').checked;
      showRadioHostMessage(`â˜€ï¸ Boosting the sunshine sound, audiophiles! DJ Sunny switches HiFi Mode to ${isHifiMode ? 'on' : 'off'}â€”crisp rays incoming! ğŸ’ğŸŒ¸`);
    });

    document.getElementById('aiVolume').addEventListener('input', () => {
      aiVolume = parseFloat(document.getElementById('aiVolume').value);
      showRadioHostMessage(`â˜€ï¸ Adjusting the sunny voice, sound wizards! DJ Sunny sets AI volume to ${Math.round(aiVolume * 100)}%â€”perfectly tuned! ğŸ’ğŸŒ¸`);
    });

    document.getElementById('bass').addEventListener('click', () => {
      const value = document.getElementById('bass').value;
      showRadioHostMessage(`â˜€ï¸ Thumping the sunny bass, beat rays! DJ Sunny adjusts it to ${value}â€”feel the low-end glow! ğŸ’ğŸŒ¸`);
    });
    document.getElementById('mid').addEventListener('click', () => {
      const value = document.getElementById('mid').value;
      showRadioHostMessage(`â˜€ï¸ Tuning the sunny mids, harmony beams! DJ Sunny sets it to ${value}â€”perfect balance achieved! ğŸ’ğŸŒ¸`);
    });
    document.getElementById('treble').addEventListener('click', () => {
      const value = document.getElementById('treble').value;
      showRadioHostMessage(`â˜€ï¸ Sizzling the sunny treble, high-note rays! DJ Sunny dials it to ${value}â€”crystal-clear sunshine! ğŸ’ğŸŒ¸`);
    });

    function setupBackgroundPlayback() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
            isBackgroundPlaying = true;
            if (!isAdPlaying) {
              player.mute();
            }
            startBackgroundAudio();
          }
        } else {
          if (isBackgroundPlaying) {
            isBackgroundPlaying = false;
            stopBackgroundAudio();
            if (!isAdPlaying) {
              player.unMute();
            }
          }
        }
      });
    }

    function startBackgroundAudio() {
      if (audioSource) audioSource.disconnect();
      const stream = player.getInternalPlayer().getAudioTracks()[0];
      if (stream) {
        audioSource = audioContext.createMediaStreamSource(new MediaStream([stream]));
        const gainNode = audioContext.createGain();
        gainNode.gain.value = 1.0;
        audioSource.connect(gainNode);
        gainNode.connect(audioContext.destination);
        audioContext.resume();
      }
    }

    function stopBackgroundAudio() {
      if (audioSource) {
        audioSource.disconnect();
        audioSource = null;
      }
      if (audioContext) {
        audioContext.suspend();
      }
    }
  </script>
</body>
</html>